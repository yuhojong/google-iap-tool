<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IAP 관리자</title>
    <style>
        :root {
            color-scheme: light dark;
            font-family: 'Noto Sans KR', sans-serif;
        }
        body {
            margin: 0;
            background: #f5f5f5;
            color: #222;
        }
        header {
            background: #1a73e8;
            color: #fff;
            padding: 1.5rem;
            text-align: center;
        }
        main {
            display: grid;
            gap: 2rem;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
        }
        h1, h2 {
            margin: 0 0 1rem;
        }
        .iap-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1rem;
        }
        .iap-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
            background: #fafafa;
        }
        .iap-card h3 {
            margin: 0 0 0.5rem;
            font-size: 1.1rem;
        }
        form {
            display: grid;
            gap: 1rem;
        }
        label,
        fieldset {
            display: grid;
            gap: 0.5rem;
            font-weight: 600;
        }
        fieldset {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
        }
        input, textarea {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        select {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        button {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            background: #1a73e8;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
        }
        button[disabled] {
            background: #999;
            cursor: not-allowed;
        }
        .status {
            margin-top: 1rem;
            font-weight: 600;
        }
        .pagination {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .empty {
            padding: 1rem;
            text-align: center;
            color: #666;
        }
        .translations {
            display: grid;
            gap: 1rem;
        }
        .translations h3 {
            margin: 0;
        }
        .translation-card {
            border: 1px dashed #c5d9ff;
            border-radius: 10px;
            padding: 1rem;
            display: grid;
            gap: 0.75rem;
            background: #f8fbff;
        }
        .translation-card h4 {
            margin: 0;
        }
        .hint {
            color: #555;
            font-weight: 400;
            margin: 0;
        }
        .template-info {
            display: grid;
            gap: 0.75rem;
            background: #eef3ff;
            border: 1px solid #c5d9ff;
            border-radius: 10px;
            padding: 1rem;
        }
        .template-details h3 {
            margin: 0 0 0.5rem;
        }
        .template-details ul {
            margin: 0;
            padding-left: 1.25rem;
        }
        .template-details li {
            line-height: 1.6;
        }
        @media (max-width: 600px) {
            main {
                padding: 1rem;
            }
            header {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Google Play IAP 관리자</h1>
    </header>
    <main>
        <section>
            <h2>등록된 상품</h2>
            <div id="iap-list" class="iap-list"></div>
            <div id="empty-state" class="empty" hidden>등록된 상품이 없습니다.</div>
            <div class="pagination">
                <button id="prev-btn" disabled>이전</button>
                <button id="next-btn" disabled>다음</button>
            </div>
        </section>
        <section>
            <h2>새 상품 만들기</h2>
            <form id="create-form">
                <label>상품 ID (SKU)
                    <input type="text" name="sku" required minlength="3" />
                </label>
                <label>기본 언어
                    <select name="default_language" required>
                        <option value="ko-KR" selected>한국어 (ko-KR)</option>
                        <option value="en-SG">영어 (en-SG)</option>
                        <option value="zh-TW">중국어 번체 (zh-TW)</option>
                    </select>
                </label>

                <div class="translations">
                    <h3>번역 정보</h3>
                    <p class="hint">언어별로 이름과 설명을 입력하세요. 기본 언어 항목은 필수입니다.</p>
                    <div class="translation-card" data-language="ko-KR">
                        <h4>한국어 (ko-KR)</h4>
                        <label>이름
                            <input type="text" name="title_ko-KR" minlength="1" />
                        </label>
                        <label>설명
                            <textarea name="description_ko-KR" rows="3"></textarea>
                        </label>
                    </div>
                    <div class="translation-card" data-language="en-SG">
                        <h4>영어 (en-SG)</h4>
                        <label>이름
                            <input type="text" name="title_en-SG" minlength="1" />
                        </label>
                        <label>설명
                            <textarea name="description_en-SG" rows="3"></textarea>
                        </label>
                    </div>
                    <div class="translation-card" data-language="zh-TW">
                        <h4>중국어 번체 (zh-TW)</h4>
                        <label>이름
                            <input type="text" name="title_zh-TW" minlength="1" />
                        </label>
                        <label>설명
                            <textarea name="description_zh-TW" rows="3"></textarea>
                        </label>
                    </div>
                </div>

                <label>가격 템플릿
                    <select name="price_template_id" id="price-template-select" required>
                        <option value="">가격 템플릿을 선택하세요</option>
                    </select>
                </label>
                <div class="template-info" id="template-info">
                    <p id="template-description" class="hint">가격 템플릿을 선택하면 지역별 가격이 표시됩니다.</p>
                    <div id="template-details" class="template-details" hidden>
                        <h3>지역별 가격</h3>
                        <ul id="template-region-list"></ul>
                    </div>
                </div>

                <button type="submit">상품 생성</button>
                <div id="form-status" class="status"></div>
            </form>
        </section>
    </main>
    <script>
        const listEl = document.getElementById('iap-list');
        const emptyEl = document.getElementById('empty-state');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const form = document.getElementById('create-form');
        const statusEl = document.getElementById('form-status');
        const submitBtn = form.querySelector('button[type="submit"]');
        const translationLanguages = ['ko-KR', 'en-SG', 'zh-TW'];
        const templateSelect = document.getElementById('price-template-select');
        const templateDescription = document.getElementById('template-description');
        const templateDetails = document.getElementById('template-details');
        const templateRegionList = document.getElementById('template-region-list');
        const templateMap = new Map();

        const tokenStack = [];
        let currentToken = undefined;
        let nextToken = undefined;

        function renderTemplateDetails(template, message) {
            if (message) {
                templateDescription.textContent = message;
            } else if (template) {
                const defaultInfo = `${template.default_price} ${template.default_currency}`.trim();
                templateDescription.textContent = template.description || `기본 가격: ${defaultInfo}`;
            } else {
                templateDescription.textContent = '가격 템플릿을 선택하면 지역별 가격이 표시됩니다.';
            }

            if (template && Array.isArray(template.regions) && template.regions.length) {
                templateDetails.hidden = false;
                templateRegionList.innerHTML = '';
                template.regions.forEach((region) => {
                    const li = document.createElement('li');
                    let priceText = region.price ? `${region.price} ${region.currency}` : '';
                    if (!priceText && region.priceMicros) {
                        const amount = Number(region.priceMicros) / 1_000_000;
                        priceText = `${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 6 })} ${region.currency || ''}`.trim();
                    }
                    li.textContent = `${region.region}: ${priceText}`.trim();
                    templateRegionList.appendChild(li);
                });
            } else {
                templateDetails.hidden = true;
                templateRegionList.innerHTML = '';
            }
        }

        async function fetchTemplates() {
            submitBtn.disabled = true;
            try {
                const res = await fetch('/api/pricing/templates');
                if (!res.ok) {
                    throw new Error('가격 템플릿을 불러오지 못했습니다.');
                }
                const data = await res.json();
                const templates = data.templates || [];
                templateMap.clear();
                templateSelect.innerHTML = '<option value="">가격 템플릿을 선택하세요</option>';
                if (!templates.length) {
                    templateSelect.innerHTML = '<option value="">등록된 템플릿이 없습니다</option>';
                    templateSelect.disabled = true;
                    submitBtn.disabled = true;
                    renderTemplateDetails(null, '등록된 가격 템플릿이 없습니다. 환경 변수를 확인해주세요.');
                    return;
                }
                templates.forEach((tpl) => {
                    templateMap.set(tpl.id, tpl);
                    const option = document.createElement('option');
                    option.value = tpl.id;
                    option.textContent = tpl.label;
                    templateSelect.appendChild(option);
                });
                templateSelect.disabled = false;
                submitBtn.disabled = false;
                renderTemplateDetails(null);
            } catch (error) {
                templateSelect.innerHTML = '<option value="">템플릿 로딩 실패</option>';
                templateSelect.disabled = true;
                submitBtn.disabled = true;
                renderTemplateDetails(null, error.message);
            }
        }

        async function fetchList(token) {
            try {
                const params = token ? `?token=${encodeURIComponent(token)}` : '';
                const res = await fetch(`/api/inapp/list${params}`);
                if (!res.ok) {
                    throw new Error('목록을 불러오지 못했습니다.');
                }
                const data = await res.json();
                renderList(data.items || []);
                nextToken = data.nextPageToken || undefined;
                nextBtn.disabled = !nextToken;
                prevBtn.disabled = tokenStack.length === 0;
            } catch (error) {
                listEl.innerHTML = '';
                emptyEl.hidden = false;
                emptyEl.textContent = error.message;
                nextBtn.disabled = true;
                prevBtn.disabled = tokenStack.length === 0;
            }
        }

        function renderList(items) {
            listEl.innerHTML = '';
            if (!items.length) {
                emptyEl.hidden = false;
                emptyEl.textContent = '등록된 상품이 없습니다.';
                return;
            }
            emptyEl.hidden = true;
            items.forEach((item) => {
                const card = document.createElement('article');
                card.className = 'iap-card';
                let priceText = 'N/A';
                if (item.defaultPrice?.priceMicros) {
                    const amount = Number(item.defaultPrice.priceMicros) / 1_000_000;
                    const formatted = amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 6 });
                    const currencyCode = item.defaultPrice.currency || '';
                    priceText = `${formatted} ${currencyCode}`.trim();
                }
                const defaultListing = (item.listings && item.defaultLanguage && item.listings[item.defaultLanguage])
                    || (item.listings ? Object.values(item.listings)[0] : undefined);
                const title = defaultListing?.title || item.sku;
                const description = defaultListing?.description || '-';
                card.innerHTML = `
                    <h3>${title}</h3>
                    <p><strong>SKU:</strong> ${item.sku}</p>
                    <p><strong>설명:</strong> ${description}</p>
                    <p><strong>가격:</strong> ${priceText}</p>
                    <p><strong>상태:</strong> ${item.status || '-'}</p>
                `;
                listEl.appendChild(card);
            });
        }

        nextBtn.addEventListener('click', () => {
            if (!nextToken) return;
            tokenStack.push(currentToken || null);
            currentToken = nextToken;
            fetchList(currentToken);
        });

        prevBtn.addEventListener('click', () => {
            if (!tokenStack.length) return;
            const prev = tokenStack.pop();
            currentToken = prev || undefined;
            fetchList(currentToken);
        });

        templateSelect.addEventListener('change', () => {
            const template = templateMap.get(templateSelect.value);
            renderTemplateDetails(template);
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(form);
            statusEl.textContent = '';
            const sku = (formData.get('sku') || '').trim();
            const defaultLanguage = formData.get('default_language');
            const selectedTemplateId = (formData.get('price_template_id') || '').trim();

            if (!sku) {
                statusEl.textContent = '상품 ID를 입력해주세요.';
                return;
            }

            const translations = [];
            for (const language of translationLanguages) {
                const title = (formData.get(`title_${language}`) || '').trim();
                const description = (formData.get(`description_${language}`) || '').trim();
                if (!title && !description) {
                    continue;
                }
                if (!title || !description) {
                    statusEl.textContent = `${language} 번역은 이름과 설명을 모두 입력해야 합니다.`;
                    return;
                }
                translations.push({ language, title, description });
            }

            if (!translations.some((item) => item.language === defaultLanguage)) {
                statusEl.textContent = '기본 언어와 일치하는 번역을 입력해주세요.';
                return;
            }

            const payload = {
                sku,
                default_language: defaultLanguage,
                translations,
            };

            if (!selectedTemplateId) {
                statusEl.textContent = '가격 템플릿을 선택해주세요.';
                return;
            }
            if (!templateMap.has(selectedTemplateId)) {
                statusEl.textContent = '선택한 가격 템플릿 정보를 찾을 수 없습니다.';
                return;
            }
            payload.price_template_id = selectedTemplateId;

            statusEl.textContent = '상품을 생성 중입니다...';
            try {
                const res = await fetch('/api/inapp/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    let message = err.detail;
                    if (Array.isArray(message)) {
                        message = message.map((item) => item.msg || item.detail).filter(Boolean).join(', ');
                    }
                    throw new Error(message || '생성에 실패했습니다.');
                }
                statusEl.textContent = '상품이 성공적으로 생성되었습니다.';
                form.reset();
                templateSelect.value = '';
                renderTemplateDetails(null);
                tokenStack.length = 0;
                currentToken = undefined;
                fetchList();
            } catch (error) {
                statusEl.textContent = error.message;
            }
        });

        renderTemplateDetails(null);
        fetchTemplates();
        fetchList();
    </script>
</body>
</html>
