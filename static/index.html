<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IAP Management Tool</title>
    <style>
        :root {
            color-scheme: light dark;
            font-family: 'Noto Sans KR', sans-serif;
        }
        body {
            margin: 0;
            background: #f5f5f5;
            color: #222;
        }
        header {
            background: linear-gradient(135deg, #1a73e8, #4fc3f7);
            color: #fff;
            padding: 1.5rem 1rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 1rem;
        }
        header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
        }
        .store-toggle {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .store-toggle button {
            padding: 0.5rem 1.1rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.18);
            color: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }
        .store-toggle button.is-active {
            background: #fff;
            color: #1a73e8;
            box-shadow: 0 8px 20px rgba(26, 115, 232, 0.24);
        }
        .store-toggle button:hover {
            background: rgba(255, 255, 255, 0.28);
        }
        nav.menu {
            display: none;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }
        nav.menu.is-active {
            display: flex;
        }
        nav.menu button {
            padding: 0.65rem 1.25rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.15);
            color: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, box-shadow 0.2s ease;
        }
        nav.menu button:hover {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
        }
        nav.menu button.is-active {
            background: #fff;
            color: #1a73e8;
            box-shadow: 0 10px 24px rgba(26, 115, 232, 0.24);
        }
        main {
            display: grid;
            gap: 2rem;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .store-pane[hidden] {
            display: none;
        }
        .app-section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            display: grid;
            gap: 1.5rem;
        }
        .app-section[hidden] {
            display: none;
        }
        h2 {
            margin: 0;
            font-size: 1.6rem;
        }
        .hint {
            color: #555;
            font-weight: 400;
            margin: 0;
            line-height: 1.6;
        }
        .csv-actions {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
        }
        .bulk-delete-panel {
            margin-top: 2rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }
        .bulk-delete-panel h3 {
            margin-bottom: 0.75rem;
        }
        .bulk-delete-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .bulk-delete-form label {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .bulk-delete-form textarea {
            resize: vertical;
        }
        .bulk-delete-form .form-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .csv-actions form {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.75rem;
        }
        .csv-actions input[type="file"] {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 0.5rem;
            background: #fff;
        }
        .template-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(26, 115, 232, 0.08);
            border-radius: 999px;
            padding: 0.35rem 0.75rem;
        }
        .template-controls label {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .template-controls select {
            border: none;
            background: transparent;
            font-size: 0.9rem;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
        }
        .form-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
        .checkbox-group {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .localization-grid {
            display: grid;
            gap: 1rem;
        }
        .localization-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
            display: grid;
            gap: 0.75rem;
            background: #fafafa;
        }
        .localization-card header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .localization-card header h4 {
            margin: 0;
            font-size: 1rem;
        }
        .localization-card .actions {
            display: flex;
            gap: 0.5rem;
        }
        .status {
            margin-top: 0.5rem;
            font-weight: 600;
        }
        .initial-loading {
            display: grid;
            gap: 0.75rem;
            background: #fff;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.06);
        }
        .initial-loading p {
            margin: 0;
            font-weight: 500;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 999px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #1a73e8, #4fc3f7);
            transition: width 0.3s ease;
        }
        .preview-group {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
            background: #fafafa;
        }
        .preview-group h3 {
            margin: 0 0 0.5rem;
        }
        .operation-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 0.5rem;
        }
        .operation-create,
        .operation-update,
        .operation-delete {
            border-radius: 8px;
            padding: 0.75rem;
        }
        .operation-create {
            border-left: 4px solid #0f9d58;
            background: #f0fff4;
        }
        .operation-update {
            border-left: 4px solid #fbbc04;
            background: #fff8e1;
        }
        .operation-delete {
            border-left: 4px solid #d93025;
            background: #ffebee;
        }
        .operation-header {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .operation-details {
            margin: 0.25rem 0 0;
            padding-left: 1rem;
        }
        .operation-details ul {
            margin: 0.25rem 0 0;
            padding-left: 1.25rem;
        }
        .operation-details li {
            line-height: 1.4;
        }
        .translation-change-details {
            margin: 0.25rem 0 0.5rem 1rem;
            padding-left: 1.25rem;
        }
        .translation-change-details li {
            white-space: pre-wrap;
        }
        .table-wrapper {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th,
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
            vertical-align: top;
        }
        thead th {
            background: #eef3ff;
            font-weight: 700;
            color: #1a237e;
        }
        tbody tr:hover {
            background: #f8fbff;
        }
        .description-cell {
            max-width: 320px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .table-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .table-actions button {
            flex: 0 0 auto;
        }
        .table-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        .table-controls-actions {
            margin-left: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        .search-input {
            min-width: 220px;
            padding: 0.65rem 1rem;
            border-radius: 999px;
            border: 1px solid #c5d9ff;
            background: #f8fbff;
            font-size: 0.95rem;
        }
        .page-size-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        .page-size-control select {
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 0.95rem;
        }
        .pagination {
            display: flex;
            gap: 0.5rem;
        }
        .empty {
            padding: 1rem;
            text-align: center;
            color: #666;
        }
        .translations {
            display: grid;
            gap: 1rem;
        }
        .translations h3 {
            margin: 0;
        }
        .translation-card {
            border: 1px dashed #c5d9ff;
            border-radius: 10px;
            padding: 1rem;
            display: grid;
            gap: 0.75rem;
            background: #f8fbff;
        }
        .translation-card h4 {
            margin: 0;
        }
        label,
        fieldset {
            display: grid;
            gap: 0.5rem;
            font-weight: 600;
        }
        fieldset {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
        }
        input,
        textarea {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        select {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        button {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            background: #1a73e8;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
        }
        button[disabled] {
            background: #999;
            cursor: not-allowed;
        }
        button.button-secondary {
            background: #5f6368;
        }
        button.button-danger {
            background: #d93025;
        }
        th.index-column {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        th.index-column::after {
            content: '▲';
            position: absolute;
            right: 0.75rem;
            font-size: 0.8rem;
            color: #1a237e;
            opacity: 0.6;
        }
        th.index-column[data-direction='desc']::after {
            content: '▼';
        }
        dialog {
            border: none;
            border-radius: 16px;
            padding: 0;
            max-width: 640px;
            width: min(640px, 92vw);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.4);
        }
        dialog form {
            display: grid;
            gap: 1rem;
            padding: 1.5rem;
        }
        .dialog-header {
            margin: 0;
        }
        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .dialog-hint {
            margin: 0;
            color: #555;
            font-weight: 400;
        }
        @media (max-width: 900px) {
            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .table-controls-actions {
                margin-left: 0;
                justify-content: space-between;
            }
        }
        @media (max-width: 600px) {
            main {
                padding: 1rem;
            }
            header {
                padding: 1rem;
            }
            nav.menu {
                justify-content: flex-start;
            }
            .app-section {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-inner">
            <h1>IAP Management Tool</h1>
            <div class="store-toggle" role="tablist" aria-label="스토어 선택">
                <button type="button" class="store-toggle-btn is-active" data-store="google" aria-selected="true">Google Play</button>
                <button type="button" class="store-toggle-btn" data-store="apple" aria-selected="false">Apple App Store</button>
            </div>
            <nav class="menu" data-store="google" aria-label="Google Play 메뉴" hidden>
                <button type="button" class="menu-button is-active" data-target="section-bulk-management">IAP 벌크 관리</button>
                <button type="button" class="menu-button" data-target="section-bulk-create">신규 IAP 벌크 등록</button>
                <button type="button" class="menu-button" data-target="section-single-create">신규 IAP 등록</button>
                <button type="button" class="menu-button" data-target="section-product-management">등록된 상품 관리</button>
            </nav>
            <nav class="menu" data-store="apple" aria-label="Apple App Store 메뉴">
                <button type="button" class="menu-button is-active" data-target="apple-section-product-list">인앱 상품 목록</button>
                <button type="button" class="menu-button" data-target="apple-section-bulk-management">IAP 벌크 관리</button>
                <button type="button" class="menu-button" data-target="apple-section-form">인앱 상품 등록/수정</button>
                <button type="button" class="menu-button" data-target="apple-section-cleanup">IAP 정리</button>
            </nav>
        </div>
    </header>
    <main>
        <section id="initial-welcome-screen" class="app-section" style="text-align: center; padding: 4rem 2rem;">
            <h2 style="font-size: 2.5rem; margin-bottom: 1rem; color: #1a73e8;">IAP Management Tool</h2>
            <p style="font-size: 1.2rem; color: #666; margin-bottom: 3rem;">관리할 스토어를 선택하세요</p>
            <div style="display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap;">
                <button type="button" class="store-select-btn" data-store="google" style="padding: 2rem 4rem; font-size: 1.5rem; border-radius: 12px; border: 2px solid #1a73e8; background: #fff; color: #1a73e8; cursor: pointer; transition: all 0.3s ease; min-width: 250px;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem;">Google Play</div>
                    <div style="font-size: 1rem; opacity: 0.8;">Google Play IAP 관리</div>
                </button>
                <button type="button" class="store-select-btn" data-store="apple" style="padding: 2rem 4rem; font-size: 1.5rem; border-radius: 12px; border: 2px solid #1a73e8; background: #fff; color: #1a73e8; cursor: pointer; transition: all 0.3s ease; min-width: 250px;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem;">Apple App Store</div>
                    <div style="font-size: 1rem; opacity: 0.8;">App Store IAP 관리</div>
                </button>
            </div>
        </section>
        <section class="store-pane" data-store="google" hidden>
        <section id="section-bulk-management" class="app-section">
            <div>
                <h2>IAP 벌크 관리</h2>
                <p class="hint">현재 등록된 상품 전체를 CSV로 내보내거나 수정·삭제·생성을 일괄 적용할 수 있습니다.</p>
            </div>
            <div class="csv-actions">
                <button id="export-btn" type="button">CSV 내보내기</button>
                <form id="import-form">
                    <input type="file" id="import-file" name="file" accept=".csv" />
                    <button type="button" id="import-preview-btn">미리보기</button>
                    <button type="button" id="import-apply-btn" disabled>적용</button>
                </form>
            </div>
            <div id="import-status" class="status"></div>
            <div id="import-progress" class="initial-loading" hidden>
                <p id="import-progress-text" class="hint"></p>
                <div class="progress-bar">
                    <div id="import-progress-bar" class="progress-bar-fill"></div>
                </div>
            </div>
            <div id="import-preview"></div>
        </section>
        <section id="section-bulk-create" class="app-section" hidden>
            <div>
                <h2>신규 IAP 벌크 등록</h2>
                <p class="hint">빈 템플릿을 다운로드해 신규 상품 정보를 입력한 뒤 업로드하면, 추가될 항목을 미리 확인하고 적용할 수 있습니다. 이미 등록된 상품 수정이나 삭제는 이 메뉴에서 제공하지 않습니다.</p>
            </div>
            <div class="csv-actions">
                <div class="template-controls">
                    <label for="new-template-count">템플릿 행 수</label>
                    <select id="new-template-count">
                        <option value="20">20</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button id="new-template-btn" type="button">빈 CSV 템플릿 다운로드</button>
                <form id="new-import-form">
                    <input type="file" id="new-import-file" name="file" accept=".csv" />
                    <button type="button" id="new-import-preview-btn">미리보기</button>
                    <button type="button" id="new-import-apply-btn" disabled>적용</button>
                </form>
            </div>
            <div id="new-import-status" class="status"></div>
            <div id="new-import-progress" class="initial-loading" hidden>
                <p id="new-import-progress-text" class="hint"></p>
                <div class="progress-bar">
                    <div id="new-import-progress-bar" class="progress-bar-fill"></div>
                </div>
            </div>
            <div id="new-import-preview"></div>
        </section>
        <section id="section-single-create" class="app-section" hidden>
            <div>
                <h2>신규 IAP 등록</h2>
                <p class="hint">단일 상품을 생성하려면 아래 정보를 입력하고 제출하세요.</p>
            </div>
            <form id="create-form">
                <label>상품 ID (SKU)
                    <input type="text" name="sku" required minlength="3" />
                </label>
                <label>기본 언어
                    <select name="default_language" required>
                        <option value="ko-KR" selected>한국어 (ko-KR)</option>
                        <option value="en-SG">영어 (en-SG)</option>
                        <option value="zh-TW">중국어 번체 (zh-TW)</option>
                    </select>
                </label>
                <div class="translations">
                    <h3>번역 정보</h3>
                    <p class="hint">언어별로 이름과 설명을 입력하세요. 기본 언어 항목은 필수입니다.</p>
                    <div class="translation-card" data-language="ko-KR">
                        <h4>한국어 (ko-KR)</h4>
                        <label>이름
                            <input type="text" name="title_ko-KR" minlength="1" />
                        </label>
                        <label>설명
                            <textarea name="description_ko-KR" rows="3"></textarea>
                        </label>
                    </div>
                    <div class="translation-card" data-language="en-SG">
                        <h4>영어 (en-SG)</h4>
                        <label>이름
                            <input type="text" name="title_en-SG" minlength="1" />
                        </label>
                        <label>설명
                            <textarea name="description_en-SG" rows="3"></textarea>
                        </label>
                    </div>
                    <div class="translation-card" data-language="zh-TW">
                        <h4>중국어 번체 (zh-TW)</h4>
                        <label>이름
                            <input type="text" name="title_zh-TW" minlength="1" />
                        </label>
                        <label>설명
                            <textarea name="description_zh-TW" rows="3"></textarea>
                        </label>
                    </div>
                </div>
                <label>가격 템플릿
                    <select name="price_template_id" id="price-template-select" required>
                        <option value="">가격 템플릿을 선택하세요</option>
                    </select>
                </label>
                <div class="template-info" id="template-info">
                    <p id="template-description" class="hint">가격 템플릿을 선택하면 지역별 가격이 표시됩니다.</p>
                    <div id="template-details" class="template-details" hidden>
                        <h3>지역별 가격</h3>
                        <ul id="template-region-list"></ul>
                    </div>
                </div>
                <button type="submit">상품 생성</button>
                <div id="form-status" class="status"></div>
            </form>
        </section>
        <section id="section-product-management" class="app-section" hidden>
            <div>
                <h2>등록된 상품 관리</h2>
                <p class="hint">SKU, 이름, 설명으로 검색하고 인덱스 열을 더블클릭해 순서를 오름차순·내림차순으로 전환할 수 있습니다.</p>
            </div>
            <div id="initial-progress" class="initial-loading" hidden>
                <p id="initial-progress-text" class="hint">데이터를 불러오는 중...</p>
                <div class="progress-bar">
                    <div id="initial-progress-bar" class="progress-bar-fill"></div>
                </div>
            </div>
            <div class="table-controls">
                <input type="search" id="iap-search-input" class="search-input" placeholder="SKU, 이름 또는 설명 검색" aria-label="상품 검색" />
                <div class="table-controls-actions">
                    <label class="page-size-control" for="page-size-select">
                        페이지당 표시
                        <select id="page-size-select">
                            <option value="20">20개</option>
                            <option value="50" selected>50개</option>
                            <option value="100">100개</option>
                        </select>
                    </label>
                    <div class="pagination">
                        <button id="prev-btn" type="button" disabled>이전</button>
                        <button id="next-btn" type="button" disabled>다음</button>
                    </div>
                </div>
            </div>
            <div id="iap-table-wrapper" class="table-wrapper" hidden>
                <table class="iap-table">
                    <thead>
                        <tr>
                            <th scope="col" id="iap-index-header" class="index-column" tabindex="0" data-direction="asc">인덱스</th>
                            <th scope="col">SKU</th>
                            <th scope="col">이름</th>
                            <th scope="col">설명</th>
                            <th scope="col">기본 언어</th>
                            <th scope="col">가격</th>
                            <th scope="col">상태</th>
                            <th scope="col">작업</th>
                        </tr>
                    </thead>
                    <tbody id="iap-table-body"></tbody>
                </table>
            </div>
            <div id="empty-state" class="empty" hidden>등록된 상품이 없습니다.</div>
        </section>
        <dialog id="edit-dialog">
            <form id="edit-form">
                <h3 class="dialog-header">상품 수정</h3>
                <label>상품 ID (SKU)
                    <input type="text" id="edit-sku" name="sku" readonly />
                </label>
                <label>기본 언어
                    <select id="edit-default-language" name="default_language" required></select>
                </label>
                <label>상태
                    <select id="edit-status-select" name="status" required></select>
                </label>
                <fieldset>
                    <legend>기본 가격</legend>
                    <label>priceMicros
                        <input type="text" id="edit-price-micros" name="price_micros" required />
                    </label>
                    <label>통화 코드
                        <input type="text" id="edit-price-currency" name="currency" maxlength="3" required />
                    </label>
                    <p class="hint dialog-hint">Google Play Console 형식과 동일한 마이크로 단위(priceMicros)를 입력하세요.</p>
                </fieldset>
                <div class="translations" id="edit-translations"></div>
                <div class="dialog-actions">
                    <button type="button" id="edit-cancel-btn" class="button-secondary">취소</button>
                    <button type="submit">저장</button>
                </div>
                <div id="edit-status-message" class="status"></div>
            </form>
        </dialog>
        </section>
        <section class="store-pane" data-store="apple" hidden>
            <section id="apple-section-product-list" class="app-section">
                <div>
                    <h2>Apple App Store 인앱상품 목록</h2>
                    <p class="hint">App Store Connect API를 통해 상품 목록과 가격을 빠르게 확인하고, 선택한 상품의 상세 정보를 불러와 수정·삭제할 수 있습니다. 여러 상품을 한 번에 삭제하려면 아래 벌크 삭제 도구를 사용하세요.</p>
                </div>
                <div class="csv-actions">
                    <button type="button" id="apple-refresh-btn">목록 새로고침</button>
                    <button type="button" id="apple-fix-btn">Fix</button>
                </div>
                <div id="apple-status" class="status"></div>
                <div class="initial-loading" id="apple-loading" hidden style="position: relative; z-index: 10; background: white; padding: 10px; margin-bottom: 10px;">
                    <p class="hint">Apple 인앱 상품을 불러오는 중입니다...</p>
                    <div class="progress-bar"><div class="progress-bar-fill" id="apple-loading-bar"></div></div>
                </div>
                <div class="table-wrapper" id="apple-table-wrapper" hidden>
                    <table class="iap-table">
                        <thead>
                            <tr>
                                <th scope="col">상품 ID</th>
                                <th scope="col">타입</th>
                                <th scope="col">상태</th>
                                <th scope="col">가격</th>
                                <th scope="col">작업</th>
                            </tr>
                        </thead>
                        <tbody id="apple-table-body"></tbody>
                    </table>
                </div>
                <div id="apple-empty-state" class="empty" hidden>등록된 Apple 인앱 상품이 없습니다.</div>
                <section class="bulk-delete-panel">
                    <h3>인앱 상품 벌크 삭제</h3>
                    <p class="hint">삭제하려는 상품의 이름, SKU, IAP ID 또는 Product ID를 한 줄에 하나씩 입력한 뒤 삭제 대상을 미리 확인하세요.</p>
                    <div class="bulk-delete-form">
                        <label>
                            식별자 유형
                            <select id="apple-bulk-delete-type">
                                <option value="product_id" selected>Product ID / SKU</option>
                                <option value="reference_name">참조 이름</option>
                                <option value="iap_id">IAP ID</option>
                                <option value="sku">SKU (동일)</option>
                            </select>
                        </label>
                        <label>
                            삭제할 값 목록
                            <textarea id="apple-bulk-delete-input" rows="5" placeholder="각 줄에 하나씩 입력하세요."></textarea>
                        </label>
                        <div class="form-actions">
                            <button type="button" id="apple-bulk-delete-preview-btn">삭제 대상 미리보기</button>
                            <button type="button" id="apple-bulk-delete-apply-btn" disabled>선택 항목 삭제</button>
                        </div>
                        <div id="apple-bulk-delete-status" class="status"></div>
                    </div>
                    <div id="apple-bulk-delete-results"></div>
                </section>
            </section>
            <section id="apple-section-bulk-management" class="app-section" hidden>
                <div>
                    <h2>Apple IAP 벌크 등록</h2>
                    <p class="hint">신규 IAP를 CSV 파일을 통해 일괄 등록할 수 있습니다. 샘플 CSV를 다운로드하여 형식을 확인한 후 작성하세요.</p>
                </div>
                <div class="csv-actions">
                    <button id="apple-sample-download-btn" type="button">샘플 CSV 다운로드</button>
                    <form id="apple-import-form">
                        <input type="file" id="apple-import-file" name="file" accept=".csv" />
                        <button type="button" id="apple-import-preview-btn">미리보기</button>
                        <button type="button" id="apple-import-apply-btn" disabled>등록</button>
                    </form>
                </div>
                <div id="apple-import-status" class="status"></div>
                <div id="apple-import-progress" class="initial-loading" hidden>
                    <p id="apple-import-progress-text" class="hint"></p>
                    <div class="progress-bar">
                        <div id="apple-import-progress-bar" class="progress-bar-fill"></div>
                    </div>
                </div>
                <div id="apple-import-preview"></div>
            </section>
            <section id="apple-section-form" class="app-section" hidden>
                <div>
                    <h2>Apple 인앱 상품 등록/수정</h2>
                    <p class="hint">필수 정보와 현지화 정보를 입력한 뒤 저장하면 새로운 인앱 상품을 생성하거나 기존 상품을 업데이트합니다.</p>
                </div>
                <form id="apple-form">
                    <div class="form-grid">
                        <label>
                            상품 ID (productId)
                            <input type="text" id="apple-product-id" name="product_id" required />
                        </label>
                        <label>
                            참조 이름
                            <input type="text" id="apple-reference-name" name="reference_name" required />
                        </label>
                        <label>
                            인앱 상품 타입
                            <select id="apple-purchase-type" name="purchase_type" required>
                                <option value="consumable">소모성</option>
                                <option value="nonConsumable">비소모성</option>
                                <option value="nonRenewingSubscription">비갱신형 구독</option>
                                <option value="autoRenewableSubscription">자동 갱신형 구독</option>
                            </select>
                        </label>
                        <label>
                            가격 (Price Schedule - KRW)
                            <input
                                type="number"
                                id="apple-price-krw"
                                name="price_krw"
                                list="apple-price-krw-options"
                                placeholder="희망 KRW 가격을 입력하세요"
                                min="0"
                                step="1"
                                inputmode="numeric"
                            />
                            <datalist id="apple-price-krw-options"></datalist>
                            <p class="hint" id="apple-price-krw-hint" hidden></p>
                        </label>
                        <label>
                            기준 판매 지역
                            <input type="text" id="apple-base-territory" name="base_territory" value="KOR" maxlength="3" />
                        </label>
                    </div>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="apple-cleared-for-sale" checked /> 판매 가능</label>
                        <label><input type="checkbox" id="apple-family-sharable" /> 패밀리 공유 가능</label>
                    </div>
                    <label>
                        심사 메모
                        <textarea id="apple-review-note" rows="3" placeholder="필요한 경우 심사 메모를 입력하세요."></textarea>
                    </label>
                    <div>
                        <div class="form-header">
                            <h3>현지화 정보</h3>
                            <button type="button" id="apple-add-locale-btn" class="button-secondary">현지화 추가</button>
                        </div>
                        <div id="apple-localizations" class="localization-grid"></div>
                    </div>
                    <div class="form-actions">
                        <button type="reset" class="button-secondary" id="apple-reset-btn">초기화</button>
                        <button type="submit" id="apple-submit-btn">저장</button>
                    </div>
                    <div id="apple-form-status" class="status"></div>
                </form>
            </section>
            <section id="apple-section-cleanup" class="app-section" hidden>
                <div>
                    <h2>IAP 정리</h2>
                    <p class="hint">Google Play에는 없지만 App Store에만 존재하는 IAP 목록을 확인하고 처리할 수 있습니다. SKU 패턴이 일치하는 경우 같은 상품으로 취급됩니다 (예: aos_dg_1126_99와 ios_dg_1126_99).</p>
                    <p class="hint" style="margin-top: 0.5rem; color: #666;">
                        <strong>판매 중지:</strong> 고객의 신규 구매만 막습니다. 기존 구매자의 접근은 유지됩니다. 운영 중 IAP는 삭제 대신 판매 중지가 안전합니다.<br>
                        <strong>IAP 삭제:</strong> IAP 항목을 App Store Connect에서 완전히 제거합니다. 되돌릴 수 없고, 같은 productId는 재사용할 수 없습니다.
                    </p>
                </div>
                <div class="cleanup-subtabs" id="apple-cleanup-tabs" style="margin: 1rem 0; display: flex; gap: 0.5rem;">
                    <button type="button" class="menu-button is-active" data-apple-cleanup-tab="cleanup">판매 중지/삭제 대상</button>
                    <button type="button" class="menu-button" data-apple-cleanup-tab="protected">보호 목록</button>
                </div>
                <div id="apple-cleanup-view-cleanup">
                <div class="notice" id="apple-cleanup-google-only-container" hidden style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #f0c36d; background: #fff7e6; border-radius: 4px;">
                    <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="font-size: 1rem;">Google Play에만 존재하는 상품 (<span id="apple-cleanup-google-only-count">0</span>개)</strong>
                    </div>
                    <p class="hint" style="margin-bottom: 0.75rem;">아래 상품들은 Google Play에는 있지만 App Store에는 존재하지 않습니다. 필요한 경우 App Store에 등록해 주세요.</p>
                    <div class="table-wrapper" id="apple-cleanup-google-only-table-wrapper">
                        <table class="iap-table">
                            <thead>
                                <tr>
                                    <th scope="col">SKU</th>
                                    <th scope="col">상태</th>
                                    <th scope="col">기본 언어</th>
                                    <th scope="col">기본 제목</th>
                                </tr>
                            </thead>
                            <tbody id="apple-cleanup-google-only-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="table-controls" id="apple-cleanup-controls" style="margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                    <div class="table-summary">
                        <strong>전체:</strong> <span id="apple-cleanup-total">0</span>개 | <strong>선택:</strong> <span id="apple-cleanup-selected">0</span>개
                    </div>
                    <div class="table-controls-actions" style="display: flex; gap: 0.75rem; align-items: center;">
                        <label class="page-size-control" for="apple-cleanup-page-size">
                            페이지당 표시
                            <select id="apple-cleanup-page-size">
                                <option value="50">50개</option>
                                <option value="100">100개</option>
                                <option value="200">200개</option>
                                <option value="all">전체</option>
                            </select>
                        </label>
                        <div class="pagination">
                            <button type="button" id="apple-cleanup-prev-btn">이전</button>
                            <span id="apple-cleanup-page-info">1 / 1</span>
                            <button type="button" id="apple-cleanup-next-btn">다음</button>
                        </div>
                    </div>
                </div>
                <div class="table-wrapper" id="apple-cleanup-table-wrapper" hidden>
                    <table class="iap-table">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 40px;">
                                    <input type="checkbox" id="apple-cleanup-select-all" aria-label="전체 선택" />
                                </th>
                                <th scope="col" class="index-column" id="apple-cleanup-index-header" style="cursor: pointer;">인덱스</th>
                                <th scope="col">상품 ID</th>
                                <th scope="col">타입</th>
                                <th scope="col">상태</th>
                                <th scope="col">가격</th>
                            </tr>
                        </thead>
                        <tbody id="apple-cleanup-table-body"></tbody>
                    </table>
                </div>
                <div id="apple-cleanup-empty-state" class="empty" hidden>
                    Google Play에 없고 App Store에만 있는 IAP가 없습니다.
                </div>
                <div class="form-actions" style="margin-top: 1rem;" id="apple-cleanup-actions" hidden>
                    <button type="button" id="apple-cleanup-protect-btn" class="button-secondary" style="margin-right: 0.5rem;">보호</button>
                    <button type="button" id="apple-cleanup-remove-sale-btn" class="button-secondary" style="margin-right: 0.5rem;">판매 중지</button>
                    <button type="button" id="apple-cleanup-delete-btn" class="button-primary">IAP 삭제</button>
                </div>
                </div>
                <div id="apple-cleanup-view-protected" hidden>
                    <div class="table-controls" id="apple-protected-controls" style="margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                        <div class="table-summary">
                            <strong>보호 중:</strong> <span id="apple-protected-total">0</span>개 | <strong>선택:</strong> <span id="apple-protected-selected">0</span>개
                        </div>
                        <div class="table-controls-actions" style="display: flex; gap: 0.75rem; align-items: center;">
                            <label class="page-size-control" for="apple-protected-page-size">
                                페이지당 표시
                                <select id="apple-protected-page-size">
                                    <option value="50">50개</option>
                                    <option value="100">100개</option>
                                    <option value="200">200개</option>
                                    <option value="all">전체</option>
                                </select>
                            </label>
                            <div class="pagination">
                                <button type="button" id="apple-protected-prev-btn">이전</button>
                                <span id="apple-protected-page-info">1 / 1</span>
                                <button type="button" id="apple-protected-next-btn">다음</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-wrapper" id="apple-protected-table-wrapper" hidden>
                        <table class="iap-table">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 40px;">
                                        <input type="checkbox" id="apple-protected-select-all" aria-label="전체 선택" />
                                    </th>
                                    <th scope="col" class="index-column" id="apple-protected-index-header" style="cursor: pointer;">인덱스</th>
                                    <th scope="col">상품 ID</th>
                                    <th scope="col">타입</th>
                                    <th scope="col">상태</th>
                                    <th scope="col">가격</th>
                                </tr>
                            </thead>
                            <tbody id="apple-protected-table-body"></tbody>
                        </table>
                    </div>
                    <div id="apple-protected-empty-state" class="empty" hidden>
                        보호된 IAP가 없습니다.
                    </div>
                    <div class="form-actions" style="margin-top: 1rem;" id="apple-protected-actions" hidden>
                        <button type="button" id="apple-protected-unprotect-btn" class="button-secondary">보호 해제</button>
                    </div>
                </div>
                <div class="csv-actions">
                    <button type="button" id="apple-cleanup-refresh-btn">목록 새로고침</button>
                </div>
                <div id="apple-cleanup-status" class="status"></div>
            </section>
        </section>
    </main>
    <script>
        const storeToggleButtons = document.querySelectorAll('.store-toggle-btn');
        const storePanes = new Map();
        document.querySelectorAll('.store-pane').forEach((pane) => {
            const store = pane.dataset.store;
            if (store) {
                storePanes.set(store, pane);
            }
        });
        const storeConfigs = {
            google: {
                defaultSection: 'section-bulk-management',
                menu: document.querySelector('nav.menu[data-store="google"]'),
                pane: storePanes.get('google'),
                sections: new Map([
                    ['section-bulk-management', document.getElementById('section-bulk-management')],
                    ['section-bulk-create', document.getElementById('section-bulk-create')],
                    ['section-single-create', document.getElementById('section-single-create')],
                    ['section-product-management', document.getElementById('section-product-management')],
                ]),
            },
            apple: {
                defaultSection: 'apple-section-product-list',
                menu: document.querySelector('nav.menu[data-store="apple"]'),
                pane: storePanes.get('apple'),
                sections: new Map([
                    ['apple-section-product-list', document.getElementById('apple-section-product-list')],
                    ['apple-section-bulk-management', document.getElementById('apple-section-bulk-management')],
                    ['apple-section-form', document.getElementById('apple-section-form')],
                    ['apple-section-cleanup', document.getElementById('apple-section-cleanup')],
                ]),
            },
        };

        const activeSections = {};
        Object.entries(storeConfigs).forEach(([store, config]) => {
            activeSections[store] = config.defaultSection;
        });
        
        let activeStore = null; // 초기에는 스토어 미선택
        const initialWelcomeScreen = document.getElementById('initial-welcome-screen');
        const storeSelectButtons = document.querySelectorAll('.store-select-btn');
        
        // 초기 화면에서 스토어 선택 시
        storeSelectButtons.forEach((button) => {
            button.addEventListener('click', () => {
                const targetStore = button.dataset.store;
                if (targetStore && storeConfigs[targetStore]) {
                    if (initialWelcomeScreen) {
                        initialWelcomeScreen.hidden = true;
                    }
                    setActiveStore(targetStore);
                }
            });
        });
        
        // 초기에는 모든 스토어 pane과 메뉴 숨김
        Object.entries(storeConfigs).forEach(([key, config]) => {
            if (config.pane) {
                config.pane.hidden = true;
            }
            if (config.menu) {
                config.menu.hidden = true;
                config.menu.classList.remove('is-active');
            }
        });

        function setActiveSection(store, id) {
            const config = storeConfigs[store];
            if (!config || !config.sections.has(id)) {
                return;
            }
            activeSections[store] = id;
            config.sections.forEach((section, key) => {
                if (!section) return;
                section.hidden = key !== id;
            });
            if (config.menuButtons) {
                config.menuButtons.forEach((button) => {
                    const isActive = button.dataset.target === id;
                    button.classList.toggle('is-active', isActive);
                });
            }
        }

        function setActiveStore(store) {
            if (!store || !storeConfigs[store]) {
                return;
            }
            activeStore = store;
            document.body.dataset.store = store;
            
            // 초기 화면 숨김
            if (initialWelcomeScreen) {
                initialWelcomeScreen.hidden = true;
            }
            
            storeToggleButtons.forEach((button) => {
                const isActive = button.dataset.store === store;
                button.classList.toggle('is-active', isActive);
                button.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });
            Object.entries(storeConfigs).forEach(([key, config]) => {
                if (config.pane) {
                    config.pane.hidden = key !== store;
                }
                if (config.menu) {
                    config.menu.hidden = false;
                    config.menu.classList.toggle('is-active', key === store);
                }
            });
            setActiveSection(store, activeSections[store]);
            if (store === 'apple') {
                ensureAppleInitialized();
            }
        }

        Object.entries(storeConfigs).forEach(([store, config]) => {
            config.menuButtons = config.menu
                ? Array.from(config.menu.querySelectorAll('.menu-button'))
                : [];
            config.menuButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const target = button.dataset.target;
                    if (target) {
                        setActiveSection(store, target);
                    }
                });
            });
            setActiveSection(store, activeSections[store]);
        });

        const tableWrapper = document.getElementById('iap-table-wrapper');
        const listEl = document.getElementById('iap-table-body');
        const emptyEl = document.getElementById('empty-state');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const pageSizeSelect = document.getElementById('page-size-select');
        const searchInput = document.getElementById('iap-search-input');
        const indexHeader = document.getElementById('iap-index-header');
        const form = document.getElementById('create-form');
        const statusEl = document.getElementById('form-status');
        const submitBtn = form ? form.querySelector('button[type="submit"]') : null;
        const translationLanguages = ['ko-KR', 'en-SG', 'zh-TW'];
        const templateSelect = document.getElementById('price-template-select');
        const templateDescription = document.getElementById('template-description');
        const templateDetails = document.getElementById('template-details');
        const templateRegionList = document.getElementById('template-region-list');
        const templateMap = new Map();
        const exportBtn = document.getElementById('export-btn');
        const importForm = document.getElementById('import-form');
        const importFileInput = document.getElementById('import-file');
        const importPreviewBtn = document.getElementById('import-preview-btn');
        const importApplyBtn = document.getElementById('import-apply-btn');
        const importStatusEl = document.getElementById('import-status');
        const importPreviewEl = document.getElementById('import-preview');
        const importProgress = document.getElementById('import-progress');
        const importProgressText = document.getElementById('import-progress-text');
        const importProgressBar = document.getElementById('import-progress-bar');
        const newTemplateBtn = document.getElementById('new-template-btn');
        const newTemplateCountSelect = document.getElementById('new-template-count');
        const newImportForm = document.getElementById('new-import-form');
        const newImportFileInput = document.getElementById('new-import-file');
        const newImportPreviewBtn = document.getElementById('new-import-preview-btn');
        const newImportApplyBtn = document.getElementById('new-import-apply-btn');
        const newImportStatusEl = document.getElementById('new-import-status');
        const newImportPreviewEl = document.getElementById('new-import-preview');
        const newImportProgress = document.getElementById('new-import-progress');
        const newImportProgressText = document.getElementById('new-import-progress-text');
        const newImportProgressBar = document.getElementById('new-import-progress-bar');
        const editDialog = document.getElementById('edit-dialog');
        const editForm = document.getElementById('edit-form');
        const editSkuInput = document.getElementById('edit-sku');
        const editDefaultLanguageSelect = document.getElementById('edit-default-language');
        const editStatusSelect = document.getElementById('edit-status-select');
        const editPriceMicrosInput = document.getElementById('edit-price-micros');
        const editPriceCurrencyInput = document.getElementById('edit-price-currency');
        const editTranslationsContainer = document.getElementById('edit-translations');
        const editCancelBtn = document.getElementById('edit-cancel-btn');
        const editStatusMessage = document.getElementById('edit-status-message');
        const editSubmitBtn = editForm ? editForm.querySelector('button[type="submit"]') : null;
        const initialProgress = document.getElementById('initial-progress');
        const initialProgressText = document.getElementById('initial-progress-text');
        const initialProgressBar = document.getElementById('initial-progress-bar');

        const STATUS_OPTIONS = ['active', 'inactive', 'draft'];
        const STATUS_LABELS = {
            active: '활성',
            inactive: '비활성',
            draft: '초안',
        };
        const PRIORITY_REGIONS = [
            { code: 'US', currency: 'USD' },
            { code: 'HK', currency: 'HKD' },
            { code: 'SG', currency: 'SGD' },
            { code: 'TW', currency: 'TWD' },
        ];
        const PRIORITY_REGION_SET = new Set(PRIORITY_REGIONS.map((entry) => entry.code));
        const PRIORITY_REGION_LABELS = PRIORITY_REGIONS.reduce((map, entry) => {
            map[entry.code] = `${entry.code} (${entry.currency})`;
            return map;
        }, {});
        const OTHER_REGION_NOTICE = '기타 서비스되는 리전의 가격 정책도 변경되었습니다.';
        const MAX_PAGE_SIZE = 200;

        const tokenStack = [];
        let currentToken = undefined;
        let nextToken = undefined;
        let pendingOperations = [];
        let pendingNewOperations = [];
        let editingItem = null;
        let initialLoadingActive = false;
        let initialStepsCompleted = 0;
        let initialStepsTotal = 0;
        let pageSize = 50;
        let currentItems = [];
        let currentSearchTerm = '';
        let indexSortDirection = 'asc';
        let currentPageStartIndex = 0;

        function createProgressTracker(container, bar, text) {
            return {
                container,
                bar,
                text,
                timer: null,
                value: 10,
                direction: 1,
            };
        }

        const importProgressTracker = createProgressTracker(importProgress, importProgressBar, importProgressText);
        const newImportProgressTracker = createProgressTracker(newImportProgress, newImportProgressBar, newImportProgressText);

        if (pageSizeSelect) {
            const parsed = Number(pageSizeSelect.value);
            if (Number.isFinite(parsed) && parsed > 0) {
                const normalized = Math.min(Math.max(Math.floor(parsed), 1), MAX_PAGE_SIZE);
                pageSize = normalized;
                if (normalized !== parsed) {
                    pageSizeSelect.value = String(normalized);
                }
            }
        }

        if (importForm) {
            importForm.addEventListener('submit', (event) => event.preventDefault());
        }
        if (newImportForm) {
            newImportForm.addEventListener('submit', (event) => event.preventDefault());
        }

        function startInitialLoading(totalSteps) {
            initialLoadingActive = true;
            initialStepsTotal = totalSteps;
            initialStepsCompleted = 0;
            if (initialProgress) {
                initialProgress.hidden = false;
            }
            if (initialProgressBar) {
                initialProgressBar.style.width = '0%';
            }
            if (initialProgressText) {
                initialProgressText.textContent = '데이터를 불러오는 중...';
            }
        }

        function setInitialProgressMessage(message) {
            if (initialProgressText && message) {
                initialProgressText.textContent = message;
            }
        }

        function finishInitialStep({ success = true, message = '' } = {}) {
            if (!initialLoadingActive) {
                return;
            }
            if (!success) {
                if (message) {
                    setInitialProgressMessage(message);
                }
                if (initialProgressBar) {
                    initialProgressBar.style.width = '100%';
                }
                initialLoadingActive = false;
                return;
            }
            initialStepsCompleted += 1;
            const percent = Math.min(100, Math.round((initialStepsCompleted / initialStepsTotal) * 100));
            if (initialProgressBar) {
                initialProgressBar.style.width = `${percent}%`;
            }
            if (initialStepsCompleted >= initialStepsTotal) {
                if (initialProgressText) {
                    initialProgressText.textContent = '불러오기 완료';
                }
                setTimeout(() => {
                    if (initialProgress) {
                        initialProgress.hidden = true;
                    }
                    initialLoadingActive = false;
                }, 500);
            }
        }

        function startProgress(tracker, message = '') {
            if (!tracker) return;
            if (tracker.timer) {
                clearInterval(tracker.timer);
            }
            tracker.value = 10;
            tracker.direction = 1;
            if (tracker.container) {
                tracker.container.hidden = false;
            }
            if (tracker.text && message) {
                tracker.text.textContent = message;
            }
            if (tracker.bar) {
                tracker.bar.style.width = `${tracker.value}%`;
            }
            tracker.timer = window.setInterval(() => {
                if (!tracker.bar) {
                    return;
                }
                tracker.value += tracker.direction * 5;
                if (tracker.value >= 95) {
                    tracker.value = 95;
                    tracker.direction = -1;
                } else if (tracker.value <= 10) {
                    tracker.value = 10;
                    tracker.direction = 1;
                }
                tracker.bar.style.width = `${tracker.value}%`;
            }, 150);
        }

        function completeProgress(tracker, { message = '', isError = false } = {}) {
            if (!tracker) return;
            if (tracker.timer) {
                clearInterval(tracker.timer);
                tracker.timer = null;
            }
            if (tracker.bar) {
                tracker.bar.style.width = '100%';
            }
            if (tracker.text && message) {
                tracker.text.textContent = message;
            }
            const delay = isError ? 1000 : 500;
            if (tracker.container) {
                window.setTimeout(() => {
                    tracker.container.hidden = true;
                }, delay);
            }
        }

        function renderTemplateDetails(template, message) {
            if (!templateDescription || !templateDetails || !templateRegionList) {
                return;
            }
            if (message) {
                templateDescription.textContent = message;
            } else if (template) {
                const defaultInfo = `${template.default_price || ''} ${template.default_currency || ''}`.trim();
                templateDescription.textContent = template.description || (defaultInfo ? `기본 가격: ${defaultInfo}` : '가격 템플릿 상세');
            } else {
                templateDescription.textContent = '가격 템플릿을 선택하면 지역별 가격이 표시됩니다.';
            }

            if (template && Array.isArray(template.regions) && template.regions.length) {
                templateDetails.hidden = false;
                templateRegionList.innerHTML = '';
                template.regions.forEach((region) => {
                    const li = document.createElement('li');
                    let priceText = region.price ? `${region.price} ${region.currency || ''}`.trim() : '';
                    if (!priceText && region.priceMicros) {
                        const amount = Number(region.priceMicros) / 1_000_000;
                        priceText = `${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 6 })} ${region.currency || ''}`.trim();
                    }
                    li.textContent = `${region.region}: ${priceText}`.trim();
                    templateRegionList.appendChild(li);
                });
            } else {
                templateDetails.hidden = true;
                templateRegionList.innerHTML = '';
            }
        }
        function formatPriceDisplay(price) {
            if (!price || !price.priceMicros) {
                return '-';
            }
            const microsNumber = Number(price.priceMicros);
            if (Number.isNaN(microsNumber)) {
                const currency = price.currency ? ` ${price.currency}` : '';
                return `${price.priceMicros}${currency}`.trim();
            }
            const amount = microsNumber / 1_000_000;
            const formatted = amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 6 });
            const currency = price.currency ? ` ${price.currency}` : '';
            return `${formatted}${currency}`.trim();
        }

        function buildRegionalPriceList(prices) {
            if (!prices) {
                return null;
            }
            const entries = Object.entries(prices);
            if (!entries.length) {
                return null;
            }
            const highlightEntries = entries.filter(([region]) => PRIORITY_REGION_SET.has(region));
            const hasOtherRegions = entries.some(([region]) => !PRIORITY_REGION_SET.has(region));
            if (!highlightEntries.length && !hasOtherRegions) {
                return null;
            }

            const container = document.createElement('div');
            container.className = 'operation-details';
            const label = document.createElement('div');
            label.textContent = '지역 가격:';
            container.appendChild(label);

            if (highlightEntries.length) {
                const list = document.createElement('ul');
                highlightEntries
                    .sort(([regionA], [regionB]) => regionA.localeCompare(regionB))
                    .forEach(([region, pricePayload]) => {
                        const item = document.createElement('li');
                        const labelText = PRIORITY_REGION_LABELS[region] || region;
                        item.textContent = `${labelText}: ${formatPriceDisplay(pricePayload)}`;
                        list.appendChild(item);
                    });
                container.appendChild(list);
            }

            if (hasOtherRegions) {
                const notice = document.createElement('div');
                notice.className = 'hint';
                notice.textContent = `(${OTHER_REGION_NOTICE})`;
                container.appendChild(notice);
            }

            return container;
        }

        function buildRegionalPriceChangeDetails(previousPrices, nextPrices) {
            const prev = previousPrices || {};
            const next = nextPrices || {};
            const regions = new Set([...Object.keys(prev), ...Object.keys(next)]);
            const highlightChanges = [];
            let hasOtherChanges = false;

            regions.forEach((region) => {
                const fromText = formatPriceDisplay(prev[region]);
                const toText = formatPriceDisplay(next[region]);
                if (fromText === toText) {
                    return;
                }
                if (PRIORITY_REGION_SET.has(region)) {
                    highlightChanges.push({ region, fromText, toText });
                } else {
                    hasOtherChanges = true;
                }
            });

            if (!highlightChanges.length && !hasOtherChanges) {
                return null;
            }

            const container = document.createElement('div');

            if (highlightChanges.length) {
                const list = document.createElement('ul');
                highlightChanges
                    .sort((a, b) => a.region.localeCompare(b.region))
                    .forEach(({ region, fromText, toText }) => {
                        const item = document.createElement('li');
                        const labelText = PRIORITY_REGION_LABELS[region] || region;
                        item.textContent = `${labelText}: ${fromText} → ${toText}`;
                        list.appendChild(item);
                    });
                container.appendChild(list);
            }

            if (hasOtherChanges) {
                const notice = document.createElement('div');
                notice.className = 'hint';
                notice.textContent = `(${OTHER_REGION_NOTICE})`;
                container.appendChild(notice);
            }

            return container;
        }

        function ensureDialogOpen() {
            if (!editDialog) return;
            if (typeof editDialog.showModal === 'function') {
                try {
                    editDialog.showModal();
                } catch (error) {
                    editDialog.setAttribute('open', 'true');
                }
            } else {
                editDialog.setAttribute('open', 'true');
            }
        }

        function closeEditDialog() {
            if (!editDialog) return;
            if (typeof editDialog.close === 'function' && editDialog.open) {
                editDialog.close();
            } else {
                editDialog.removeAttribute('open');
            }
            editingItem = null;
            if (editStatusMessage) {
                editStatusMessage.textContent = '';
            }
            if (editTranslationsContainer) {
                editTranslationsContainer.innerHTML = '';
            }
            if (editForm) {
                editForm.reset();
            }
        }

        function populateStatusOptions(currentStatus) {
            if (!editStatusSelect) return;
            const normalized = (currentStatus || '').toLowerCase();
            const options = new Map();
            STATUS_OPTIONS.forEach((status) => {
                options.set(status, STATUS_LABELS[status] || status);
            });
            if (normalized && !options.has(normalized)) {
                options.set(normalized, currentStatus || normalized);
            }
            editStatusSelect.innerHTML = '';
            options.forEach((label, value) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = label;
                editStatusSelect.appendChild(option);
            });
            const preferred = normalized && options.has(normalized) ? normalized : STATUS_OPTIONS[0];
            editStatusSelect.value = preferred;
        }

        function populateDefaultLanguageOptions(languages, defaultLanguage) {
            if (!editDefaultLanguageSelect) return [];
            const normalized = Array.from(
                new Set(
                    [...(languages || []), defaultLanguage]
                        .filter((language) => typeof language === 'string' && language.trim().length)
                        .map((language) => language.trim()),
                ),
            ).sort((a, b) => a.localeCompare(b));
            editDefaultLanguageSelect.innerHTML = '';
            normalized.forEach((language) => {
                const option = document.createElement('option');
                option.value = language;
                option.textContent = language;
                editDefaultLanguageSelect.appendChild(option);
            });
            if (normalized.length) {
                const preferred = defaultLanguage && normalized.includes(defaultLanguage) ? defaultLanguage : normalized[0];
                editDefaultLanguageSelect.value = preferred;
            }
            return normalized;
        }

        function renderEditTranslations(item, languages) {
            if (!editTranslationsContainer) return;
            editTranslationsContainer.innerHTML = '';
            if (!languages.length) {
                const message = document.createElement('p');
                message.className = 'hint';
                message.textContent = '번역 정보가 없습니다. 최소 1개의 번역을 입력해주세요.';
                editTranslationsContainer.appendChild(message);
                return;
            }
            languages.forEach((language) => {
                const card = document.createElement('div');
                card.className = 'translation-card';
                card.dataset.language = language;

                const heading = document.createElement('h4');
                heading.textContent = language;
                card.appendChild(heading);

                const titleLabel = document.createElement('label');
                const titleSpan = document.createElement('span');
                titleSpan.textContent = '이름';
                const titleInput = document.createElement('input');
                titleInput.type = 'text';
                titleInput.name = `title_${language}`;
                titleInput.required = true;
                titleInput.value = item?.listings?.[language]?.title || '';
                titleLabel.appendChild(titleSpan);
                titleLabel.appendChild(titleInput);
                card.appendChild(titleLabel);

                const descriptionLabel = document.createElement('label');
                const descriptionSpan = document.createElement('span');
                descriptionSpan.textContent = '설명';
                const descriptionTextarea = document.createElement('textarea');
                descriptionTextarea.name = `description_${language}`;
                descriptionTextarea.rows = 3;
                descriptionTextarea.required = true;
                descriptionTextarea.value = item?.listings?.[language]?.description || '';
                descriptionLabel.appendChild(descriptionSpan);
                descriptionLabel.appendChild(descriptionTextarea);
                card.appendChild(descriptionLabel);

                editTranslationsContainer.appendChild(card);
            });
        }
        function openEditDialog(item) {
            editingItem = item;
            if (!item) return;
            populateStatusOptions(item.status);
            const languages = populateDefaultLanguageOptions(Object.keys(item.listings || {}), item.defaultLanguage);
            renderEditTranslations(item, languages);
            if (editSkuInput) {
                editSkuInput.value = item.sku || '';
            }
            if (editDefaultLanguageSelect) {
                editDefaultLanguageSelect.value = item.defaultLanguage || languages[0] || '';
            }
            if (editStatusSelect) {
                editStatusSelect.value = (item.status || '').toLowerCase() || 'active';
            }
            if (editPriceMicrosInput) {
                editPriceMicrosInput.value = item.defaultPrice?.priceMicros || '';
            }
            if (editPriceCurrencyInput) {
                editPriceCurrencyInput.value = item.defaultPrice?.currency || '';
            }
            ensureDialogOpen();
        }

        async function handleEditSubmit(event) {
            event.preventDefault();
            if (!editingItem) return;
            if (!editForm) return;
            if (!editSubmitBtn) return;
            const formData = new FormData(editForm);
            const defaultLanguage = formData.get('default_language');
            const status = formData.get('status');
            const priceMicros = formData.get('price_micros');
            const priceCurrency = formData.get('currency');
            if (!defaultLanguage || !status || !priceMicros || !priceCurrency) {
                if (editStatusMessage) {
                    editStatusMessage.textContent = '필수 정보를 모두 입력해주세요.';
                }
                return;
            }
            const listings = {};
            const translations = editTranslationsContainer?.querySelectorAll('.translation-card') || [];
            translations.forEach((card) => {
                const language = card.dataset.language;
                if (!language) return;
                const titleInput = card.querySelector(`input[name="title_${language}"]`);
                const descriptionTextarea = card.querySelector(`textarea[name="description_${language}"]`);
                listings[language] = {
                    title: titleInput?.value || '',
                    description: descriptionTextarea?.value || '',
                };
            });
            if (!listings[defaultLanguage]) {
                if (editStatusMessage) {
                    editStatusMessage.textContent = '기본 언어 번역 정보를 입력해주세요.';
                }
                return;
            }
            const payload = {
                default_language: defaultLanguage,
                status,
                default_price: {
                    priceMicros: priceMicros,
                    currency: priceCurrency,
                },
                listings,
            };
            editSubmitBtn.disabled = true;
            if (editStatusMessage) {
                editStatusMessage.textContent = '저장 중입니다...';
            }
            try {
                const res = await fetch(`/api/google/inapp/${encodeURIComponent(editingItem.sku)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((entry) => entry.msg || entry.detail).filter(Boolean).join(', ')
                        : err.detail;
                    throw new Error(detail || '상품 수정에 실패했습니다.');
                }
                if (editStatusMessage) {
                    editStatusMessage.textContent = '저장되었습니다.';
                }
                closeEditDialog();
                fetchList(currentToken);
            } catch (error) {
                if (editStatusMessage) {
                    editStatusMessage.textContent = error.message;
                }
            } finally {
                editSubmitBtn.disabled = false;
            }
        }

        async function handleDelete(item, triggerButton) {
            if (!item?.sku) return;
            const confirmed = window.confirm(`'${item.sku}' 상품을 삭제하시겠습니?`);
            if (!confirmed) return;
            let previousText = '';
            if (triggerButton) {
                previousText = triggerButton.textContent;
                triggerButton.disabled = true;
                triggerButton.textContent = '삭제 중...';
            }
            try {
                const res = await fetch(`/api/google/inapp/${encodeURIComponent(item.sku)}`, { method: 'DELETE' });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((entry) => entry.msg || entry.detail).filter(Boolean).join(', ')
                        : err.detail;
                    throw new Error(detail || '상품 삭제에 실패했습니다.');
                }
                fetchList(currentToken);
            } catch (error) {
                window.alert(error.message);
            } finally {
                if (triggerButton) {
                    triggerButton.disabled = false;
                    triggerButton.textContent = previousText || '삭제';
                }
            }
        }

        function renderImportPreview(data, targetElement = importPreviewEl) {
            if (!targetElement) return;
            targetElement.innerHTML = '';
            const operations = data?.operations || [];
            const summary = data?.summary || {};

            if (!operations.length) {
                const message = document.createElement('p');
                message.className = 'hint';
                message.textContent = '변경 사항이 없습니다.';
                targetElement.appendChild(message);
                return;
            }

            const groups = { create: [], update: [], delete: [] };
            operations.forEach((op) => {
                if (groups[op.action]) {
                    groups[op.action].push(op);
                }
            });

            const summaryOrder = ['create', 'update', 'delete'];
            const summaryLabels = {
                create: '생성',
                update: '업데이트',
                delete: '삭제',
            };
            const summaryParts = summaryOrder
                .map((key) => {
                    const raw = summary[key];
                    const count =
                        typeof raw === 'number' && raw >= 0 ? raw : groups[key]?.length || 0;
                    return count > 0 ? `${summaryLabels[key]} ${count}건` : null;
                })
                .filter(Boolean);

            const summaryText = document.createElement('p');
            summaryText.className = 'operation-header';
            summaryText.textContent = summaryParts.length
                ? summaryParts.join(' · ')
                : '예정된 변경 항목이 있습니다.';
            targetElement.appendChild(summaryText);

            const actionLabels = {
                create: '생성 예정',
                update: '업데이트 예정',
                delete: '삭제 예정',
            };

            Object.entries(groups).forEach(([action, ops]) => {
                if (!ops.length) return;
                const groupSection = document.createElement('div');
                groupSection.className = 'preview-group';
                const heading = document.createElement('h3');
                heading.textContent = `${actionLabels[action]} (${ops.length})`;
                groupSection.appendChild(heading);
                const list = document.createElement('ul');
                list.className = 'operation-list';

                ops.forEach((op) => {
                    const item = document.createElement('li');
                    item.className = `operation-${action}`;
                    const header = document.createElement('div');
                    header.className = 'operation-header';
                    const strong = document.createElement('strong');
                    const labelText = op.index ? `#${op.index} ${op.sku}` : op.sku;
                    strong.textContent = labelText;
                    header.appendChild(strong);

                    if (action === 'create' && op.data) {
                        const listing = op.data.listings?.[op.data.default_language];
                        const title = listing?.title ? ` - ${listing.title}` : '';
                        const priceText = formatPriceDisplay(op.data.default_price);
                        header.appendChild(document.createTextNode(`${title} (${op.data.status || '-'})`));
                        item.appendChild(header);
                        const priceInfo = document.createElement('div');
                        priceInfo.className = 'operation-details';
                        priceInfo.textContent = `가격: ${priceText}`;
                        item.appendChild(priceInfo);
                        const regionalPrices = buildRegionalPriceList(op.data.prices);
                        if (regionalPrices) {
                            item.appendChild(regionalPrices);
                        }
                    } else if (action === 'update' && op.changes) {
                        const changeEntries = Object.entries(op.changes);
                        header.appendChild(document.createTextNode(` - ${changeEntries.length}개 변경`));
                        item.appendChild(header);
                        const details = document.createElement('div');
                        details.className = 'operation-details';
                        const detailList = document.createElement('ul');

                        changeEntries.forEach(([field, value]) => {
                            const changeItem = document.createElement('li');
                            if (field === 'default_price') {
                                const fromText = formatPriceDisplay(value.from);
                                const toText = formatPriceDisplay(value.to);
                                changeItem.textContent = `가격: ${fromText} → ${toText}`;
                            } else if (field === 'prices') {
                                changeItem.textContent = '지역 가격 변경';
                                const changeDetails = buildRegionalPriceChangeDetails(value.from, value.to);
                                if (changeDetails) {
                                    changeItem.appendChild(changeDetails);
                                }
                            } else if (field === 'listings') {
                                changeItem.textContent = '번역 변경';
                                const listingList = document.createElement('ul');
                                Object.entries(value).forEach(([language, diff]) => {
                                    const langItem = document.createElement('li');
                                    const languageLabel = document.createElement('div');
                                    languageLabel.textContent = language;
                                    languageLabel.style.fontWeight = '600';
                                    langItem.appendChild(languageLabel);

                                    const languageDetails = document.createElement('ul');
                                    languageDetails.className = 'translation-change-details';
                                    const fromTitle = diff.from?.title ?? '';
                                    const toTitle = diff.to?.title ?? '';
                                    const titleDetail = document.createElement('li');
                                    if (fromTitle === toTitle) {
                                        titleDetail.textContent = '이름: 변경 없음';
                                    } else {
                                        const fromValue = fromTitle || '-';
                                        const toValue = toTitle || '-';
                                        titleDetail.textContent = `이름: ${fromValue} → ${toValue}`;
                                    }
                                    languageDetails.appendChild(titleDetail);

                                    const fromDescription = diff.from?.description ?? '';
                                    const toDescription = diff.to?.description ?? '';
                                    const descriptionDetail = document.createElement('li');
                                    if (fromDescription === toDescription) {
                                        descriptionDetail.textContent = '설명: 변경 없음';
                                    } else {
                                        const fromValue = fromDescription || '-';
                                        const toValue = toDescription || '-';
                                        descriptionDetail.textContent = `설명: ${fromValue} → ${toValue}`;
                                    }
                                    languageDetails.appendChild(descriptionDetail);

                                    langItem.appendChild(languageDetails);
                                    listingList.appendChild(langItem);
                                });
                                changeItem.appendChild(listingList);
                            } else {
                                const fromValue = value.from ?? '-';
                                const toValue = value.to ?? '-';
                                changeItem.textContent = `${field}: ${fromValue} → ${toValue}`;
                            }
                            detailList.appendChild(changeItem);
                        });
                        details.appendChild(detailList);
                        item.appendChild(details);
                    } else if (action === 'delete' && op.current) {
                        const listing = op.current.listings?.[op.current.default_language];
                        const title = listing?.title ? ` - ${listing.title}` : '';
                        const priceText = formatPriceDisplay(op.current.default_price);
                        header.appendChild(document.createTextNode(title));
                        item.appendChild(header);
                        const info = document.createElement('div');
                        info.className = 'operation-details';
                        info.textContent = `가격: ${priceText}`;
                        item.appendChild(info);
                        const regionalPrices = buildRegionalPriceList(op.current.prices);
                        if (regionalPrices) {
                            item.appendChild(regionalPrices);
                        }
                    } else {
                        item.appendChild(header);
                    }

                    list.appendChild(item);
                });

                groupSection.appendChild(list);
                targetElement.appendChild(groupSection);
            });
        }
        function updateIndexHeaderIndicator() {
            if (indexHeader) {
                indexHeader.dataset.direction = indexSortDirection;
            }
        }

        function parseOffsetFromToken(token) {
            if (!token || typeof token !== 'string') {
                return 0;
            }
            const match = token.match(/^offset:(\d+)$/);
            if (!match) {
                return 0;
            }
            const value = Number.parseInt(match[1], 10);
            if (!Number.isFinite(value) || value < 0) {
                return 0;
            }
            return value;
        }

        function itemMatchesSearch(item, term) {
            if (!term) {
                return true;
            }
            const normalized = term.toLowerCase();
            const sku = (item.sku || '').toLowerCase();
            if (sku.includes(normalized)) {
                return true;
            }
            const listings = item.listings || {};
            for (const listing of Object.values(listings)) {
                const title = (listing.title || '').toLowerCase();
                const description = (listing.description || '').toLowerCase();
                if (title.includes(normalized) || description.includes(normalized)) {
                    return true;
                }
            }
            return false;
        }

        function renderList(items) {
            if (!listEl) {
                return;
            }
            listEl.innerHTML = '';
            if (!items.length) {
                if (tableWrapper) {
                    tableWrapper.hidden = true;
                }
                if (emptyEl) {
                    emptyEl.hidden = false;
                    emptyEl.textContent = currentItems.length ? '검색 결과가 없습니다.' : '등록된 상품이 없습니다.';
                }
                return;
            }

            if (tableWrapper) {
                tableWrapper.hidden = false;
            }
            if (emptyEl) {
                emptyEl.hidden = true;
            }

            items.forEach((item) => {
                const row = document.createElement('tr');

                const indexCell = document.createElement('td');
                indexCell.textContent = item.__index != null ? String(item.__index) : '-';
                row.appendChild(indexCell);

                const skuCell = document.createElement('td');
                skuCell.textContent = item.sku || '-';
                row.appendChild(skuCell);

                const defaultListing = (item.listings && item.defaultLanguage && item.listings[item.defaultLanguage])
                    || (item.listings ? Object.values(item.listings)[0] : undefined);
                const titleCell = document.createElement('td');
                titleCell.textContent = (defaultListing && defaultListing.title) || item.sku || '-';
                row.appendChild(titleCell);

                const descriptionCell = document.createElement('td');
                descriptionCell.className = 'description-cell';
                descriptionCell.textContent = (defaultListing && defaultListing.description) || '-';
                row.appendChild(descriptionCell);

                const languageCell = document.createElement('td');
                languageCell.textContent = item.defaultLanguage || '-';
                row.appendChild(languageCell);

                const priceCell = document.createElement('td');
                priceCell.textContent = formatPriceDisplay(item.defaultPrice) || 'N/A';
                row.appendChild(priceCell);

                const statusCell = document.createElement('td');
                const statusKey = (item.status || '').toLowerCase();
                statusCell.textContent = STATUS_LABELS[statusKey] || item.status || '-';
                row.appendChild(statusCell);

                const actionsCell = document.createElement('td');
                const actionsWrapper = document.createElement('div');
                actionsWrapper.className = 'table-actions';

                const editButton = document.createElement('button');
                editButton.type = 'button';
                editButton.textContent = '수정';
                editButton.classList.add('button-secondary');
                editButton.addEventListener('click', () => openEditDialog(item));
                actionsWrapper.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.textContent = '삭제';
                deleteButton.classList.add('button-danger');
                deleteButton.addEventListener('click', () => handleDelete(item, deleteButton));
                actionsWrapper.appendChild(deleteButton);

                actionsCell.appendChild(actionsWrapper);
                row.appendChild(actionsCell);

                listEl.appendChild(row);
            });
        }

        function updateTableDisplay() {
            const baseItems = currentItems.slice();
            let displayItems = baseItems;
            if (currentSearchTerm) {
                displayItems = displayItems.filter((item) => itemMatchesSearch(item, currentSearchTerm));
            }
            displayItems = displayItems
                .slice()
                .sort((a, b) => {
                    const aIndex = Number(a.__index) || 0;
                    const bIndex = Number(b.__index) || 0;
                    return indexSortDirection === 'asc' ? aIndex - bIndex : bIndex - aIndex;
                });
            renderList(displayItems);
        }

        async function handleExportCsv() {
            importStatusEl.textContent = '';
            if (exportBtn) {
                exportBtn.disabled = true;
            }
            try {
                const res = await fetch('/api/google/inapp/export');
                if (!res.ok) {
                    throw new Error('CSV 내보내기에 실패했습니다.');
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const anchor = document.createElement('a');
                anchor.href = url;
                const timestamp = new Date().toISOString().replace(/[:T]/g, '').slice(0, 14);
                anchor.download = `iap-products-${timestamp}.csv`;
                document.body.appendChild(anchor);
                anchor.click();
                anchor.remove();
                URL.revokeObjectURL(url);
                importStatusEl.textContent = 'CSV 파일을 다운로드했습니다.';
            } catch (error) {
                importStatusEl.textContent = error.message;
            } finally {
                if (exportBtn) {
                    exportBtn.disabled = false;
                }
            }
        }
        async function handleImportPreview() {
            if (!importFileInput?.files?.length) {
                importStatusEl.textContent = 'CSV 파일을 선택해주세요.';
                return;
            }
            importStatusEl.textContent = '변경 사항을 확인 중입니다';
            importPreviewBtn.disabled = true;
            importApplyBtn.disabled = true;
            if (importPreviewEl) {
                importPreviewEl.innerHTML = '';
            }
            startProgress(importProgressTracker, '변경 사항을 확인 중입니다...');
            const formData = new FormData();
            formData.append('file', importFileInput.files[0]);
            let previewSucceeded = false;
            try {
                const res = await fetch('/api/google/inapp/import/preview', {
                    method: 'POST',
                    body: formData,
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((item) => item.msg || item.detail).filter(Boolean).join(', ')
                        : err.detail;
                    throw new Error(detail || '미리보기에 실패했습니다.');
                }
                const data = await res.json();
                pendingOperations = data.operations || [];
                previewSucceeded = true;
                renderImportPreview(data, importPreviewEl);
                if (pendingOperations.length) {
                    importStatusEl.textContent = '변경 사항을 확인한 뒤 적용 버튼을 눌러주세요.';
                    importApplyBtn.disabled = false;
                } else {
                    importStatusEl.textContent = '적용할 변경 사항이 없습니다.';
                }
            } catch (error) {
                if (importPreviewEl) {
                    importPreviewEl.innerHTML = '';
                }
                pendingOperations = [];
                importStatusEl.textContent = error.message;
            } finally {
                importPreviewBtn.disabled = false;
                completeProgress(importProgressTracker, {
                    message: previewSucceeded ? '변경 사항 확인 완료' : '변경 사항을 확인하는 중 오류가 발생했습니다.',
                    isError: !previewSucceeded,
                });
            }
        }

        async function handleImportApply() {
            if (!pendingOperations.length) {
                importStatusEl.textContent = '적용할 변경 사항이 없습니다.';
                return;
            }
            importStatusEl.textContent = '변경 사항을 적용하는 중입니다...';
            importApplyBtn.disabled = true;
            importPreviewBtn.disabled = true;
            try {
                const operationsPayload = pendingOperations.map((op) => {
                    const base = { action: op.action, sku: op.sku };
                    if (op.data) {
                        base.data = JSON.parse(JSON.stringify(op.data));
                    }
                    return base;
                });
                const res = await fetch('/api/google/inapp/import/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operations: operationsPayload }),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((item) => item.msg || item.detail).filter(Boolean).join(', ')
                        : err.detail;
                    throw new Error(detail || '변경 사항 적용에 실패했습니다.');
                }
                const result = await res.json();
                
                // Show summary with failed items if any
                if (result.failed_items && result.failed_items.length > 0) {
                    const failedSummary = result.failed_items.map(item => 
                        `행 ${item.row}: ${item.sku} (${item.error})`
                    ).join('\n');
                    importStatusEl.textContent = `일부 항목 적용 실패:\n${failedSummary}\n\n성공: ${result.summary.create}개 생성, ${result.summary.update}개 수정, ${result.summary.delete}개 삭제`;
                } else {
                    importStatusEl.textContent = '변경 사항이 적용되었습니다.';
                }
                
                pendingOperations = [];
                renderImportPreview({ operations: [], summary: { create: 0, update: 0, delete: 0 } }, importPreviewEl);
                if (importFileInput) {
                    importFileInput.value = '';
                }
                fetchList();
            } catch (error) {
                importStatusEl.textContent = error.message;
                if (pendingOperations.length) {
                    importApplyBtn.disabled = false;
                }
            } finally {
                importPreviewBtn.disabled = false;
            }
        }

        async function handleNewTemplateDownload() {
            const rowCount = Number(newTemplateCountSelect?.value) || 20;
            newImportStatusEl.textContent = '';
            if (newTemplateBtn) {
                newTemplateBtn.disabled = true;
            }
            try {
                const res = await fetch(`/api/google/inapp/new/template?row_count=${rowCount}`);
                if (!res.ok) {
                    throw new Error('템플릿 다운로드에 실패했습니다.');
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const anchor = document.createElement('a');
                anchor.href = url;
                const timestamp = new Date().toISOString().replace(/[:T]/g, '').slice(0, 14);
                anchor.download = `iap-new-products-template-${timestamp}.csv`;
                document.body.appendChild(anchor);
                anchor.click();
                anchor.remove();
                URL.revokeObjectURL(url);
                newImportStatusEl.textContent = '빈 템플릿을 다운로드했습니다.';
            } catch (error) {
                newImportStatusEl.textContent = error.message;
            } finally {
                if (newTemplateBtn) {
                    newTemplateBtn.disabled = false;
                }
            }
        }

        async function handleNewImportPreview() {
            if (!newImportFileInput?.files?.length) {
                newImportStatusEl.textContent = 'CSV 파일을 선택해주세요.';
                return;
            }
            newImportStatusEl.textContent = '신규 항목을 확인 중입니다';
            newImportPreviewBtn.disabled = true;
            newImportApplyBtn.disabled = true;
            if (newImportPreviewEl) {
                newImportPreviewEl.innerHTML = '';
            }
            startProgress(newImportProgressTracker, '신규 상품을 분석 중입니다...');
            const formData = new FormData();
            formData.append('file', newImportFileInput.files[0]);
            let previewSucceeded = false;
            try {
                const res = await fetch('/api/google/inapp/new/import/preview', {
                    method: 'POST',
                    body: formData,
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((item) => item.msg || item.detail).filter(Boolean).join(', ')
                        : err.detail;
                    throw new Error(detail || '미리보기에 실패했습니다.');
                }
                const data = await res.json();
                pendingNewOperations = data.operations || [];
                previewSucceeded = true;
                renderImportPreview(data, newImportPreviewEl);
                if (pendingNewOperations.length) {
                    newImportStatusEl.textContent = '신규 등록 내용을 확인한 뒤 적용 버튼을 눌러주세요.';
                    newImportApplyBtn.disabled = false;
                } else {
                    newImportStatusEl.textContent = '추가할 신규 항목이 없습니다.';
                }
            } catch (error) {
                if (newImportPreviewEl) {
                    newImportPreviewEl.innerHTML = '';
                }
                pendingNewOperations = [];
                newImportStatusEl.textContent = error.message;
            } finally {
                newImportPreviewBtn.disabled = false;
                completeProgress(newImportProgressTracker, {
                    message: previewSucceeded ? '신규 항목 확인 완료' : '신규 항목 확인 중 오류가 발생했습니다.',
                    isError: !previewSucceeded,
                });
            }
        }

        async function handleNewImportApply() {
            if (!pendingNewOperations.length) {
                newImportStatusEl.textContent = '적용할 신규 항목이 없습니다.';
                return;
            }
            newImportStatusEl.textContent = '신규 상품을 등록하는 중입니다...';
            newImportApplyBtn.disabled = true;
            newImportPreviewBtn.disabled = true;
            try {
                const operationsPayload = pendingNewOperations.map((op) => {
                    const base = { action: op.action, sku: op.sku };
                    if (op.data) {
                        base.data = JSON.parse(JSON.stringify(op.data));
                    }
                    return base;
                });
                const res = await fetch('/api/google/inapp/new/import/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operations: operationsPayload }),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((item) => item.msg || item.detail).filter(Boolean).join(', ')
                        : err.detail;
                    throw new Error(detail || '신규 상품 등록에 실패했습니다.');
                }
                const result = await res.json();
                
                // Show summary with failed items if any
                if (result.failed_items && result.failed_items.length > 0) {
                    const failedSummary = result.failed_items.map(item => 
                        `행 ${item.row}: ${item.sku} (${item.error})`
                    ).join('\n');
                    newImportStatusEl.textContent = `일부 상품 등록 실패:\n${failedSummary}\n\n성공: ${result.summary.create}개 등록`;
                } else {
                    newImportStatusEl.textContent = '신규 상품을 등록했습니다.';
                }
                
                pendingNewOperations = [];
                renderImportPreview({ operations: [], summary: { create: 0, update: 0, delete: 0 } }, newImportPreviewEl);
                if (newImportFileInput) {
                    newImportFileInput.value = '';
                }
                tokenStack.length = 0;
                currentToken = undefined;
                fetchList(undefined, { refresh: true });
            } catch (error) {
                newImportStatusEl.textContent = error.message;
                if (pendingNewOperations.length) {
                    newImportApplyBtn.disabled = false;
                }
            } finally {
                newImportPreviewBtn.disabled = false;
            }
        }
        function handlePageSizeChange() {
            if (!pageSizeSelect) return;
            const parsed = Number(pageSizeSelect.value);
            if (!Number.isFinite(parsed) || parsed <= 0) {
                pageSizeSelect.value = String(pageSize);
                return;
            }
            const normalized = Math.min(Math.max(Math.floor(parsed), 1), MAX_PAGE_SIZE);
            if (normalized !== parsed) {
                pageSizeSelect.value = String(normalized);
            }
            if (normalized === pageSize) {
                return;
            }
            pageSize = normalized;
            tokenStack.length = 0;
            currentToken = undefined;
            nextToken = undefined;
            if (prevBtn) {
                prevBtn.disabled = true;
            }
            if (nextBtn) {
                nextBtn.disabled = true;
            }
            fetchList();
        }

        function handleSearchInput(event) {
            currentSearchTerm = event.target.value.trim();
            updateTableDisplay();
        }

        function toggleIndexSort() {
            indexSortDirection = indexSortDirection === 'asc' ? 'desc' : 'asc';
            updateIndexHeaderIndicator();
            updateTableDisplay();
        }

        async function fetchTemplates(options = {}) {
            const showProgress = Boolean(options.showProgress) && initialLoadingActive;
            let success = false;
            let errorMessage = '';
            if (showProgress) {
                setInitialProgressMessage('가격 템플릿을 불러오는 중...');
            }
            try {
                const res = await fetch('/api/google/pricing/templates');
                if (!res.ok) {
                    throw new Error('가격 템플릿을 불러오지 못했습니다.');
                }
                const data = await res.json();
                const templates = data.templates || [];
                templateMap.clear();
                templateSelect.innerHTML = '<option value="">가격 템플릿을 선택하세요</option>';
                if (!templates.length) {
                    templateSelect.innerHTML = '<option value="">등록된 템플릿이 없습니다</option>';
                    templateSelect.disabled = true;
                    if (submitBtn) {
                        submitBtn.disabled = true;
                    }
                    renderTemplateDetails(
                        null,
                        '등록된 상품에서 KRW 가격 템플릿을 찾을 수 없습니다. 기존 상품의 가격 구성을 확인해주세요.',
                    );
                    return false;
                }
                templates.forEach((tpl) => {
                    templateMap.set(tpl.id, tpl);
                    const option = document.createElement('option');
                    option.value = tpl.id;
                    option.textContent = tpl.label;
                    templateSelect.appendChild(option);
                });
                templateSelect.disabled = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
                renderTemplateDetails(null);
                success = true;
            } catch (error) {
                errorMessage = error.message || '가격 템플릿을 불러오지 못했습니다.';
                console.error('Failed to fetch templates:', error);
                templateSelect.innerHTML = '<option value="">템플릿 로딩 실패</option>';
                templateSelect.disabled = true;
                if (submitBtn) {
                    submitBtn.disabled = true;
                }
                renderTemplateDetails(null, errorMessage);
                // 오류가 발생해도 앱은 계속 사용 가능하도록 함
                success = false;
            } finally {
                if (showProgress) {
                    finishInitialStep({ success, message: errorMessage || '가격 템플릿을 불러오지 못했습니다.' });
                }
            }
            return success;
        }

        async function fetchList(token, options = {}) {
            const showProgress = Boolean(options.showProgress) && initialLoadingActive;
            let success = false;
            let errorMessage = '';
            const activeToken = typeof token === 'string' && token.length ? token : undefined;
            currentToken = activeToken;
            nextToken = undefined;
            currentPageStartIndex = parseOffsetFromToken(activeToken);
            if (showProgress) {
                setInitialProgressMessage('등록된 상품을 불러오는 중...');
            }
            try {
                const params = new URLSearchParams();
                if (activeToken) {
                    params.set('token', activeToken);
                }
                if (options.refresh) {
                    params.set('refresh', 'true');
                }
                if (pageSize && Number.isFinite(pageSize) && pageSize > 0) {
                    params.set('page_size', String(pageSize));
                }
                const query = params.toString();
                const res = await fetch(`/api/google/inapp/list${query ? `?${query}` : ''}`);
                if (!res.ok) {
                    throw new Error('목록을 불러오지 못했습니다.');
                }
                const data = await res.json();
                const items = data.items || [];
                currentItems = items.map((item, index) => ({
                    ...item,
                    __index: currentPageStartIndex + index + 1,
                }));
                updateTableDisplay();
                nextToken = data.nextPageToken || undefined;
                if (nextBtn) {
                    nextBtn.disabled = !nextToken;
                }
                if (prevBtn) {
                    prevBtn.disabled = tokenStack.length === 0;
                }
                success = true;
            } catch (error) {
                errorMessage = error.message;
                currentItems = [];
                if (listEl) {
                    listEl.innerHTML = '';
                }
                if (tableWrapper) {
                    tableWrapper.hidden = true;
                }
                if (emptyEl) {
                    emptyEl.hidden = false;
                    emptyEl.textContent = error.message;
                }
                if (nextBtn) {
                    nextBtn.disabled = true;
                }
                if (prevBtn) {
                    prevBtn.disabled = tokenStack.length === 0;
                }
            } finally {
                if (showProgress) {
                    finishInitialStep({ success, message: errorMessage || '상품 목록을 불러오지 못했습니다.' });
                }
            }
            return success;
        }
        nextBtn?.addEventListener('click', () => {
            if (!nextToken) return;
            tokenStack.push(currentToken || null);
            currentToken = nextToken;
            fetchList(currentToken);
        });

        prevBtn?.addEventListener('click', () => {
            if (!tokenStack.length) return;
            const prev = tokenStack.pop();
            currentToken = prev || undefined;
            fetchList(currentToken);
        });

        templateSelect?.addEventListener('change', () => {
            const template = templateMap.get(templateSelect.value);
            renderTemplateDetails(template);
        });

        form?.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(form);
            statusEl.textContent = '';
            const sku = (formData.get('sku') || '').trim();
            const defaultLanguage = formData.get('default_language');
            const selectedTemplateId = (formData.get('price_template_id') || '').trim();

            if (!sku) {
                statusEl.textContent = '상품 ID를 입력해주세요.';
                return;
            }

            const translations = [];
            for (const language of translationLanguages) {
                const title = (formData.get(`title_${language}`) || '').trim();
                const description = (formData.get(`description_${language}`) || '').trim();
                if (!title && !description) {
                    continue;
                }
                if (!title || !description) {
                    statusEl.textContent = `${language} 번역은 이름과 설명을 모두 입력해야 합니다.`;
                    return;
                }
                translations.push({ language, title, description });
            }

            if (!translations.some((item) => item.language === defaultLanguage)) {
                statusEl.textContent = '기본 언어와 일치하는 번역을 입력해주세요.';
                return;
            }

            if (!selectedTemplateId) {
                statusEl.textContent = '가격 템플릿을 선택해주세요.';
                return;
            }
            if (!templateMap.has(selectedTemplateId)) {
                statusEl.textContent = '선택한 가격 템플릿 정보를 찾을 수 없습니다.';
                return;
            }

            const payload = {
                sku,
                default_language: defaultLanguage,
                translations,
                price_template_id: selectedTemplateId,
            };

            statusEl.textContent = '상품을 생성 중입니다...';
            try {
                const res = await fetch('/api/google/inapp/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    let message = err.detail;
                    if (Array.isArray(message)) {
                        message = message.map((item) => item.msg || item.detail).filter(Boolean).join(', ');
                    }
                    throw new Error(message || '생성에 실패했습니다.');
                }
                statusEl.textContent = '상품이 성공적으로 생성되었습니다.';
                form.reset();
                templateSelect.value = '';
                renderTemplateDetails(null);
                tokenStack.length = 0;
                currentToken = undefined;
                fetchList();
            } catch (error) {
                statusEl.textContent = error.message;
            }
        });

        const appleRefreshBtn = document.getElementById('apple-refresh-btn');
        const appleFixBtn = document.getElementById('apple-fix-btn');
        const appleStatusEl = document.getElementById('apple-status');
        const appleLoadingEl = document.getElementById('apple-loading');
        const appleLoadingBar = document.getElementById('apple-loading-bar');
        const appleTableWrapper = document.getElementById('apple-table-wrapper');
        const appleTableBody = document.getElementById('apple-table-body');
        const appleEmptyState = document.getElementById('apple-empty-state');
        const appleBulkDeleteTypeSelect = document.getElementById('apple-bulk-delete-type');
        const appleBulkDeleteInput = document.getElementById('apple-bulk-delete-input');
        const appleBulkDeletePreviewBtn = document.getElementById('apple-bulk-delete-preview-btn');
        const appleBulkDeleteApplyBtn = document.getElementById('apple-bulk-delete-apply-btn');
        const appleBulkDeleteStatus = document.getElementById('apple-bulk-delete-status');
        const appleBulkDeleteResults = document.getElementById('apple-bulk-delete-results');
        
        // Apple CSV 벌크 관리 관련 요소
        const appleSampleDownloadBtn = document.getElementById('apple-sample-download-btn');
        const appleImportFile = document.getElementById('apple-import-file');
        const appleImportPreviewBtn = document.getElementById('apple-import-preview-btn');
        const appleImportApplyBtn = document.getElementById('apple-import-apply-btn');
        const appleImportStatus = document.getElementById('apple-import-status');
        const appleImportProgress = document.getElementById('apple-import-progress');
        const appleImportProgressText = document.getElementById('apple-import-progress-text');
        const appleImportProgressBar = document.getElementById('apple-import-progress-bar');
        const appleImportPreview = document.getElementById('apple-import-preview');
        let pendingAppleOperations = [];
        
        const appleForm = document.getElementById('apple-form');
        const appleProductIdInput = document.getElementById('apple-product-id');
        const appleReferenceNameInput = document.getElementById('apple-reference-name');
        const applePurchaseTypeSelect = document.getElementById('apple-purchase-type');
        const applePriceKrwInput = document.getElementById('apple-price-krw');
        const applePriceKrwOptions = document.getElementById('apple-price-krw-options');
        const applePriceKrwHint = document.getElementById('apple-price-krw-hint');
        const appleBaseTerritoryInput = document.getElementById('apple-base-territory');
        const appleClearedForSaleCheckbox = document.getElementById('apple-cleared-for-sale');
        const appleFamilySharableCheckbox = document.getElementById('apple-family-sharable');
        const appleReviewNoteInput = document.getElementById('apple-review-note');
        const appleLocalizationContainer = document.getElementById('apple-localizations');
        const appleAddLocaleBtn = document.getElementById('apple-add-locale-btn');
        const appleFormStatus = document.getElementById('apple-form-status');
        const appleSubmitBtn = document.getElementById('apple-submit-btn');
        const appleResetBtn = document.getElementById('apple-reset-btn');

        const appleConfig = {
            localization: {
                defaultLocale: 'en-GB',
                locales: ['en-GB'],
            },
            pricing: {
                fixedPriceTerritories: [],
            },
        };

        const appleState = {
            initialized: false,
            items: [],
            pricePointsTerritory: '',
            pricePoints: [],
            pricePointLookupByTier: {},
            pricePointLookupByPrice: {},
            pricePointLookupById: {},
            selectedPricePoint: null,
            backgroundFetch: {
                active: false,
                abortController: null,
                items: [],
                totalCount: null,
                processedItems: new Set()
            }
        };
        let appleBulkDeleteMatches = [];

        function parseApplePriceInput(value) {
            if (value === undefined || value === null) return null;
            const normalized = value.toString().replace(/[^\d]/g, '');
            if (!normalized) return null;
            const parsed = Number(normalized);
            if (Number.isNaN(parsed)) return null;
            return parsed;
        }

        function findApplePricePointByTier(tierId) {
            if (!tierId || !appleState.pricePointLookupByTier) return null;
            return appleState.pricePointLookupByTier[tierId] || null;
        }

        function findAppleNearestPricePoint(priceKrw) {
            if (!Array.isArray(appleState.pricePoints) || !appleState.pricePoints.length) {
                return null;
            }
            const target = Number(priceKrw);
            if (!Number.isFinite(target)) {
                return null;
            }
            let best = null;
            let bestDiff = Infinity;
            appleState.pricePoints.forEach((entry) => {
                if (!entry || typeof entry !== 'object') return;
                const priceValue = parseApplePriceInput(entry.customerPrice);
                if (priceValue === null) return;
                const diff = Math.abs(priceValue - target);
                if (diff < bestDiff || (diff === bestDiff && priceValue < (parseApplePriceInput(best?.customerPrice) ?? Infinity))) {
                    best = entry;
                    bestDiff = diff;
                }
            });
            if (!best) return null;
            return {
                ...best,
                difference: bestDiff,
            };
        }

        function setApplePriceHint(match, typedPrice) {
            if (!applePriceKrwHint) return;
            if (!match) {
                applePriceKrwHint.textContent = '';
                applePriceKrwHint.hidden = true;
                applePriceKrwHint.style.color = '';
                return;
            }
            const priceValue = parseApplePriceInput(match.customerPrice);
            const formatted = priceValue !== null ? priceValue.toLocaleString('ko-KR') : match.customerPrice;
            let message = `적용 가격: KRW ${formatted}`;
            const inputPrice = parseApplePriceInput(typedPrice);
            if (inputPrice !== null && priceValue !== null) {
                const diff = Math.abs(priceValue - inputPrice);
                if (diff > 0) {
                    message += ` (입력값과 ${diff.toLocaleString('ko-KR')} KRW 차이)`;
                }
            }
            if (match.isFallback) {
                message = `가격 포인트를 불러오지 못해 입력한 금액(KRW ${formatted})으로 저장을 시도합니다.`;
            }
            applePriceKrwHint.textContent = message;
            applePriceKrwHint.hidden = false;
            applePriceKrwHint.style.color = '';
        }

        function applyApplePriceInput(value, options = {}) {
            const { silent = false } = options;
            const parsed = parseApplePriceInput(value);
            if (parsed === null) {
                appleState.selectedPricePoint = null;
                if (!silent) {
                    setApplePriceHint(null);
                }
                return null;
            }
            const match = findAppleNearestPricePoint(parsed);
            if (match) {
                appleState.selectedPricePoint = match;
                if (!silent) {
                    setApplePriceHint(match, parsed);
                }
                return match;
            }
            const fallbackPoint = {
                pricePointId: null,
                customerPrice: String(parsed),
                currency: 'KRW',
                difference: null,
                isFallback: true,
            };
            appleState.selectedPricePoint = fallbackPoint;
            if (!silent) {
                setApplePriceHint(fallbackPoint, parsed);
            }
            return fallbackPoint;
        }

        function getAppleDefaultLocale() {
            return appleConfig.localization?.defaultLocale || 'en-GB';
        }

        function getAppleConfiguredLocales() {
            const locales = appleConfig.localization?.locales;
            if (Array.isArray(locales) && locales.length) {
                const unique = [];
                locales.forEach((locale) => {
                    if (typeof locale !== 'string') return;
                    const trimmed = locale.trim();
                    if (!trimmed) return;
                    if (!unique.includes(trimmed)) {
                        unique.push(trimmed);
                    }
                });
                if (unique.length) {
                    const defaultLocale = getAppleDefaultLocale();
                    const index = unique.indexOf(defaultLocale);
                    if (index > 0) {
                        unique.splice(index, 1);
                        unique.unshift(defaultLocale);
                    } else if (index === -1) {
                        unique.unshift(defaultLocale);
                    }
                    return unique;
                }
            }
            return [getAppleDefaultLocale()];
        }

        async function loadAppleConfig() {
            try {
                const res = await fetch('/api/apple/config');
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                const data = await res.json();
                const localization = data.localization || {};
                const locales = Array.isArray(localization.locales) ? localization.locales : [];
                const defaultLocale = typeof localization.defaultLocale === 'string' && localization.defaultLocale.trim()
                    ? localization.defaultLocale.trim()
                    : getAppleDefaultLocale();
                const normalizedLocales = locales
                    .map((locale) => (typeof locale === 'string' ? locale.trim() : ''))
                    .filter((locale) => locale);
                if (!normalizedLocales.includes(defaultLocale)) {
                    normalizedLocales.unshift(defaultLocale);
                }
                appleConfig.localization = {
                    defaultLocale,
                    locales: normalizedLocales,
                };
                const pricing = data.pricing || {};
                const fixedTerritories = Array.isArray(pricing.fixedPriceTerritories)
                    ? pricing.fixedPriceTerritories
                          .map((territory) => (typeof territory === 'string' ? territory.trim() : ''))
                          .filter((territory) => territory)
                    : [];
                appleConfig.pricing = {
                    fixedPriceTerritories: Array.from(new Set(fixedTerritories)),
                };
            } catch (error) {
                console.warn('Failed to load Apple configuration:', error);
            }
        }

        function populateApplePriceOptions(points) {
            if (!applePriceKrwOptions) return;
            appleState.pricePoints = Array.isArray(points) ? points.slice().sort((a, b) => {
                const priceA = parseApplePriceInput(a?.customerPrice) ?? Infinity;
                const priceB = parseApplePriceInput(b?.customerPrice) ?? Infinity;
                return priceA - priceB;
            }) : [];
            appleState.pricePointLookupByTier = {};
            appleState.pricePointLookupByPrice = {};
            appleState.pricePointLookupById = {};
            applePriceKrwOptions.innerHTML = '';

            appleState.pricePoints.forEach((point) => {
                if (!point) return;
                const { tier, customerPrice, currency, pricePointId } = point;
                if (tier) {
                    appleState.pricePointLookupByTier[tier] = point;
                }
                const normalizedPrice = parseApplePriceInput(customerPrice);
                if (normalizedPrice !== null) {
                    appleState.pricePointLookupByPrice[normalizedPrice] = point;
                }
                if (pricePointId) {
                    appleState.pricePointLookupById[pricePointId] = point;
                }

                if (currency && customerPrice) {
                    const option = document.createElement('option');
                    option.value = `${currency} ${customerPrice}`;
                    option.label = `티어 ${tier || ''}`.trim();
                    applePriceKrwOptions.appendChild(option);

                    const numericOption = document.createElement('option');
                    numericOption.value = customerPrice;
                    numericOption.label = currency;
                    applePriceKrwOptions.appendChild(numericOption);
                } else if (customerPrice) {
                    const option = document.createElement('option');
                    option.value = customerPrice;
                    option.label = tier ? `티어 ${tier}` : customerPrice;
                    applePriceKrwOptions.appendChild(option);
                }
            });

            if (applePriceKrwInput && applePriceKrwInput.value) {
                applyApplePriceInput(applePriceKrwInput.value, { silent: true });
            } else {
                setApplePriceHint(null);
            }
        }

        function formatApplePriceDisplayByTier(tierId) {
            if (!tierId) return tierId || '-';
            const point = findApplePricePointByTier(tierId);
            if (point && point.currency && point.customerPrice) {
                return `${point.currency} ${point.customerPrice}`;
            }
            return tierId;
        }

        function addAppleLocalization(locale = getAppleDefaultLocale(), name = '', description = '') {
            if (!appleLocalizationContainer) return;
            const card = document.createElement('div');
            card.className = 'localization-card';
            const header = document.createElement('header');
            const heading = document.createElement('h4');
            heading.textContent = locale || '신규 현지화';
            header.appendChild(heading);
            const actions = document.createElement('div');
            actions.className = 'actions';
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'button-secondary';
            removeBtn.textContent = '삭제';
            removeBtn.addEventListener('click', () => {
                card.remove();
            });
            actions.appendChild(removeBtn);
            header.appendChild(actions);
            card.appendChild(header);

            const localeLabel = document.createElement('label');
            localeLabel.textContent = '언어 코드';
            const localeInput = document.createElement('input');
            localeInput.type = 'text';
            localeInput.placeholder = '예: ko-KR';
            localeInput.value = locale;
            localeInput.className = 'apple-locale-input';
            localeLabel.appendChild(localeInput);
            card.appendChild(localeLabel);

            const nameLabel = document.createElement('label');
            nameLabel.textContent = '이름';
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.required = true;
            nameInput.value = name;
            nameInput.className = 'apple-name-input';
            nameLabel.appendChild(nameInput);
            card.appendChild(nameLabel);

            const descriptionLabel = document.createElement('label');
            descriptionLabel.textContent = '설명';
            const descriptionTextarea = document.createElement('textarea');
            descriptionTextarea.rows = 3;
            descriptionTextarea.required = true;
            descriptionTextarea.value = description;
            descriptionTextarea.className = 'apple-description-input';
            descriptionLabel.appendChild(descriptionTextarea);
            card.appendChild(descriptionLabel);

            localeInput.addEventListener('input', () => {
                heading.textContent = localeInput.value || '신규 현지화';
            });

            appleLocalizationContainer.appendChild(card);
        }

        function resetAppleForm() {
            if (!appleForm) return;
            appleForm.dataset.mode = 'create';
            appleForm.dataset.productId = '';
            if (appleProductIdInput) {
                appleProductIdInput.value = '';
                appleProductIdInput.readOnly = false;
            }
            if (appleReferenceNameInput) appleReferenceNameInput.value = '';
            if (applePurchaseTypeSelect) {
                applePurchaseTypeSelect.disabled = false;
                applePurchaseTypeSelect.value = applePurchaseTypeSelect.options[0]?.value || 'consumable';
            }
            appleState.selectedPricePoint = null;
            if (applePriceKrwInput) applePriceKrwInput.value = '';
            setApplePriceHint(null);
            if (appleBaseTerritoryInput) appleBaseTerritoryInput.value = 'KOR';
            if (appleClearedForSaleCheckbox) appleClearedForSaleCheckbox.checked = true;
            if (appleFamilySharableCheckbox) appleFamilySharableCheckbox.checked = false;
            if (appleReviewNoteInput) appleReviewNoteInput.value = '';
            if (appleLocalizationContainer) {
                appleLocalizationContainer.innerHTML = '';
                const locales = getAppleConfiguredLocales();
                locales.forEach((locale) => {
                    addAppleLocalization(locale);
                });
            }
            if (appleFormStatus) appleFormStatus.textContent = '';
            if (appleSubmitBtn) appleSubmitBtn.textContent = '저장';
        }

        function gatherAppleLocalizations() {
            const result = [];
            if (!appleLocalizationContainer) return result;
            const cards = appleLocalizationContainer.querySelectorAll('.localization-card');
            cards.forEach((card) => {
                const localeInput = card.querySelector('.apple-locale-input');
                const nameInput = card.querySelector('.apple-name-input');
                const descriptionInput = card.querySelector('.apple-description-input');
                const locale = (localeInput?.value || '').trim();
                const name = (nameInput?.value || '').trim();
                const description = (descriptionInput?.value || '').trim();
                if (!locale || !name || !description) {
                    return;
                }
                result.push({ locale, name, description });
            });
            return result;
        }

        function renderAppleTable(items = appleState.items) {
            if (!appleTableBody || !appleTableWrapper || !appleEmptyState) return;
            appleTableBody.innerHTML = '';
            if (!items.length) {
                appleTableWrapper.hidden = true;
                appleEmptyState.hidden = false;
                return;
            }
            // Show table immediately when we have data
            appleTableWrapper.hidden = false;
            appleEmptyState.hidden = true;
            items.forEach((item) => {
                const productId = item.productId || item.sku || '';
                const type = item.type || '';
                const state = item.state || '';
                const priceTier = item.priceTier || '';
                const tr = document.createElement('tr');
                const idTd = document.createElement('td');
                idTd.textContent = productId;
                tr.appendChild(idTd);
                const typeTd = document.createElement('td');
                typeTd.textContent = type;
                tr.appendChild(typeTd);
                const stateTd = document.createElement('td');
                stateTd.textContent = state;
                tr.appendChild(stateTd);
                const tierTd = document.createElement('td');
                // Prefer displaying KRW price if available, fallback to tier mapping
                if (item.krwPrice && item.krwPrice.currency && item.krwPrice.customerPrice) {
                    tierTd.textContent = `${item.krwPrice.currency} ${item.krwPrice.customerPrice}`;
                } else {
                    tierTd.textContent = formatApplePriceDisplayByTier(priceTier);
                }
                tr.appendChild(tierTd);
                const actionsTd = document.createElement('td');
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'button-secondary';
                editBtn.textContent = '수정';
                editBtn.addEventListener('click', () => openAppleEditor(item));
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.textContent = '삭제';
                deleteBtn.addEventListener('click', () => handleAppleDelete(item));
                actionsTd.appendChild(editBtn);
                actionsTd.appendChild(deleteBtn);
                tr.appendChild(actionsTd);
                appleTableBody.appendChild(tr);
            });
        }

        function getAppleItemIdentifier(item) {
            if (!item || typeof item !== 'object') return '';
            return item.id || item.productId || item.sku || '';
        }

        function upsertAppleStateItem(item) {
            const id = getAppleItemIdentifier(item);
            if (!id) return;

            const upsertInto = (array, insertAtStart = false) => {
                if (!Array.isArray(array)) return;
                const index = array.findIndex((entry) => getAppleItemIdentifier(entry) === id);
                if (index >= 0) {
                    array[index] = item;
                } else if (insertAtStart) {
                    array.unshift(item);
                } else {
                    array.push(item);
                }
            };

            upsertInto(appleState.items, true);
            if (appleState.backgroundFetch && Array.isArray(appleState.backgroundFetch.items)) {
                upsertInto(appleState.backgroundFetch.items, true);
            }
        }

        async function loadApplePricePoints(territory = 'KOR', options = {}) {
            if (!applePriceKrwOptions) return;
            const normalized = (territory || 'KOR').trim().toUpperCase();
            if (!options.force && appleState.pricePointsTerritory === normalized && appleState.pricePoints.length) {
                populateApplePriceOptions(appleState.pricePoints);
                return;
            }
            applePriceKrwOptions.innerHTML = '';
            try {
                const res = await fetch(`/api/apple/pricing/tiers?territory=${encodeURIComponent(normalized)}`);
                if (!res.ok) {
                    throw new Error('가격 티어를 불러오지 못했습니다.');
                }
                const data = await res.json();
                const pricePoints = data.tiers || [];
                appleState.pricePointsTerritory = normalized;
                appleState.pricePoints = pricePoints;
                populateApplePriceOptions(pricePoints);
            } catch (error) {
                if (!options.quiet && appleFormStatus) {
                    appleFormStatus.textContent = error.message;
                }
            }
        }

        async function fetchAppleList(options = {}) {
            // Cancel any existing background fetch
            if (appleState.backgroundFetch.active && appleState.backgroundFetch.abortController) {
                appleState.backgroundFetch.abortController.abort();
            }
            
            // Initialize new fetch
            const abortController = new AbortController();
            appleState.backgroundFetch.abortController = abortController;
            appleState.backgroundFetch.active = true;
            appleState.backgroundFetch.items = [];
            appleState.backgroundFetch.processedItems = new Set();
            appleState.backgroundFetch.totalCount = null;
            
            if (appleLoadingEl) appleLoadingEl.hidden = false;
            if (appleLoadingBar) appleLoadingBar.style.width = '10%';
            if (appleStatusEl) appleStatusEl.textContent = 'Apple 인앱 상품 목록 확인 중...';
            
            // For refresh requests, show initial checking status
            let initialCheckComplete = false;
            
            const refresh = Boolean(options.refresh);
            let items = [];
            let token;
            let totalCount = null;
            let pageNum = 0;
            let processedItems = new Set();
            
            try {
                do {
                    // Check if aborted
                    if (abortController.signal.aborted) {
                        console.log('Apple fetch aborted');
                        break;
                    }
                    
                    pageNum++;
                    const params = new URLSearchParams();
                    params.set('page_size', '200');
                    if (token) params.set('token', token);
                    if (refresh && !token) params.set('refresh', 'true');
                    
                    const res = await fetch(`/api/apple/inapp/list?${params.toString()}`, {
                        signal: abortController.signal
                    });
                    
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        const detail = Array.isArray(err.detail)
                            ? err.detail.map((entry) => entry.msg || entry.detail).filter(Boolean).join(', ')
                            : err.detail || err.message;
                        throw new Error(detail || 'Apple 인앱 상품을 불러오지 못했습니다.');
                    }
                    
                    const data = await res.json();
                    const newItems = data.items || [];
                    
                    // Mark initial check as complete after first response
                    if (!initialCheckComplete && refresh && pageNum === 1) {
                        initialCheckComplete = true;
                        if (appleStatusEl) appleStatusEl.textContent = 'Apple 인앱 상품을 불러오는 중...';
                    }
                    
                    console.log(`Received ${newItems.length} items from API, page ${pageNum}`);
                    
                    // Filter out duplicates
                    const uniqueNewItems = newItems.filter(item => {
                        const id = item.id || item.sku || item.productId;
                        if (!id || processedItems.has(id)) return false;
                        processedItems.add(id);
                        return true;
                    });
                    
                    items.push(...uniqueNewItems);
                    
                    // Update background fetch state
                    appleState.backgroundFetch.items = items;
                    appleState.backgroundFetch.processedItems = processedItems;
                    
                    // Log progress with items remaining
                    if (totalCount) {
                        const remaining = totalCount - items.length;
                        console.log(`Total items so far: ${items.length}/${totalCount} (${remaining} remaining)`);
                    } else {
                        console.log(`Total items so far: ${items.length}`);
                    }
                    
                    // Show table immediately when we have first batch
                    if (items.length > 0) {
                        if (appleTableWrapper) {
                            console.log(`Table wrapper hidden status: ${appleTableWrapper.hidden}`);
                            appleTableWrapper.hidden = false;
                            console.log(`Table wrapper hidden status after unhide: ${appleTableWrapper.hidden}`);
                        }
                        if (appleEmptyState && !appleEmptyState.hidden) {
                            appleEmptyState.hidden = true;
                        }
                    }
                    
                    // Update total count if available
                    if (data.totalCount !== undefined && data.totalCount !== null) {
                        totalCount = data.totalCount;
                        appleState.backgroundFetch.totalCount = totalCount;
                        console.log(`Total count from API: ${totalCount}`);
                    }
                    
                    // If we got items on first page with refresh, it means incremental update completed
                    // Show progress as if we're fetching from cache
                    if (refresh && pageNum === 1 && newItems.length > 0 && totalCount) {
                        const percent = Math.min(95, Math.round((newItems.length / totalCount) * 100));
                        if (appleLoadingBar) appleLoadingBar.style.width = `${percent}%`;
                        if (appleStatusEl) {
                            appleStatusEl.textContent = `Apple 인앱 상품 ${newItems.length}/${totalCount}개 불러옴`;
                        }
                    }
                    
                    // Update progress bar and status (only if on Apple section)
                    const isOnAppleSection = !storePanes.get('apple')?.hidden;
                    if (isOnAppleSection) {
                        if (totalCount) {
                            // Show progress based on actual items fetched vs total
                            const percent = Math.min(95, Math.round((items.length / totalCount) * 100));
                            const remaining = totalCount - items.length;
                            if (appleLoadingBar) appleLoadingBar.style.width = `${percent}%`;
                            if (appleStatusEl) appleStatusEl.textContent = `Apple 인앱 상품을 불러오는 중... ${items.length}/${totalCount}개 (${remaining}개 남음, ${percent}%)`;
                        } else {
                            // Estimate based on page number when total is unknown
                            const estimatedPercent = Math.min(95, pageNum * 10);
                            if (appleLoadingBar) appleLoadingBar.style.width = `${estimatedPercent}%`;
                            if (appleStatusEl) appleStatusEl.textContent = `Apple 인앱 상품을 불러오는 중... (${items.length}개 불러옴)`;
                        }
                    } else {
                        // Update background fetch status even when not visible
                        if (totalCount) {
                            const percent = Math.min(95, Math.round((items.length / totalCount) * 100));
                            const remaining = totalCount - items.length;
                            console.log(`Background fetch progress: ${items.length}/${totalCount} (${remaining} remaining, ${percent}%)`);
                        }
                    }
                    
                    // Update table incrementally
                    appleState.items = items;
                    if (isOnAppleSection) {
                        renderAppleTable(items);
                    }
                    
                    token = data.nextPageToken || null;
                    
                    // Small delay between pages to avoid overwhelming the server
                    if (token) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                } while (token);
                
                // Final update
                appleState.items = items;
                appleState.backgroundFetch.active = false;
                
                // Only update UI if still on Apple section
                const isOnAppleSection = !storePanes.get('apple')?.hidden;
                if (isOnAppleSection) {
                    renderAppleTable(items);
                    if (appleStatusEl) {
                        if (totalCount) {
                            const percent = items.length >= totalCount ? 100 : Math.round((items.length / totalCount) * 100);
                            if (percent === 100) {
                                appleStatusEl.textContent = `총 ${items.length}개의 Apple 인앱 상품을 불러왔습니다.`;
                                // 100%인 경우 progress bar 숨김
                                if (appleLoadingEl) appleLoadingEl.hidden = true;
                            } else {
                                appleStatusEl.textContent = `총 ${items.length}/${totalCount}개의 Apple 인앱 상품을 불러왔습니다. (${percent}%)`;
                            }
                        } else {
                            appleStatusEl.textContent = `총 ${items.length}개의 Apple 인앱 상품을 불러왔습니다.`;
                        }
                    }
                }
                
                console.log(`Fetch complete: ${items.length}${totalCount ? `/${totalCount}` : ''} items`);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Fetch aborted by user');
                    return;
                }
                
                appleState.items = items.length > 0 ? items : [];
                appleState.backgroundFetch.active = false;
                
                const isOnAppleSection = !storePanes.get('apple')?.hidden;
                if (isOnAppleSection) {
                    renderAppleTable(appleState.items);
                    if (appleStatusEl) {
                        const partialInfo = items.length > 0 ? ` (${items.length}개 불러옴)` : '';
                        appleStatusEl.textContent = error.message + partialInfo;
                    }
                }
                
                console.error('Fetch error:', error.message, `- ${items.length} items fetched`);
            } finally {
                appleState.backgroundFetch.active = false;
                
                // Hide loading indicator (only if on Apple section)
                const isOnAppleSection = !storePanes.get('apple')?.hidden;
                if (isOnAppleSection) {
                    if (appleLoadingBar) {
                        appleLoadingBar.style.opacity = '1';
                        appleLoadingBar.style.width = '100%';
                        setTimeout(() => {
                            if (appleLoadingEl) appleLoadingEl.hidden = true;
                            if (appleLoadingBar) {
                                appleLoadingBar.style.width = '0%';
                                appleLoadingBar.style.opacity = '1';
                            }
                        }, 400);
                    } else if (appleLoadingEl) {
                        appleLoadingEl.hidden = true;
                    }
                }
            }
        }

        async function openAppleEditor(item) {
            if (!appleForm) return;
            const productId = item?.productId || item?.sku || '';
            if (!productId) {
                if (appleFormStatus) appleFormStatus.textContent = '상품 ID를 확인할 수 없습니다.';
                return;
            }
            
            // Switch to form section
            setActiveSection('apple', 'apple-section-form');
            
            appleForm.dataset.mode = 'edit';
            appleForm.dataset.productId = productId;
            if (appleProductIdInput) {
                appleProductIdInput.value = productId;
                appleProductIdInput.readOnly = true;
            }
            if (applePurchaseTypeSelect) {
                applePurchaseTypeSelect.disabled = true;
            }
            if (appleFormStatus) appleFormStatus.textContent = '상세 정보를 불러오는 중입니다...';
            
            // Progress bar 표시
            const formProgressEl = document.getElementById('apple-form-progress');
            if (!formProgressEl) {
                // Progress bar 요소가 없으면 생성
                const progressContainer = document.createElement('div');
                progressContainer.id = 'apple-form-progress';
                progressContainer.className = 'initial-loading';
                progressContainer.style.cssText = 'position: relative; z-index: 10; background: white; padding: 10px; margin-bottom: 10px;';
                progressContainer.innerHTML = '<p class="hint">상세 정보를 불러오는 중입니다...</p><div class="progress-bar"><div class="progress-bar-fill" id="apple-form-progress-bar" style="width: 0%;"></div></div>';
                if (appleForm && appleForm.parentNode) {
                    appleForm.parentNode.insertBefore(progressContainer, appleForm);
                }
            } else {
                formProgressEl.hidden = false;
                const progressBar = document.getElementById('apple-form-progress-bar');
                if (progressBar) progressBar.style.width = '0%';
            }

            try {
                const res = await fetch(`/api/apple/inapp/${encodeURIComponent(productId)}/detail`);
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((entry) => entry.msg || entry.detail).filter(Boolean).join(', ')
                        : err.detail || err.message;
                    throw new Error(detail || '상세 정보를 불러오지 못했습니다.');
                }
                const data = await res.json();
                const detail = data?.item || {};
                if (appleReferenceNameInput) appleReferenceNameInput.value = detail.referenceName || '';
                if (applePurchaseTypeSelect) {
                    const normalized = (detail.type || '').toLowerCase();
                    const option = Array.from(applePurchaseTypeSelect.options).find(
                        (opt) => opt.value.toLowerCase() === normalized
                    );
                    applePurchaseTypeSelect.value = option ? option.value : applePurchaseTypeSelect.options[0]?.value || 'consumable';
                }
                const prices = Array.isArray(detail.prices) ? detail.prices : [];
                const selectedTier = prices.length ? prices[0].priceTier || '' : '';
                const baseTerritory = prices.length ? prices[0].territory || 'KOR' : 'KOR';
                const krwPriceInfo = detail.krwPrice || {};
                const krwPriceValue = krwPriceInfo.customerPrice || '';
                if (appleBaseTerritoryInput) {
                    appleBaseTerritoryInput.value = baseTerritory;
                }
                if (appleClearedForSaleCheckbox) appleClearedForSaleCheckbox.checked = Boolean(detail.clearedForSale);
                if (appleFamilySharableCheckbox) appleFamilySharableCheckbox.checked = Boolean(detail.familySharable);
                if (appleReviewNoteInput) appleReviewNoteInput.value = detail.reviewNote || '';
                if (appleLocalizationContainer) {
                    appleLocalizationContainer.innerHTML = '';
                    const localizations = detail.localizations || {};
                    const entries = Object.entries(localizations);
                    if (entries.length) {
                        const seenLocales = new Set();
                        entries.forEach(([locale, value]) => {
                            addAppleLocalization(locale, value?.name || '', value?.description || '');
                            if (locale) {
                                seenLocales.add(locale);
                            }
                        });
                        getAppleConfiguredLocales().forEach((locale) => {
                            if (!seenLocales.has(locale)) {
                                addAppleLocalization(locale);
                            }
                        });
                    } else {
                        getAppleConfiguredLocales().forEach((locale) => {
                            addAppleLocalization(locale);
                        });
                    }
                }
                if (appleFormStatus) appleFormStatus.textContent = '';
                if (appleSubmitBtn) appleSubmitBtn.textContent = '저장';
                
                // Progress bar 숨김
                const formProgressEl = document.getElementById('apple-form-progress');
                if (formProgressEl) {
                    const progressBar = document.getElementById('apple-form-progress-bar');
                    if (progressBar) progressBar.style.width = '100%';
                    setTimeout(() => {
                        formProgressEl.hidden = true;
                        if (progressBar) progressBar.style.width = '0%';
                    }, 300);
                }
                const territoryValue = (appleBaseTerritoryInput?.value || 'KOR').trim().toUpperCase();
                const applyPrice = () => {
                    appleState.selectedPricePoint = null;
                    if (applePriceKrwInput) {
                        if (krwPriceValue) {
                            applePriceKrwInput.value = krwPriceValue;
                            applyApplePriceInput(krwPriceValue);
                        } else if (selectedTier) {
                            const point = findApplePricePointByTier(selectedTier);
                            if (point && point.customerPrice) {
                                applePriceKrwInput.value = point.customerPrice;
                                appleState.selectedPricePoint = point;
                                setApplePriceHint(point, point.customerPrice);
                            } else {
                                applePriceKrwInput.value = '';
                                setApplePriceHint(null);
                            }
                        } else {
                            applePriceKrwInput.value = '';
                            setApplePriceHint(null);
                        }
                    }
                };
                if (appleState.pricePointsTerritory !== territoryValue) {
                    loadApplePricePoints(territoryValue, { force: true }).then(applyPrice);
                } else {
                    applyPrice();
                }
            } catch (error) {
                if (appleFormStatus) appleFormStatus.textContent = error.message;
            }
        }

        async function handleAppleDelete(item) {
            const productId = item.productId || item.sku;
            if (!productId) return;
            const confirmed = window.confirm(`'${productId}' 상품을 삭제하시겠습니까?`);
            if (!confirmed) return;
            try {
                const res = await fetch(`/api/apple/inapp/${encodeURIComponent(productId)}`, { method: 'DELETE' });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((entry) => entry.msg || entry.detail).filter(Boolean).join(', ')
                        : err.detail || err.message;
                    throw new Error(detail || '상품 삭제에 실패했습니다.');
                }
                if (appleStatusEl) appleStatusEl.textContent = '상품을 삭제했습니다.';
                if (appleForm && appleForm.dataset.productId === productId) {
                    resetAppleForm();
                }
                // 삭제 성공 시 캐시에서만 제거 (full fetch 하지 않음)
                appleState.items = appleState.items.filter(i => (i.productId || i.sku) !== productId);
                renderAppleTable();
            } catch (error) {
                if (appleStatusEl) appleStatusEl.textContent = error.message;
            }
        }

        function renderAppleBulkDeleteResults(matches = appleBulkDeleteMatches) {
            if (!appleBulkDeleteResults) return;
            appleBulkDeleteResults.innerHTML = '';
            if (!matches.length) {
                const message = document.createElement('p');
                message.className = 'hint';
                message.textContent = '삭제 대상이 없습니다.';
                appleBulkDeleteResults.appendChild(message);
                return;
            }
            const table = document.createElement('table');
            table.className = 'iap-table';
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th scope="col">Product ID</th>
                    <th scope="col">타입</th>
                    <th scope="col">상태</th>
                    <th scope="col">가격</th>
                    <th scope="col">일치 값</th>
                </tr>
            `;
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            matches.forEach((match) => {
                const tr = document.createElement('tr');
                const productId = match.productId || match.sku || '';
                const type = match.type || '';
                const state = match.state || '';
                const priceTier = Array.isArray(match.prices) && match.prices.length ? match.prices[0].priceTier || '' : '';
                const matchedValue = match.matchedValue || '';
                
                // Display KRW price if available, otherwise fallback to tier
                let priceDisplay = '-';
                if (match.krwPrice && match.krwPrice.currency && match.krwPrice.customerPrice) {
                    priceDisplay = `${match.krwPrice.currency} ${match.krwPrice.customerPrice}`;
                } else if (priceTier) {
                    priceDisplay = formatApplePriceDisplayByTier(priceTier);
                }
                
                tr.innerHTML = `
                    <td>${productId || '-'}</td>
                    <td>${type || '-'}</td>
                    <td>${state || '-'}</td>
                    <td>${priceDisplay}</td>
                    <td>${matchedValue || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            appleBulkDeleteResults.appendChild(table);
        }

        function collectBulkDeleteValues() {
            const raw = (appleBulkDeleteInput?.value || '').split(/\r?\n/);
            const values = raw
                .map((value) => value.trim())
                .filter((value, index, array) => value && array.indexOf(value) === index);
            return values;
        }

        async function handleAppleBulkDeletePreview() {
            if (!appleBulkDeletePreviewBtn) return;
            const values = collectBulkDeleteValues();
            if (!values.length) {
                if (appleBulkDeleteStatus) appleBulkDeleteStatus.textContent = '삭제할 값을 입력해주세요.';
                renderAppleBulkDeleteResults([]);
                appleBulkDeleteApplyBtn?.setAttribute('disabled', 'true');
                return;
            }
            appleBulkDeletePreviewBtn.disabled = true;
            if (appleBulkDeleteApplyBtn) appleBulkDeleteApplyBtn.disabled = true;
            if (appleBulkDeleteStatus) appleBulkDeleteStatus.textContent = '삭제 대상을 조회하는 중입니다...';
            try {
                const identifierType = appleBulkDeleteTypeSelect?.value || 'product_id';
                const res = await fetch('/api/apple/inapp/bulk-delete/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier_type: identifierType, values }),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((entry) => entry.msg || entry.detail).filter(Boolean).join(', ')
                        : err.detail || err.message;
                    throw new Error(detail || '삭제 대상을 불러오지 못했습니다.');
                }
                const data = await res.json();
                appleBulkDeleteMatches = Array.isArray(data.matches) ? data.matches : [];
                renderAppleBulkDeleteResults(appleBulkDeleteMatches);
                if (appleBulkDeleteStatus) {
                    appleBulkDeleteStatus.textContent = appleBulkDeleteMatches.length
                        ? '삭제할 항목을 확인한 뒤 삭제 버튼을 눌러주세요.'
                        : '일치하는 상품이 없습니다.';
                }
                if (appleBulkDeleteApplyBtn) {
                    appleBulkDeleteApplyBtn.disabled = !appleBulkDeleteMatches.length;
                }
            } catch (error) {
                if (appleBulkDeleteStatus) appleBulkDeleteStatus.textContent = error.message;
                appleBulkDeleteMatches = [];
                renderAppleBulkDeleteResults([]);
            } finally {
                appleBulkDeletePreviewBtn.disabled = false;
            }
        }

        async function handleAppleBulkDeleteApply() {
            if (!appleBulkDeleteApplyBtn) return;
            if (!appleBulkDeleteMatches.length) {
                if (appleBulkDeleteStatus) appleBulkDeleteStatus.textContent = '삭제할 대상을 먼저 조회해주세요.';
                return;
            }
            const items = appleBulkDeleteMatches
                .map((match) => ({
                    inapp_id: match.id,
                    product_id: match.productId || match.sku || '',
                }))
                .filter((item) => item.inapp_id && item.product_id);
            if (!items.length) {
                if (appleBulkDeleteStatus) appleBulkDeleteStatus.textContent = '삭제할 항목의 ID를 확인할 수 없습니다.';
                return;
            }
            appleBulkDeleteApplyBtn.disabled = true;
            if (appleBulkDeleteStatus) appleBulkDeleteStatus.textContent = '선택한 상품을 삭제하는 중입니다...';
            try {
                const res = await fetch('/api/apple/inapp/bulk-delete/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items }),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((entry) => entry.msg || entry.detail).filter(Boolean).join(', ')
                        : err.detail || err.message;
                    throw new Error(detail || '삭제에 실패했습니다.');
                }
                const data = await res.json();
                const summary = data.summary || {};
                const deleted = summary.deleted || 0;
                const failed = Array.isArray(summary.failed) ? summary.failed.length : 0;
                if (appleBulkDeleteStatus) {
                    appleBulkDeleteStatus.textContent = failed
                        ? `${deleted}개의 상품을 삭제하고 ${failed}개의 상품은 삭제하지 못했습니다.`
                        : `${deleted}개의 상품을 삭제했습니다.`;
                }
                // 삭제 성공 시 캐시에서만 제거 (full fetch 하지 않음)
                if (deleted > 0 && appleState.items) {
                    const deletedProductIds = new Set(
                        items.filter((item, idx) => {
                            // Check if this item was successfully deleted
                            const failedItems = summary.failed || [];
                            const isFailed = failedItems.some(f => f.product_id === item.product_id);
                            return !isFailed;
                        }).map(item => item.product_id).filter(Boolean)
                    );
                    appleState.items = appleState.items.filter(i => {
                        const pid = i.productId || i.sku;
                        return !deletedProductIds.has(pid);
                    });
                    renderAppleTable(appleState.items);
                }
                appleBulkDeleteMatches = [];
                renderAppleBulkDeleteResults([]);
                if (appleBulkDeleteInput) appleBulkDeleteInput.value = '';
                if (appleBulkDeleteApplyBtn) appleBulkDeleteApplyBtn.disabled = true;
            } catch (error) {
                if (appleBulkDeleteStatus) appleBulkDeleteStatus.textContent = error.message;
                appleBulkDeleteApplyBtn.disabled = false;
            }
        }

        renderAppleBulkDeleteResults([]);

        async function handleAppleSubmit(event) {
            if (event) {
                event.preventDefault();
            }
            if (!appleForm) return;
            const mode = appleForm.dataset.mode || 'create';
            const productId = (appleProductIdInput?.value || '').trim();
            const referenceName = (appleReferenceNameInput?.value || '').trim();
            if (!productId) {
                if (appleFormStatus) appleFormStatus.textContent = '상품 ID를 입력해주세요.';
                return;
            }
            if (!referenceName) {
                if (appleFormStatus) appleFormStatus.textContent = '참조 이름을 입력해주세요.';
                return;
            }
            const localizations = gatherAppleLocalizations();
            if (!localizations.length) {
                if (appleFormStatus) appleFormStatus.textContent = '최소 1개의 현지화를 입력해주세요.';
                return;
            }
            const priceInputRaw = (applePriceKrwInput?.value || '').trim();
            const parsedPrice = parseApplePriceInput(priceInputRaw);
            if (!priceInputRaw) {
                if (appleFormStatus) appleFormStatus.textContent = '가격(KRW)을 입력해주세요.';
                applePriceKrwInput?.focus();
                return;
            }
            if (priceInputRaw && parsedPrice === null) {
                if (appleFormStatus) appleFormStatus.textContent = '가격은 숫자만 입력할 수 있습니다.';
                applePriceKrwInput?.focus();
                return;
            }
            const matchedPricePoint = appleState.selectedPricePoint || applyApplePriceInput(priceInputRaw);
            if (!matchedPricePoint) {
                if (appleFormStatus) appleFormStatus.textContent = '사용 가능한 가격 포인트를 찾을 수 없습니다.';
                applePriceKrwInput?.focus();
                return;
            }
            const resolvedPrice = parseApplePriceInput(
                matchedPricePoint.customerPrice !== undefined ? matchedPricePoint.customerPrice : parsedPrice
            );
            const pricePointId = matchedPricePoint.pricePointId || null;

            const basePayload = {
                reference_name: referenceName,
                cleared_for_sale: Boolean(appleClearedForSaleCheckbox?.checked),
                family_sharable: Boolean(appleFamilySharableCheckbox?.checked),
                review_note: (appleReviewNoteInput?.value || '').trim() || null,
                price_krw: resolvedPrice ?? parsedPrice,
                price_point_id: pricePointId,
                base_territory: (appleBaseTerritoryInput?.value || 'KOR').trim().toUpperCase(),
                localizations,
            };
            let endpoint = '/api/apple/inapp/create';
            let method = 'POST';
            let payload = {
                product_id: productId,
                reference_name: referenceName,
                purchase_type: applePurchaseTypeSelect?.value || 'consumable',
                cleared_for_sale: basePayload.cleared_for_sale,
                family_sharable: basePayload.family_sharable,
                review_note: basePayload.review_note,
                price_krw: basePayload.price_krw,
                price_point_id: basePayload.price_point_id,
                base_territory: basePayload.base_territory,
                localizations,
            };
            if (mode === 'edit') {
                endpoint = `/api/apple/inapp/${encodeURIComponent(productId)}`;
                method = 'PUT';
                payload = basePayload;
            } else if (!payload.purchase_type) {
                if (appleFormStatus) appleFormStatus.textContent = '인앱 상품 타입을 선택해주세요.';
                return;
            }
            if (appleSubmitBtn) {
                appleSubmitBtn.disabled = true;
                appleSubmitBtn.textContent = '저장 중...';
            }
            if (appleFormStatus) {
                appleFormStatus.textContent = mode === 'edit' ? '상품을 수정하는 중입니다...' : '상품을 생성하는 중입니다...';
            }
            try {
                const res = await fetch(endpoint, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const responseData = await res.json().catch(() => ({}));
                if (!res.ok) {
                    const detail = Array.isArray(responseData?.detail)
                        ? responseData.detail.map((entry) => entry.msg || entry.detail).filter(Boolean).join(', ')
                        : responseData?.detail || responseData?.message;
                    throw new Error(detail || '요청이 실패했습니다.');
                }
                if (appleFormStatus) appleFormStatus.textContent = '저장되었습니다.';
                resetAppleForm();
                const createdItem = responseData?.item;
                if (createdItem && typeof createdItem === 'object') {
                    upsertAppleStateItem(createdItem);
                }
                // 수정 후 목록 새로고침하여 캐시된 최신 정보 반영
                if (mode === 'edit') {
                    // 수정 모드인 경우 목록 새로고침 (캐시된 최신 정보 반영)
                    await fetchAppleList({ refresh: false });
                } else {
                    // 생성 모드인 경우 기존 로직 유지
                    renderAppleTable();
                }
            } catch (error) {
                if (appleFormStatus) appleFormStatus.textContent = error.message;
            } finally {
                if (appleSubmitBtn) {
                    appleSubmitBtn.disabled = false;
                    appleSubmitBtn.textContent = '저장';
                }
            }
        }

        function ensureAppleInitialized() {
            if (appleState.initialized) {
                return;
            }
            appleState.initialized = true;
            resetAppleForm();
            loadApplePricePoints(appleBaseTerritoryInput?.value || 'KOR', { quiet: true });
            fetchAppleList();
            loadAppleConfig().then(() => {
                resetAppleForm();
            });
        }

        // Suppress browser extension errors that don't affect app functionality
        window.addEventListener('error', function(e) {
            // Suppress "message channel closed" errors from browser extensions
            if (e.message && e.message.includes('message channel closed')) {
                e.stopImmediatePropagation();
                e.preventDefault();
                return false;
            }
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            // Suppress promise rejection errors from browser extensions
            if (e.reason && e.reason.message && e.reason.message.includes('message channel closed')) {
                e.stopImmediatePropagation();
                e.preventDefault();
                return false;
            }
        });

        appleRefreshBtn?.addEventListener('click', () => fetchAppleList({ refresh: true }));
        
        // Fix 버튼: 빈 데이터가 있는 IAP만 fetch (병렬 처리)
        async function handleAppleFix() {
            if (!appleFixBtn) return;
            const items = appleState.items || [];
            const itemsToFix = items.filter(item => {
                const productId = item.productId || item.sku || '';
                const type = item.type || '';
                const state = item.state || '';
                const priceTier = item.priceTier || '';
                const krwPrice = item.krwPrice;
                // 빈 데이터가 있는 항목만 선택
                return !productId || !type || !state || (!priceTier && !krwPrice);
            });
            
            if (itemsToFix.length === 0) {
                if (appleStatusEl) appleStatusEl.textContent = '수정할 항목이 없습니다.';
                return;
            }
            
            if (appleStatusEl) appleStatusEl.textContent = `${itemsToFix.length}개의 항목을 수정하는 중...`;
            if (appleLoadingEl) appleLoadingEl.hidden = false;
            if (appleLoadingBar) appleLoadingBar.style.width = '0%';
            
            // 병렬 처리 (최대 10개씩 동시 처리)
            const BATCH_SIZE = 10;
            let fixed = 0;
            let failed = 0;
            
            for (let i = 0; i < itemsToFix.length; i += BATCH_SIZE) {
                const batch = itemsToFix.slice(i, i + BATCH_SIZE);
                
                // 배치 병렬 처리
                const promises = batch.map(async (item) => {
                    const productId = item.productId || item.sku || '';
                    if (!productId) return { success: false, productId };
                    
                    try {
                        // Fix 버튼에서는 가격 정보만 가져오고 proceeds/tier는 제외
                        const res = await fetch(`/api/apple/inapp/${encodeURIComponent(productId)}/detail?skip_price_details=true`);
                        if (res.ok) {
                            return { success: true, productId };
                        } else {
                            return { success: false, productId };
                        }
                    } catch (error) {
                        console.error(`Failed to fix item ${productId}:`, error);
                        return { success: false, productId };
                    }
                });
                
                const results = await Promise.all(promises);
                
                // 결과 집계
                results.forEach(result => {
                    if (result.success) {
                        fixed++;
                    } else {
                        failed++;
                    }
                });
                
                // 진행률 업데이트
                const processed = i + batch.length;
                const percent = Math.round((processed / itemsToFix.length) * 100);
                if (appleLoadingBar) appleLoadingBar.style.width = `${percent}%`;
                if (appleStatusEl) {
                    appleStatusEl.textContent = `수정 중... ${processed}/${itemsToFix.length}개 (${percent}%) - 성공: ${fixed}, 실패: ${failed}`;
                }
            }
            
            // 목록 다시 불러오기 (캐시된 최신 정보 반영)
            await fetchAppleList({ refresh: false });
            if (appleStatusEl) appleStatusEl.textContent = `${fixed}개의 항목을 수정했습니다.${failed > 0 ? ` (${failed}개 실패)` : ''}`;
            if (appleLoadingEl) appleLoadingEl.hidden = true;
        }
        appleFixBtn?.addEventListener('click', handleAppleFix);
        
        // Apple CSV 벌크 등록 기능
        async function handleAppleSampleDownload() {
            if (!appleSampleDownloadBtn) return;
            try {
                appleSampleDownloadBtn.disabled = true;
                const res = await fetch('/api/apple/inapp/bulk-create/sample');
                if (!res.ok) {
                    throw new Error('샘플 CSV 다운로드에 실패했습니다.');
                }
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const contentDisposition = res.headers.get('Content-Disposition');
                let filename = 'apple-iap-bulk-create-sample.csv';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="?([^"]+)"?/);
                    if (match) {
                        filename = match[1];
                    }
                }
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                if (appleImportStatus) appleImportStatus.textContent = '샘플 CSV 파일을 다운로드했습니다.';
            } catch (error) {
                if (appleImportStatus) appleImportStatus.textContent = error.message;
            } finally {
                if (appleSampleDownloadBtn) appleSampleDownloadBtn.disabled = false;
            }
        }
        
        async function handleAppleImportPreview() {
            if (!appleImportPreviewBtn || !appleImportFile) return;
            const file = appleImportFile.files[0];
            if (!file) {
                if (appleImportStatus) appleImportStatus.textContent = 'CSV 파일을 선택해주세요.';
                return;
            }
            
            appleImportPreviewBtn.disabled = true;
            if (appleImportApplyBtn) appleImportApplyBtn.disabled = true;
            if (appleImportStatus) appleImportStatus.textContent = 'CSV 파일을 분석하는 중...';
            if (appleImportPreview) appleImportPreview.innerHTML = '';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const res = await fetch('/api/apple/inapp/import/preview', {
                    method: 'POST',
                    body: formData,
                });
                
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((entry) => entry.msg || entry.detail).filter(Boolean).join(', ')
                        : err.detail || err.message;
                    throw new Error(detail || 'CSV 파일 분석에 실패했습니다.');
                }
                
                const data = await res.json();
                pendingAppleOperations = data.operations || [];
                
                // 미리보기 렌더링
                renderAppleImportPreview(data, appleImportPreview);
                
                if (appleImportStatus) {
                    const summary = data.summary || {};
                    const parts = [];
                    if (summary.create) parts.push(`등록 예정 ${summary.create}건`);
                    if (summary.duplicate) parts.push(`중복 무시 ${summary.duplicate}건`);
                    if (summary.invalid) parts.push(`오류 ${summary.invalid}건`);
                    appleImportStatus.textContent = parts.length 
                        ? parts.join(', ') + '입니다.'
                        : '등록할 항목이 없습니다.';
                }
                
                // 중복 및 오류 항목 표시
                if (data.duplicate_items && data.duplicate_items.length > 0) {
                    const duplicateMsg = document.createElement('p');
                    duplicateMsg.className = 'hint';
                    duplicateMsg.style.color = '#ff9800';
                    duplicateMsg.textContent = `중복 항목 (무시됨): ${data.duplicate_items.map(item => item.product_id).join(', ')}`;
                    if (appleImportPreview) {
                        appleImportPreview.insertBefore(duplicateMsg, appleImportPreview.firstChild);
                    }
                }
                if (data.invalid_items && data.invalid_items.length > 0) {
                    const invalidMsg = document.createElement('p');
                    invalidMsg.className = 'hint';
                    invalidMsg.style.color = '#f44336';
                    invalidMsg.textContent = `오류 항목: ${data.invalid_items.map(item => `${item.product_id || 'N/A'} (${item.reason})`).join(', ')}`;
                    if (appleImportPreview) {
                        appleImportPreview.insertBefore(invalidMsg, appleImportPreview.firstChild);
                    }
                }
                
                if (appleImportApplyBtn) {
                    appleImportApplyBtn.disabled = !pendingAppleOperations.length;
                }
            } catch (error) {
                if (appleImportStatus) appleImportStatus.textContent = error.message;
                if (appleImportPreview) appleImportPreview.innerHTML = '';
                pendingAppleOperations = [];
            } finally {
                appleImportPreviewBtn.disabled = false;
            }
        }
        
        function renderAppleImportPreview(data, targetElement) {
            if (!targetElement) return;
            // Clear existing content but keep duplicate/invalid messages if they exist
            const existingMessages = targetElement.querySelectorAll('.hint[style*="color"]');
            targetElement.innerHTML = '';
            existingMessages.forEach(msg => targetElement.appendChild(msg));
            
            const operations = data?.operations || [];
            const summary = data?.summary || {};
            
            if (!operations.length) {
                const message = document.createElement('p');
                message.className = 'hint';
                message.textContent = '등록할 항목이 없습니다.';
                targetElement.appendChild(message);
                return;
            }
            
            const summaryText = document.createElement('p');
            summaryText.className = 'operation-header';
            summaryText.textContent = `등록 예정: ${operations.length}건`;
            targetElement.appendChild(summaryText);
            
            const groupSection = document.createElement('div');
            groupSection.className = 'preview-group';
            const heading = document.createElement('h3');
            heading.textContent = `등록 예정 (${operations.length})`;
            groupSection.appendChild(heading);
            const list = document.createElement('ul');
            list.className = 'operation-list';
            
            operations.forEach((op) => {
                const item = document.createElement('li');
                item.className = 'operation-create';
                const header = document.createElement('div');
                header.className = 'operation-header';
                const strong = document.createElement('strong');
                strong.textContent = op.product_id || 'Unknown';
                header.appendChild(strong);
                
                if (op.data) {
                    const refName = op.data.reference_name || '';
                    if (refName) {
                        header.appendChild(document.createTextNode(` - ${refName}`));
                    }
                }
                
                item.appendChild(header);
                list.appendChild(item);
            });
            
            groupSection.appendChild(list);
            targetElement.appendChild(groupSection);
        }
        
        async function handleAppleImportApply() {
            if (!appleImportApplyBtn || !pendingAppleOperations.length) return;
            
            appleImportApplyBtn.disabled = true;
            if (appleImportStatus) appleImportStatus.textContent = '변경 사항을 적용하는 중...';
            if (appleImportProgress) appleImportProgress.hidden = false;
            if (appleImportProgressBar) appleImportProgressBar.style.width = '0%';
            
            try {
                const res = await fetch('/api/apple/inapp/import/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operations: pendingAppleOperations }),
                });
                
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((entry) => entry.msg || entry.detail).filter(Boolean).join(', ')
                        : err.detail || err.message;
                    throw new Error(detail || '적용에 실패했습니다.');
                }
                
                const data = await res.json();
                const summary = data.summary || {};
                const success = data.success_items || [];
                const failed = data.failed_items || [];
                const duplicate = data.duplicate_items || [];
                
                if (appleImportStatus) {
                    const parts = [];
                    if (summary.create) parts.push(`성공 ${summary.create}건`);
                    if (summary.duplicate) parts.push(`중복 무시 ${summary.duplicate}건`);
                    if (summary.failed) parts.push(`실패 ${summary.failed}건`);
                    appleImportStatus.textContent = parts.length 
                        ? parts.join(', ') + ' 완료되었습니다.'
                        : '적용이 완료되었습니다.';
                }
                
                // 결과 상세 표시
                if (appleImportPreview) {
                    appleImportPreview.innerHTML = '';
                    
                    // 성공 항목
                    if (success.length > 0) {
                        const successSection = document.createElement('div');
                        successSection.className = 'preview-group';
                        const successHeading = document.createElement('h3');
                        successHeading.textContent = `성공 (${success.length}건)`;
                        successHeading.style.color = '#4caf50';
                        successSection.appendChild(successHeading);
                        const successList = document.createElement('ul');
                        successList.className = 'operation-list';
                        success.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = `${item.product_id} (행 ${item.row})`;
                            successList.appendChild(li);
                        });
                        successSection.appendChild(successList);
                        appleImportPreview.appendChild(successSection);
                    }
                    
                    // 중복 항목
                    if (duplicate.length > 0) {
                        const duplicateSection = document.createElement('div');
                        duplicateSection.className = 'preview-group';
                        const duplicateHeading = document.createElement('h3');
                        duplicateHeading.textContent = `중복 무시 (${duplicate.length}건)`;
                        duplicateHeading.style.color = '#ff9800';
                        duplicateSection.appendChild(duplicateHeading);
                        const duplicateList = document.createElement('ul');
                        duplicateList.className = 'operation-list';
                        duplicate.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = `${item.product_id} (행 ${item.row}) - 이미 등록된 상품입니다.`;
                            duplicateList.appendChild(li);
                        });
                        duplicateSection.appendChild(duplicateList);
                        appleImportPreview.appendChild(duplicateSection);
                    }
                    
                    // 실패 항목
                    if (failed.length > 0) {
                        const failedSection = document.createElement('div');
                        failedSection.className = 'preview-group';
                        const failedHeading = document.createElement('h3');
                        failedHeading.textContent = `실패 (${failed.length}건)`;
                        failedHeading.style.color = '#f44336';
                        failedSection.appendChild(failedHeading);
                        const failedList = document.createElement('ul');
                        failedList.className = 'operation-list';
                        failed.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = `${item.product_id || 'N/A'} (행 ${item.row}) - ${item.error || '알 수 없는 오류'}`;
                            failedList.appendChild(li);
                        });
                        failedSection.appendChild(failedList);
                        appleImportPreview.appendChild(failedSection);
                    }
                }
                
                pendingAppleOperations = [];
                if (appleImportFile) appleImportFile.value = '';
                
                // 목록 새로고침
                await fetchAppleList({ refresh: false });
            } catch (error) {
                if (appleImportStatus) appleImportStatus.textContent = error.message;
            } finally {
                appleImportApplyBtn.disabled = false;
                if (appleImportProgress) appleImportProgress.hidden = true;
            }
        }
        
        appleSampleDownloadBtn?.addEventListener('click', handleAppleSampleDownload);
        appleImportPreviewBtn?.addEventListener('click', handleAppleImportPreview);
        appleImportApplyBtn?.addEventListener('click', handleAppleImportApply);
        
        appleBulkDeletePreviewBtn?.addEventListener('click', handleAppleBulkDeletePreview);
        appleBulkDeleteApplyBtn?.addEventListener('click', handleAppleBulkDeleteApply);
        appleAddLocaleBtn?.addEventListener('click', () => addAppleLocalization());
        appleForm?.addEventListener('submit', handleAppleSubmit);
        appleResetBtn?.addEventListener('click', () => {
            setTimeout(() => resetAppleForm(), 0);
        });
        appleBaseTerritoryInput?.addEventListener('change', () => {
            const territory = (appleBaseTerritoryInput.value || 'KOR').trim();
            loadApplePricePoints(territory).then(() => {
                if (applePriceKrwInput?.value) {
                    applyApplePriceInput(applePriceKrwInput.value);
                }
            });
        });
        applePriceKrwInput?.addEventListener('input', (event) => {
            applyApplePriceInput(event.target.value, { silent: true });
        });
        applePriceKrwInput?.addEventListener('change', (event) => {
            applyApplePriceInput(event.target.value);
        });
        applePriceKrwInput?.addEventListener('blur', (event) => {
            applyApplePriceInput(event.target.value);
        });

        // Apple IAP Cleanup functionality
        const appleCleanupRefreshBtn = document.getElementById('apple-cleanup-refresh-btn');
        const appleCleanupTabButtons = document.querySelectorAll('[data-apple-cleanup-tab]');
        const appleCleanupViewCleanup = document.getElementById('apple-cleanup-view-cleanup');
        const appleCleanupViewProtected = document.getElementById('apple-cleanup-view-protected');
        const appleCleanupTableBody = document.getElementById('apple-cleanup-table-body');
        const appleCleanupTableWrapper = document.getElementById('apple-cleanup-table-wrapper');
        const appleCleanupEmptyState = document.getElementById('apple-cleanup-empty-state');
        const appleCleanupStatus = document.getElementById('apple-cleanup-status');
        const appleCleanupTotal = document.getElementById('apple-cleanup-total');
        const appleCleanupSelected = document.getElementById('apple-cleanup-selected');
        const appleCleanupSelectAll = document.getElementById('apple-cleanup-select-all');
        const appleCleanupRemoveSaleBtn = document.getElementById('apple-cleanup-remove-sale-btn');
        const appleCleanupDeleteBtn = document.getElementById('apple-cleanup-delete-btn');
        const appleCleanupProtectBtn = document.getElementById('apple-cleanup-protect-btn');
        const appleCleanupActions = document.getElementById('apple-cleanup-actions');
        const appleCleanupGoogleOnlyContainer = document.getElementById('apple-cleanup-google-only-container');
        const appleCleanupGoogleOnlyCount = document.getElementById('apple-cleanup-google-only-count');
        const appleCleanupGoogleOnlyBody = document.getElementById('apple-cleanup-google-only-body');
        const appleCleanupPageSizeSelect = document.getElementById('apple-cleanup-page-size');
        const appleCleanupPrevBtn = document.getElementById('apple-cleanup-prev-btn');
        const appleCleanupNextBtn = document.getElementById('apple-cleanup-next-btn');
        const appleCleanupPageInfo = document.getElementById('apple-cleanup-page-info');
        const appleCleanupIndexHeader = document.getElementById('apple-cleanup-index-header');

        const appleProtectedTableBody = document.getElementById('apple-protected-table-body');
        const appleProtectedTableWrapper = document.getElementById('apple-protected-table-wrapper');
        const appleProtectedEmptyState = document.getElementById('apple-protected-empty-state');
        const appleProtectedActions = document.getElementById('apple-protected-actions');
        const appleProtectedSelectAll = document.getElementById('apple-protected-select-all');
        const appleProtectedSelected = document.getElementById('apple-protected-selected');
        const appleProtectedUnprotectBtn = document.getElementById('apple-protected-unprotect-btn');
        const appleProtectedPageSizeSelect = document.getElementById('apple-protected-page-size');
        const appleProtectedPrevBtn = document.getElementById('apple-protected-prev-btn');
        const appleProtectedNextBtn = document.getElementById('apple-protected-next-btn');
        const appleProtectedPageInfo = document.getElementById('apple-protected-page-info');
        const appleProtectedIndexHeader = document.getElementById('apple-protected-index-header');
        const appleProtectedTotal = document.getElementById('apple-protected-total');

        const appleCleanupState = {
            activeTab: 'cleanup',
            items: [],
            protectedItems: [],
            googleOnly: [],
            checkedIds: new Set(),
            protectedCheckedIds: new Set(),
            sortDirection: 'asc',
            protectedSortDirection: 'asc',
            pageSize: 50,
            protectedPageSize: 50,
            page: 0,
            protectedPage: 0,
        };

        function setAppleCleanupTab(tab) {
            if (!tab || appleCleanupState.activeTab === tab) return;
            appleCleanupState.activeTab = tab;
            appleCleanupTabButtons.forEach((button) => {
                if (button.dataset.appleCleanupTab === tab) {
                    button.classList.add('is-active');
                } else {
                    button.classList.remove('is-active');
                }
            });
            renderAppleCleanupView();
        }

        function getSortedItems(items, direction) {
            if (direction === 'desc') {
                return [...items].reverse();
            }
            return [...items];
        }

        function getPageCount(total, pageSize) {
            if (pageSize === 'all') {
                return total > 0 ? 1 : 0;
            }
            if (total === 0) return 0;
            return Math.ceil(total / pageSize);
        }

        function clampPage(page, pageCount) {
            if (pageCount === 0) return 0;
            return Math.min(Math.max(page, 0), pageCount - 1);
        }

        function renderAppleCleanupView() {
            if (appleCleanupViewCleanup) {
                appleCleanupViewCleanup.hidden = appleCleanupState.activeTab !== 'cleanup';
            }
            if (appleCleanupViewProtected) {
                appleCleanupViewProtected.hidden = appleCleanupState.activeTab !== 'protected';
            }

            if (appleCleanupState.activeTab === 'cleanup') {
                renderAppleCleanupGoogleOnly();
                renderAppleCleanupTable();
                if (appleCleanupActions) {
                    appleCleanupActions.hidden = appleCleanupState.items.length === 0;
                }
            } else {
                if (appleCleanupGoogleOnlyContainer) {
                    appleCleanupGoogleOnlyContainer.hidden = true;
                }
                renderAppleProtectedTable();
                if (appleCleanupActions) {
                    appleCleanupActions.hidden = true;
                }
            }
        }

        function renderAppleCleanupTable() {
            if (!appleCleanupTableBody || !appleCleanupTableWrapper || !appleCleanupEmptyState) return;

            const items = getSortedItems(appleCleanupState.items, appleCleanupState.sortDirection);
            const total = items.length;
            const pageSize = appleCleanupState.pageSize;
            const pageCount = getPageCount(total, pageSize);
            appleCleanupState.page = clampPage(appleCleanupState.page, pageCount);

            const pageIndex = pageCount === 0 ? 0 : appleCleanupState.page;
            const sliceStart = pageSize === 'all' ? 0 : pageIndex * pageSize;
            const sliceEnd = pageSize === 'all' ? total : sliceStart + pageSize;
            const pageItems = pageSize === 'all' ? items : items.slice(sliceStart, sliceEnd);

            appleCleanupTableBody.innerHTML = '';

            if (total === 0) {
                appleCleanupTableWrapper.hidden = true;
                appleCleanupEmptyState.hidden = false;
                if (appleCleanupTotal) appleCleanupTotal.textContent = '0';
                if (appleCleanupSelected) appleCleanupSelected.textContent = '0';
                if (appleCleanupPageInfo) appleCleanupPageInfo.textContent = '0 / 0';
                if (appleCleanupPrevBtn) appleCleanupPrevBtn.disabled = true;
                if (appleCleanupNextBtn) appleCleanupNextBtn.disabled = true;
                updateCleanupSelectAllState();
                return;
            }

            appleCleanupTableWrapper.hidden = false;
            appleCleanupEmptyState.hidden = true;
            if (appleCleanupTotal) appleCleanupTotal.textContent = String(total);
            updateCleanupSelectedCount();
            updateCleanupSelectAllState();

            pageItems.forEach((item, idx) => {
                const productId = item.productId || item.sku || '';
                const type = item.type || '';
                const state = item.state || '';
                const isChecked = appleCleanupState.checkedIds.has(productId);
                const displayIndex = (pageSize === 'all' ? idx : sliceStart + idx) + 1;

                const tr = document.createElement('tr');

                const checkboxTd = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = isChecked;
                checkbox.dataset.productId = productId;
                checkbox.addEventListener('change', (e) => {
                    const pid = e.target.dataset.productId;
                    if (e.target.checked) {
                        appleCleanupState.checkedIds.add(pid);
                    } else {
                        appleCleanupState.checkedIds.delete(pid);
                    }
                    updateCleanupSelectAllState();
                    updateCleanupSelectedCount();
                });
                checkboxTd.appendChild(checkbox);
                tr.appendChild(checkboxTd);

                const indexTd = document.createElement('td');
                indexTd.textContent = String(displayIndex);
                tr.appendChild(indexTd);

                const idTd = document.createElement('td');
                idTd.textContent = productId;
                tr.appendChild(idTd);

                const typeTd = document.createElement('td');
                typeTd.textContent = type;
                tr.appendChild(typeTd);

                const stateTd = document.createElement('td');
                stateTd.textContent = state;
                tr.appendChild(stateTd);

                const priceTd = document.createElement('td');
                if (item.krwPrice && item.krwPrice.currency && item.krwPrice.customerPrice) {
                    priceTd.textContent = `${item.krwPrice.currency} ${item.krwPrice.customerPrice}`;
                } else {
                    priceTd.textContent = '-';
                }
                tr.appendChild(priceTd);

                appleCleanupTableBody.appendChild(tr);
            });

            if (appleCleanupPageInfo) {
                const currentDisplay = pageCount === 0 ? 0 : pageIndex + 1;
                const totalDisplay = pageCount === 0 ? 0 : pageCount;
                appleCleanupPageInfo.textContent = `${currentDisplay} / ${totalDisplay}`;
            }

            if (appleCleanupPrevBtn) {
                appleCleanupPrevBtn.disabled = pageCount <= 1 || pageSize === 'all' || pageIndex === 0;
            }
            if (appleCleanupNextBtn) {
                appleCleanupNextBtn.disabled = pageCount <= 1 || pageSize === 'all' || pageIndex >= pageCount - 1;
            }
        }

        function renderAppleCleanupGoogleOnly() {
            if (!appleCleanupGoogleOnlyContainer || !appleCleanupGoogleOnlyBody || !appleCleanupGoogleOnlyCount) return;

            if (appleCleanupState.activeTab !== 'cleanup' || !appleCleanupState.googleOnly.length) {
                appleCleanupGoogleOnlyContainer.hidden = true;
                appleCleanupGoogleOnlyBody.innerHTML = '';
                appleCleanupGoogleOnlyCount.textContent = '0';
                return;
            }

            appleCleanupGoogleOnlyContainer.hidden = false;
            appleCleanupGoogleOnlyCount.textContent = String(appleCleanupState.googleOnly.length);
            appleCleanupGoogleOnlyBody.innerHTML = '';

            appleCleanupState.googleOnly.forEach((item) => {
                const sku = item.sku || '-';
                const status = item.status || '-';
                const defaultLanguage = item.default_language || '-';
                let defaultTitle = '-';
                if (item.listings) {
                    const listing = item.listings[defaultLanguage] || Object.values(item.listings)[0];
                    if (listing && listing.title) {
                        defaultTitle = listing.title;
                    }
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${sku}</td>
                    <td>${status}</td>
                    <td>${defaultLanguage}</td>
                    <td>${defaultTitle}</td>
                `;
                appleCleanupGoogleOnlyBody.appendChild(tr);
            });
        }

        function renderAppleProtectedTable() {
            if (!appleProtectedTableBody || !appleProtectedTableWrapper || !appleProtectedEmptyState) return;

            const items = getSortedItems(appleCleanupState.protectedItems, appleCleanupState.protectedSortDirection);
            const total = items.length;
            const pageSize = appleCleanupState.protectedPageSize;
            const pageCount = getPageCount(total, pageSize);
            appleCleanupState.protectedPage = clampPage(appleCleanupState.protectedPage, pageCount);

            const pageIndex = pageCount === 0 ? 0 : appleCleanupState.protectedPage;
            const sliceStart = pageSize === 'all' ? 0 : pageIndex * pageSize;
            const sliceEnd = pageSize === 'all' ? total : sliceStart + pageSize;
            const pageItems = pageSize === 'all' ? items : items.slice(sliceStart, sliceEnd);

            appleProtectedTableBody.innerHTML = '';

            if (total === 0) {
                appleProtectedTableWrapper.hidden = true;
                appleProtectedEmptyState.hidden = false;
                if (appleProtectedTotal) appleProtectedTotal.textContent = '0';
                if (appleProtectedSelected) appleProtectedSelected.textContent = '0';
                if (appleProtectedPageInfo) appleProtectedPageInfo.textContent = '0 / 0';
                if (appleProtectedPrevBtn) appleProtectedPrevBtn.disabled = true;
                if (appleProtectedNextBtn) appleProtectedNextBtn.disabled = true;
                if (appleProtectedActions) appleProtectedActions.hidden = true;
                updateProtectedSelectAllState();
                return;
            }

            appleProtectedTableWrapper.hidden = false;
            appleProtectedEmptyState.hidden = true;
            if (appleProtectedTotal) appleProtectedTotal.textContent = String(total);
            if (appleProtectedActions) appleProtectedActions.hidden = false;
            updateProtectedSelectedCount();
            updateProtectedSelectAllState();

            pageItems.forEach((item, idx) => {
                const productId = item.productId || item.sku || '';
                const type = item.type || '';
                const state = item.state || '';
                const isChecked = appleCleanupState.protectedCheckedIds.has(productId);
                const displayIndex = (pageSize === 'all' ? idx : sliceStart + idx) + 1;

                const tr = document.createElement('tr');

                const checkboxTd = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = isChecked;
                checkbox.dataset.productId = productId;
                checkbox.addEventListener('change', (e) => {
                    const pid = e.target.dataset.productId;
                    if (e.target.checked) {
                        appleCleanupState.protectedCheckedIds.add(pid);
                    } else {
                        appleCleanupState.protectedCheckedIds.delete(pid);
                    }
                    updateProtectedSelectAllState();
                    updateProtectedSelectedCount();
                });
                checkboxTd.appendChild(checkbox);
                tr.appendChild(checkboxTd);

                const indexTd = document.createElement('td');
                indexTd.textContent = String(displayIndex);
                tr.appendChild(indexTd);

                const idTd = document.createElement('td');
                idTd.textContent = productId;
                tr.appendChild(idTd);

                const typeTd = document.createElement('td');
                typeTd.textContent = type;
                tr.appendChild(typeTd);

                const stateTd = document.createElement('td');
                stateTd.textContent = state;
                tr.appendChild(stateTd);

                const priceTd = document.createElement('td');
                if (item.krwPrice && item.krwPrice.currency && item.krwPrice.customerPrice) {
                    priceTd.textContent = `${item.krwPrice.currency} ${item.krwPrice.customerPrice}`;
                } else {
                    priceTd.textContent = '-';
                }
                tr.appendChild(priceTd);

                appleProtectedTableBody.appendChild(tr);
            });

            if (appleProtectedPageInfo) {
                const currentDisplay = pageCount === 0 ? 0 : pageIndex + 1;
                const totalDisplay = pageCount === 0 ? 0 : pageCount;
                appleProtectedPageInfo.textContent = `${currentDisplay} / ${totalDisplay}`;
            }

            if (appleProtectedPrevBtn) {
                appleProtectedPrevBtn.disabled = pageCount <= 1 || pageSize === 'all' || pageIndex === 0;
            }
            if (appleProtectedNextBtn) {
                appleProtectedNextBtn.disabled = pageCount <= 1 || pageSize === 'all' || pageIndex >= pageCount - 1;
            }
        }

        function updateCleanupSelectAllState() {
            if (!appleCleanupSelectAll) return;

            const total = appleCleanupState.items.length;
            if (total === 0) {
                appleCleanupSelectAll.checked = false;
                appleCleanupSelectAll.indeterminate = false;
                return;
            }

            const checkedCount = appleCleanupState.checkedIds.size;
            if (checkedCount === 0) {
                appleCleanupSelectAll.checked = false;
                appleCleanupSelectAll.indeterminate = false;
            } else if (checkedCount === total) {
                appleCleanupSelectAll.checked = true;
                appleCleanupSelectAll.indeterminate = false;
            } else {
                appleCleanupSelectAll.checked = false;
                appleCleanupSelectAll.indeterminate = true;
            }
        }

        function updateCleanupSelectedCount() {
            if (!appleCleanupSelected) return;
            appleCleanupSelected.textContent = String(appleCleanupState.checkedIds.size);
        }

        function updateProtectedSelectAllState() {
            if (!appleProtectedSelectAll) return;

            const total = appleCleanupState.protectedItems.length;
            if (total === 0) {
                appleProtectedSelectAll.checked = false;
                appleProtectedSelectAll.indeterminate = false;
                return;
            }

            const checkedCount = appleCleanupState.protectedCheckedIds.size;
            if (checkedCount === 0) {
                appleProtectedSelectAll.checked = false;
                appleProtectedSelectAll.indeterminate = false;
            } else if (checkedCount === total) {
                appleProtectedSelectAll.checked = true;
                appleProtectedSelectAll.indeterminate = false;
            } else {
                appleProtectedSelectAll.checked = false;
                appleProtectedSelectAll.indeterminate = true;
            }
        }

        function updateProtectedSelectedCount() {
            if (!appleProtectedSelected) return;
            appleProtectedSelected.textContent = String(appleCleanupState.protectedCheckedIds.size);
        }

        async function fetchAppleCleanupList() {
            if (!appleCleanupStatus) return;

            appleCleanupStatus.textContent = '목록을 불러오는 중...';
            appleCleanupStatus.className = 'status';

            try {
                const res = await fetch('/api/apple/inapp/orphaned');
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || '목록을 불러오는데 실패했습니다.');
                }

                const data = await res.json();
                appleCleanupState.items = data.items || [];
                appleCleanupState.googleOnly = data.googleOnly || [];
                appleCleanupState.protectedItems = data.protectedItems || [];
                appleCleanupState.checkedIds.clear();
                appleCleanupState.protectedCheckedIds.clear();
                appleCleanupState.page = 0;
                appleCleanupState.protectedPage = 0;

                appleCleanupStatus.textContent = `총 ${appleCleanupState.items.length}개의 IAP를 찾았습니다.`;
                appleCleanupStatus.className = 'status';

                renderAppleCleanupView();
            } catch (error) {
                appleCleanupStatus.textContent = `오류: ${error.message}`;
                appleCleanupStatus.className = 'status error';
                console.error('Failed to fetch orphaned IAPs:', error);
            }
        }

        appleCleanupTabButtons.forEach((button) => {
            button.addEventListener('click', () => {
                const tab = button.dataset.appleCleanupTab;
                setAppleCleanupTab(tab);
            });
        });

        appleCleanupSelectAll?.addEventListener('change', (e) => {
            const checked = e.target.checked;
            appleCleanupState.checkedIds.clear();

            if (checked) {
                appleCleanupState.items.forEach((item) => {
                    const productId = item.productId || item.sku || '';
                    if (productId) {
                        appleCleanupState.checkedIds.add(productId);
                    }
                });
            }

            appleCleanupTableBody?.querySelectorAll('input[type="checkbox"][data-product-id]').forEach((checkbox) => {
                checkbox.checked = checked;
            });

            updateCleanupSelectedCount();
            updateCleanupSelectAllState();
        });

        appleProtectedSelectAll?.addEventListener('change', (e) => {
            const checked = e.target.checked;
            appleCleanupState.protectedCheckedIds.clear();

            if (checked) {
                appleCleanupState.protectedItems.forEach((item) => {
                    const productId = item.productId || item.sku || '';
                    if (productId) {
                        appleCleanupState.protectedCheckedIds.add(productId);
                    }
                });
            }

            appleProtectedTableBody?.querySelectorAll('input[type="checkbox"][data-product-id]').forEach((checkbox) => {
                checkbox.checked = checked;
            });

            updateProtectedSelectedCount();
            updateProtectedSelectAllState();
        });

        appleCleanupPageSizeSelect?.addEventListener('change', () => {
            const value = appleCleanupPageSizeSelect.value;
            appleCleanupState.pageSize = value === 'all' ? 'all' : Number(value);
            appleCleanupState.page = 0;
            renderAppleCleanupTable();
        });

        appleCleanupPrevBtn?.addEventListener('click', () => {
            if (appleCleanupState.pageSize === 'all') return;
            if (appleCleanupState.page > 0) {
                appleCleanupState.page -= 1;
                renderAppleCleanupTable();
            }
        });

        appleCleanupNextBtn?.addEventListener('click', () => {
            if (appleCleanupState.pageSize === 'all') return;
            const items = appleCleanupState.items.length;
            const pageCount = getPageCount(items, appleCleanupState.pageSize);
            if (appleCleanupState.page < pageCount - 1) {
                appleCleanupState.page += 1;
                renderAppleCleanupTable();
            }
        });

        appleProtectedPageSizeSelect?.addEventListener('change', () => {
            const value = appleProtectedPageSizeSelect.value;
            appleCleanupState.protectedPageSize = value === 'all' ? 'all' : Number(value);
            appleCleanupState.protectedPage = 0;
            renderAppleProtectedTable();
        });

        appleProtectedPrevBtn?.addEventListener('click', () => {
            if (appleCleanupState.protectedPageSize === 'all') return;
            if (appleCleanupState.protectedPage > 0) {
                appleCleanupState.protectedPage -= 1;
                renderAppleProtectedTable();
            }
        });

        appleProtectedNextBtn?.addEventListener('click', () => {
            if (appleCleanupState.protectedPageSize === 'all') return;
            const items = appleCleanupState.protectedItems.length;
            const pageCount = getPageCount(items, appleCleanupState.protectedPageSize);
            if (appleCleanupState.protectedPage < pageCount - 1) {
                appleCleanupState.protectedPage += 1;
                renderAppleProtectedTable();
            }
        });

        appleCleanupIndexHeader?.addEventListener('click', () => {
            appleCleanupState.sortDirection = appleCleanupState.sortDirection === 'asc' ? 'desc' : 'asc';
            renderAppleCleanupTable();
        });

        appleProtectedIndexHeader?.addEventListener('click', () => {
            appleCleanupState.protectedSortDirection = appleCleanupState.protectedSortDirection === 'asc' ? 'desc' : 'asc';
            renderAppleProtectedTable();
        });

        appleCleanupRefreshBtn?.addEventListener('click', () => {
            appleCleanupState.checkedIds.clear();
            appleCleanupState.protectedCheckedIds.clear();
            fetchAppleCleanupList();
        });

        appleCleanupProtectBtn?.addEventListener('click', async () => {
            const productIds = Array.from(appleCleanupState.checkedIds);
            if (!productIds.length) {
                if (appleCleanupStatus) {
                    appleCleanupStatus.textContent = '보호할 IAP를 선택해주세요.';
                    appleCleanupStatus.className = 'status error';
                }
                return;
            }

            try {
                appleCleanupProtectBtn.disabled = true;
                appleCleanupProtectBtn.textContent = '보호 중...';
                const res = await fetch('/api/apple/inapp/cleanup/protect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_ids: productIds }),
                });
                if (!res.ok) {
                    const error = await res.json().catch(() => ({}));
                    throw new Error(error.detail || '보호에 실패했습니다.');
                }
                appleCleanupState.checkedIds.clear();
                fetchAppleCleanupList();
            } catch (error) {
                if (appleCleanupStatus) {
                    appleCleanupStatus.textContent = `오류: ${error.message}`;
                    appleCleanupStatus.className = 'status error';
                }
            } finally {
                appleCleanupProtectBtn.disabled = false;
                appleCleanupProtectBtn.textContent = '보호';
            }
        });

        appleProtectedUnprotectBtn?.addEventListener('click', async () => {
            const productIds = Array.from(appleCleanupState.protectedCheckedIds);
            if (!productIds.length) {
                if (appleCleanupStatus) {
                    appleCleanupStatus.textContent = '보호 해제할 IAP를 선택해주세요.';
                    appleCleanupStatus.className = 'status error';
                }
                return;
            }

            try {
                appleProtectedUnprotectBtn.disabled = true;
                appleProtectedUnprotectBtn.textContent = '처리 중...';
                const res = await fetch('/api/apple/inapp/cleanup/unprotect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_ids: productIds }),
                });
                if (!res.ok) {
                    const error = await res.json().catch(() => ({}));
                    throw new Error(error.detail || '보호 해제에 실패했습니다.');
                }
                appleCleanupState.protectedCheckedIds.clear();
                fetchAppleCleanupList();
            } catch (error) {
                if (appleCleanupStatus) {
                    appleCleanupStatus.textContent = `오류: ${error.message}`;
                    appleCleanupStatus.className = 'status error';
                }
            } finally {
                appleProtectedUnprotectBtn.disabled = false;
                appleProtectedUnprotectBtn.textContent = '보호 해제';
            }
        });

        appleCleanupRemoveSaleBtn?.addEventListener('click', () => {
            processAppleCleanup('remove_from_sale', '판매 중지');
        });

        appleCleanupDeleteBtn?.addEventListener('click', () => {
            processAppleCleanup('delete', '삭제');
        });

        // Load cleanup list when section is shown
        const appleCleanupSection = document.getElementById('apple-section-cleanup');
        if (appleCleanupSection) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === 'hidden') {
                        if (!appleCleanupSection.hidden && appleCleanupState.items.length === 0) {
                            fetchAppleCleanupList();
                        }
                    }
                });
            });
            observer.observe(appleCleanupSection, { attributes: true });
        }

        // Initialize cleanup tab view
        renderAppleCleanupView();

        storeToggleButtons.forEach((button) => {
            button.addEventListener('click', () => {
                const targetStore = button.dataset.store;
                if (targetStore) {
                    setActiveStore(targetStore);
                }
            });
        });

        exportBtn?.addEventListener('click', handleExportCsv);
        importPreviewBtn?.addEventListener('click', handleImportPreview);
        importApplyBtn?.addEventListener('click', handleImportApply);
        newTemplateBtn?.addEventListener('click', handleNewTemplateDownload);
        newImportPreviewBtn?.addEventListener('click', handleNewImportPreview);
        newImportApplyBtn?.addEventListener('click', handleNewImportApply);
        pageSizeSelect?.addEventListener('change', handlePageSizeChange);
        searchInput?.addEventListener('input', handleSearchInput);
        indexHeader?.addEventListener('dblclick', toggleIndexSort);
        indexHeader?.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                toggleIndexSort();
            }
        });

        editCancelBtn?.addEventListener('click', () => {
            closeEditDialog();
        });
        editDialog?.addEventListener('cancel', (event) => {
            event.preventDefault();
            closeEditDialog();
        });
        editForm?.addEventListener('submit', handleEditSubmit);

        async function initializeApp() {
            // IAP 벌크 관리 페이지에서는 자동으로 full fetch하지 않음
            // 사용자가 명시적으로 새로고침 버튼을 클릭할 때만 fetch
            // startInitialLoading(2);
            // await fetchTemplates({ showProgress: true });
            // await fetchList(undefined, { showProgress: true });
        }

        renderImportPreview({ operations: [], summary: { create: 0, update: 0, delete: 0 } }, importPreviewEl);
        renderImportPreview({ operations: [], summary: { create: 0, update: 0, delete: 0 } }, newImportPreviewEl);
        renderTemplateDetails(null);
        updateIndexHeaderIndicator();
        // 초기에는 스토어를 설정하지 않음 (초기 화면 표시)
        // setActiveStore(activeStore);
        initializeApp();
    </script>
</body>
</html>
