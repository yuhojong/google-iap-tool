<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IAP 관리자</title>
    <style>
        :root {
            color-scheme: light dark;
            font-family: 'Noto Sans KR', sans-serif;
        }
        body {
            margin: 0;
            background: #f5f5f5;
            color: #222;
        }
        header {
            background: #1a73e8;
            color: #fff;
            padding: 1.5rem;
            text-align: center;
        }
        main {
            display: grid;
            gap: 2rem;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
        }
        h1, h2 {
            margin: 0 0 1rem;
        }
        .table-wrapper {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th,
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
            vertical-align: top;
        }
        thead th {
            background: #eef3ff;
            font-weight: 700;
            color: #1a237e;
        }
        tbody tr:hover {
            background: #f8fbff;
        }
        .description-cell {
            max-width: 320px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .table-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .table-actions button {
            flex: 0 0 auto;
        }
        button.button-secondary {
            background: #5f6368;
        }
        button.button-danger {
            background: #d93025;
        }
        dialog {
            border: none;
            border-radius: 16px;
            padding: 0;
            max-width: 640px;
            width: min(640px, 92vw);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.4);
        }
        dialog form {
            display: grid;
            gap: 1rem;
            padding: 1.5rem;
        }
        .dialog-header {
            margin: 0;
        }
        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .dialog-actions button.button-secondary {
            background: #5f6368;
        }
        .dialog-hint {
            margin: 0;
            color: #555;
            font-weight: 400;
        }
        form {
            display: grid;
            gap: 1rem;
        }
        label,
        fieldset {
            display: grid;
            gap: 0.5rem;
            font-weight: 600;
        }
        fieldset {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
        }
        input, textarea {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        select {
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        button {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            background: #1a73e8;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
        }
        button[disabled] {
            background: #999;
            cursor: not-allowed;
        }
        .status {
            margin-top: 1rem;
            font-weight: 600;
        }
        .initial-loading {
            display: grid;
            gap: 0.75rem;
            background: #fff;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.06);
        }
        .initial-loading p {
            margin: 0;
            font-weight: 500;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 999px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #1a73e8, #4fc3f7);
            transition: width 0.3s ease;
        }
        .csv-actions {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
        }
        .csv-actions form {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.75rem;
        }
        .csv-actions input[type="file"] {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 0.5rem;
            background: #fff;
        }
        #import-preview {
            margin-top: 1rem;
            display: grid;
            gap: 1rem;
        }
        .preview-group {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
            background: #fafafa;
        }
        .preview-group h3 {
            margin: 0 0 0.5rem;
        }
        .operation-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 0.5rem;
        }
        .operation-create,
        .operation-update,
        .operation-delete {
            border-radius: 8px;
            padding: 0.75rem;
        }
        .operation-create {
            border-left: 4px solid #0f9d58;
            background: #f0fff4;
        }
        .operation-update {
            border-left: 4px solid #fbbc04;
            background: #fff8e1;
        }
        .operation-delete {
            border-left: 4px solid #d93025;
            background: #ffebee;
        }
        .operation-header {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .operation-details {
            margin: 0.25rem 0 0;
            padding-left: 1rem;
        }
        .operation-details ul {
            margin: 0.25rem 0 0;
            padding-left: 1.25rem;
        }
        .operation-details li {
            line-height: 1.4;
        }
        .translation-change-details {
            margin: 0.25rem 0 0.5rem 1rem;
            padding-left: 1.25rem;
        }
        .translation-change-details li {
            white-space: pre-wrap;
        }
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .page-size-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        .page-size-control select {
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 0.95rem;
        }
        .pagination {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .empty {
            padding: 1rem;
            text-align: center;
            color: #666;
        }
        .translations {
            display: grid;
            gap: 1rem;
        }
        .translations h3 {
            margin: 0;
        }
        .translation-card {
            border: 1px dashed #c5d9ff;
            border-radius: 10px;
            padding: 1rem;
            display: grid;
            gap: 0.75rem;
            background: #f8fbff;
        }
        .translation-card h4 {
            margin: 0;
        }
        .hint {
            color: #555;
            font-weight: 400;
            margin: 0;
        }
        .template-info {
            display: grid;
            gap: 0.75rem;
            background: #eef3ff;
            border: 1px solid #c5d9ff;
            border-radius: 10px;
            padding: 1rem;
        }
        .template-details h3 {
            margin: 0 0 0.5rem;
        }
        .template-details ul {
            margin: 0;
            padding-left: 1.25rem;
        }
        .template-details li {
            line-height: 1.6;
        }
        @media (max-width: 600px) {
            main {
                padding: 1rem;
            }
            header {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Google Play IAP 관리자</h1>
    </header>
    <main>
        <div id="initial-progress" class="initial-loading" hidden>
            <p id="initial-progress-text" class="hint">데이터를 불러오는 중...</p>
            <div class="progress-bar">
                <div id="initial-progress-bar" class="progress-bar-fill"></div>
            </div>
        </div>
        <section>
            <h2>CSV 대량 관리</h2>
            <div class="csv-actions">
                <button id="export-btn" type="button">CSV 내보내기</button>
                <form id="import-form">
                    <input type="file" id="import-file" name="file" accept=".csv" />
                    <button type="button" id="import-preview-btn">미리보기</button>
                    <button type="button" id="import-apply-btn" disabled>적용</button>
                </form>
            </div>
            <div id="import-status" class="status"></div>
            <div id="import-progress" class="initial-loading" hidden>
                <p id="import-progress-text" class="hint">변경 사항을 확인 중입니다</p>
                <div class="progress-bar">
                    <div id="import-progress-bar" class="progress-bar-fill"></div>
                </div>
            </div>
            <div id="import-preview"></div>
        </section>
        <section>
            <h2>등록된 상품</h2>
            <div id="iap-table-wrapper" class="table-wrapper" hidden>
                <table class="iap-table">
                    <thead>
                        <tr>
                            <th scope="col">SKU</th>
                            <th scope="col">이름</th>
                            <th scope="col">설명</th>
                            <th scope="col">기본 언어</th>
                            <th scope="col">가격</th>
                            <th scope="col">상태</th>
                            <th scope="col">작업</th>
                        </tr>
                    </thead>
                    <tbody id="iap-table-body"></tbody>
                </table>
            </div>
            <div id="empty-state" class="empty" hidden>등록된 상품이 없습니다.</div>
            <div class="pagination-controls">
                <label class="page-size-control" for="page-size-select">
                    페이지당 표시
                    <select id="page-size-select">
                        <option value="20">20개</option>
                        <option value="50" selected>50개</option>
                        <option value="100">100개</option>
                    </select>
                </label>
                <div class="pagination">
                    <button id="prev-btn" disabled>이전</button>
                    <button id="next-btn" disabled>다음</button>
                </div>
            </div>
        </section>
        <dialog id="edit-dialog">
            <form id="edit-form">
                <h3 class="dialog-header">상품 수정</h3>
                <label>상품 ID (SKU)
                    <input type="text" id="edit-sku" name="sku" readonly />
                </label>
                <label>기본 언어
                    <select id="edit-default-language" name="default_language" required></select>
                </label>
                <label>상태
                    <select id="edit-status-select" name="status" required></select>
                </label>
                <fieldset>
                    <legend>기본 가격</legend>
                    <label>priceMicros
                        <input type="text" id="edit-price-micros" name="price_micros" required />
                    </label>
                    <label>통화 코드
                        <input type="text" id="edit-price-currency" name="currency" maxlength="3" required />
                    </label>
                    <p class="hint dialog-hint">Google Play Console 형식과 동일한 마이크로 단위(priceMicros)를 입력하세요.</p>
                </fieldset>
                <div class="translations" id="edit-translations"></div>
                <div class="dialog-actions">
                    <button type="button" id="edit-cancel-btn" class="button-secondary">취소</button>
                    <button type="submit">저장</button>
                </div>
                <div id="edit-status-message" class="status"></div>
            </form>
        </dialog>
        <section>
            <h2>새 상품 만들기</h2>
            <form id="create-form">
                <label>상품 ID (SKU)
                    <input type="text" name="sku" required minlength="3" />
                </label>
                <label>기본 언어
                    <select name="default_language" required>
                        <option value="ko-KR" selected>한국어 (ko-KR)</option>
                        <option value="en-SG">영어 (en-SG)</option>
                        <option value="zh-TW">중국어 번체 (zh-TW)</option>
                    </select>
                </label>

                <div class="translations">
                    <h3>번역 정보</h3>
                    <p class="hint">언어별로 이름과 설명을 입력하세요. 기본 언어 항목은 필수입니다.</p>
                    <div class="translation-card" data-language="ko-KR">
                        <h4>한국어 (ko-KR)</h4>
                        <label>이름
                            <input type="text" name="title_ko-KR" minlength="1" />
                        </label>
                        <label>설명
                            <textarea name="description_ko-KR" rows="3"></textarea>
                        </label>
                    </div>
                    <div class="translation-card" data-language="en-SG">
                        <h4>영어 (en-SG)</h4>
                        <label>이름
                            <input type="text" name="title_en-SG" minlength="1" />
                        </label>
                        <label>설명
                            <textarea name="description_en-SG" rows="3"></textarea>
                        </label>
                    </div>
                    <div class="translation-card" data-language="zh-TW">
                        <h4>중국어 번체 (zh-TW)</h4>
                        <label>이름
                            <input type="text" name="title_zh-TW" minlength="1" />
                        </label>
                        <label>설명
                            <textarea name="description_zh-TW" rows="3"></textarea>
                        </label>
                    </div>
                </div>

                <label>가격 템플릿
                    <select name="price_template_id" id="price-template-select" required>
                        <option value="">가격 템플릿을 선택하세요</option>
                    </select>
                </label>
                <div class="template-info" id="template-info">
                    <p id="template-description" class="hint">가격 템플릿을 선택하면 지역별 가격이 표시됩니다.</p>
                    <div id="template-details" class="template-details" hidden>
                        <h3>지역별 가격</h3>
                        <ul id="template-region-list"></ul>
                    </div>
                </div>

                <button type="submit">상품 생성</button>
                <div id="form-status" class="status"></div>
            </form>
        </section>
    </main>
    <script>
        const tableWrapper = document.getElementById('iap-table-wrapper');
        const listEl = document.getElementById('iap-table-body');
        const emptyEl = document.getElementById('empty-state');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const pageSizeSelect = document.getElementById('page-size-select');
        const form = document.getElementById('create-form');
        const statusEl = document.getElementById('form-status');
        const submitBtn = form.querySelector('button[type="submit"]');
        const translationLanguages = ['ko-KR', 'en-SG', 'zh-TW'];
        const templateSelect = document.getElementById('price-template-select');
        const templateDescription = document.getElementById('template-description');
        const templateDetails = document.getElementById('template-details');
        const templateRegionList = document.getElementById('template-region-list');
        const templateMap = new Map();
        const exportBtn = document.getElementById('export-btn');
        const importForm = document.getElementById('import-form');
        const importFileInput = document.getElementById('import-file');
        const importPreviewBtn = document.getElementById('import-preview-btn');
        const importApplyBtn = document.getElementById('import-apply-btn');
        const importStatusEl = document.getElementById('import-status');
        const importPreviewEl = document.getElementById('import-preview');
        const importProgress = document.getElementById('import-progress');
        const importProgressText = document.getElementById('import-progress-text');
        const importProgressBar = document.getElementById('import-progress-bar');
        const editDialog = document.getElementById('edit-dialog');
        const editForm = document.getElementById('edit-form');
        const editSkuInput = document.getElementById('edit-sku');
        const editDefaultLanguageSelect = document.getElementById('edit-default-language');
        const editStatusSelect = document.getElementById('edit-status-select');
        const editPriceMicrosInput = document.getElementById('edit-price-micros');
        const editPriceCurrencyInput = document.getElementById('edit-price-currency');
        const editTranslationsContainer = document.getElementById('edit-translations');
        const editCancelBtn = document.getElementById('edit-cancel-btn');
        const editStatusMessage = document.getElementById('edit-status-message');
        const editSubmitBtn = editForm ? editForm.querySelector('button[type="submit"]') : null;
        const initialProgress = document.getElementById('initial-progress');
        const initialProgressText = document.getElementById('initial-progress-text');
        const initialProgressBar = document.getElementById('initial-progress-bar');

        const STATUS_OPTIONS = ['active', 'inactive', 'draft'];
        const STATUS_LABELS = {
            active: '활성',
            inactive: '비활성',
            draft: '초안',
        };
        const MAX_PAGE_SIZE = 200;

        const tokenStack = [];
        let currentToken = undefined;
        let nextToken = undefined;
        let pendingOperations = [];
        let editingItem = null;
        let initialLoadingActive = false;
        let initialStepsCompleted = 0;
        let initialStepsTotal = 0;
        let pageSize = 50;
        let importProgressTimer = null;
        let importProgressValue = 10;
        let importProgressDirection = 1;

        if (pageSizeSelect) {
            const parsed = Number(pageSizeSelect.value);
            if (Number.isFinite(parsed) && parsed > 0) {
                const normalized = Math.min(Math.max(Math.floor(parsed), 1), MAX_PAGE_SIZE);
                pageSize = normalized;
                if (normalized !== parsed) {
                    pageSizeSelect.value = String(normalized);
                }
            }
        }

        if (importForm) {
            importForm.addEventListener('submit', (event) => event.preventDefault());
        }

        function startInitialLoading(totalSteps) {
            initialLoadingActive = true;
            initialStepsTotal = totalSteps;
            initialStepsCompleted = 0;
            if (initialProgress) {
                initialProgress.hidden = false;
            }
            if (initialProgressBar) {
                initialProgressBar.style.width = '0%';
            }
            if (initialProgressText) {
                initialProgressText.textContent = '데이터를 불러오는 중...';
            }
        }

        function setInitialProgressMessage(message) {
            if (initialProgressText && message) {
                initialProgressText.textContent = message;
            }
        }

        function finishInitialStep({ success = true, message = '' } = {}) {
            if (!initialLoadingActive) {
                return;
            }
            if (!success) {
                if (message) {
                    setInitialProgressMessage(message);
                }
                if (initialProgressBar) {
                    initialProgressBar.style.width = '100%';
                }
                initialLoadingActive = false;
                return;
            }
            initialStepsCompleted += 1;
            const percent = Math.min(100, Math.round((initialStepsCompleted / initialStepsTotal) * 100));
            if (initialProgressBar) {
                initialProgressBar.style.width = `${percent}%`;
            }
            if (initialStepsCompleted >= initialStepsTotal) {
                if (initialProgressText) {
                    initialProgressText.textContent = '불러오기 완료';
                }
                setTimeout(() => {
                    if (initialProgress) {
                        initialProgress.hidden = true;
                    }
                    initialLoadingActive = false;
                }, 500);
            }
        }

        function startImportPreviewProgress(message = '변경 사항을 확인 중입니다') {
            if (importProgressTimer) {
                clearInterval(importProgressTimer);
            }
            importProgressValue = 10;
            importProgressDirection = 1;
            if (importProgress) {
                importProgress.hidden = false;
            }
            if (importProgressText) {
                importProgressText.textContent = message;
            }
            if (importProgressBar) {
                importProgressBar.style.width = `${importProgressValue}%`;
            }
            importProgressTimer = window.setInterval(() => {
                if (!importProgressBar) {
                    return;
                }
                importProgressValue += importProgressDirection * 5;
                if (importProgressValue >= 95) {
                    importProgressValue = 95;
                    importProgressDirection = -1;
                } else if (importProgressValue <= 10) {
                    importProgressValue = 10;
                    importProgressDirection = 1;
                }
                importProgressBar.style.width = `${importProgressValue}%`;
            }, 150);
        }

        function completeImportPreviewProgress({ message = '', isError = false } = {}) {
            if (importProgressTimer) {
                clearInterval(importProgressTimer);
                importProgressTimer = null;
            }
            if (importProgressBar) {
                importProgressBar.style.width = '100%';
            }
            if (importProgressText && message) {
                importProgressText.textContent = message;
            }
            const delay = isError ? 1000 : 500;
            if (importProgress) {
                window.setTimeout(() => {
                    if (importProgress) {
                        importProgress.hidden = true;
                    }
                }, delay);
            }
        }

        function formatPriceDisplay(price) {
            if (!price || !price.priceMicros) {
                return '-';
            }
            const microsNumber = Number(price.priceMicros);
            if (Number.isNaN(microsNumber)) {
                const currency = price.currency ? ` ${price.currency}` : '';
                return `${price.priceMicros}${currency}`.trim();
            }
            const amount = microsNumber / 1_000_000;
            const formatted = amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 6 });
            const currency = price.currency ? ` ${price.currency}` : '';
            return `${formatted}${currency}`.trim();
        }

        function buildRegionalPriceList(prices) {
            if (!prices) {
                return null;
            }
            const entries = Object.entries(prices);
            if (!entries.length) {
                return null;
            }
            const container = document.createElement('div');
            container.className = 'operation-details';
            const list = document.createElement('ul');
            entries
                .sort(([regionA], [regionB]) => regionA.localeCompare(regionB))
                .forEach(([region, pricePayload]) => {
                    const item = document.createElement('li');
                    item.textContent = `${region}: ${formatPriceDisplay(pricePayload)}`;
                    list.appendChild(item);
                });
            container.appendChild(document.createTextNode('지역 가격:'));
            container.appendChild(list);
            return container;
        }

        function ensureDialogOpen() {
            if (!editDialog) return;
            if (typeof editDialog.showModal === 'function') {
                try {
                    editDialog.showModal();
                } catch (error) {
                    editDialog.setAttribute('open', 'true');
                }
            } else {
                editDialog.setAttribute('open', 'true');
            }
        }

        function closeEditDialog() {
            if (!editDialog) return;
            if (typeof editDialog.close === 'function' && editDialog.open) {
                editDialog.close();
            } else {
                editDialog.removeAttribute('open');
            }
            editingItem = null;
            if (editStatusMessage) {
                editStatusMessage.textContent = '';
            }
            if (editTranslationsContainer) {
                editTranslationsContainer.innerHTML = '';
            }
            if (editForm) {
                editForm.reset();
            }
        }

        function populateStatusOptions(currentStatus) {
            if (!editStatusSelect) return;
            const normalized = (currentStatus || '').toLowerCase();
            const options = new Map();
            STATUS_OPTIONS.forEach((status) => {
                options.set(status, STATUS_LABELS[status] || status);
            });
            if (normalized && !options.has(normalized)) {
                options.set(normalized, currentStatus || normalized);
            }
            editStatusSelect.innerHTML = '';
            options.forEach((label, value) => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = label;
                editStatusSelect.appendChild(option);
            });
            const preferred = normalized && options.has(normalized) ? normalized : STATUS_OPTIONS[0];
            editStatusSelect.value = preferred;
        }

        function populateDefaultLanguageOptions(languages, defaultLanguage) {
            if (!editDefaultLanguageSelect) return [];
            const normalized = Array.from(
                new Set(
                    [...(languages || []), defaultLanguage]
                        .filter((language) => typeof language === 'string' && language.trim().length)
                        .map((language) => language.trim()),
                ),
            ).sort((a, b) => a.localeCompare(b));
            editDefaultLanguageSelect.innerHTML = '';
            normalized.forEach((language) => {
                const option = document.createElement('option');
                option.value = language;
                option.textContent = language;
                editDefaultLanguageSelect.appendChild(option);
            });
            if (normalized.length) {
                const preferred = defaultLanguage && normalized.includes(defaultLanguage) ? defaultLanguage : normalized[0];
                editDefaultLanguageSelect.value = preferred;
            }
            return normalized;
        }

        function renderEditTranslations(item, languages) {
            if (!editTranslationsContainer) return;
            editTranslationsContainer.innerHTML = '';
            if (!languages.length) {
                const message = document.createElement('p');
                message.className = 'hint';
                message.textContent = '번역 정보가 없습니다. 최소 1개의 번역을 입력해주세요.';
                editTranslationsContainer.appendChild(message);
                return;
            }
            languages.forEach((language) => {
                const card = document.createElement('div');
                card.className = 'translation-card';
                card.dataset.language = language;

                const heading = document.createElement('h4');
                heading.textContent = language;
                card.appendChild(heading);

                const titleLabel = document.createElement('label');
                const titleSpan = document.createElement('span');
                titleSpan.textContent = '이름';
                const titleInput = document.createElement('input');
                titleInput.type = 'text';
                titleInput.name = `title_${language}`;
                titleInput.required = true;
                titleInput.value = item?.listings?.[language]?.title || '';
                titleLabel.appendChild(titleSpan);
                titleLabel.appendChild(titleInput);
                card.appendChild(titleLabel);

                const descriptionLabel = document.createElement('label');
                const descriptionSpan = document.createElement('span');
                descriptionSpan.textContent = '설명';
                const descriptionTextarea = document.createElement('textarea');
                descriptionTextarea.name = `description_${language}`;
                descriptionTextarea.rows = 3;
                descriptionTextarea.required = true;
                descriptionTextarea.value = item?.listings?.[language]?.description || '';
                descriptionLabel.appendChild(descriptionSpan);
                descriptionLabel.appendChild(descriptionTextarea);
                card.appendChild(descriptionLabel);

                editTranslationsContainer.appendChild(card);
            });
        }

        function cloneRegionalPrices(prices) {
            if (!prices) return undefined;
            const entries = Object.entries(prices);
            if (!entries.length) {
                return undefined;
            }
            const cloned = {};
            entries.forEach(([region, price]) => {
                if (!price) return;
                cloned[region] = {
                    priceMicros: String(price.priceMicros ?? ''),
                    currency: price.currency || '',
                };
            });
            return Object.keys(cloned).length ? cloned : undefined;
        }

        function openEditDialog(item) {
            if (!editForm || !editDialog) return;
            editingItem = item;
            editForm.reset();
            if (editStatusMessage) {
                editStatusMessage.textContent = '';
            }
            const languages = Object.keys(item?.listings || {});
            const normalizedLanguages = populateDefaultLanguageOptions(languages, item?.defaultLanguage);
            populateStatusOptions(item?.status || 'active');
            if (editSkuInput) {
                editSkuInput.value = item?.sku || '';
            }
            if (editPriceMicrosInput) {
                editPriceMicrosInput.value = item?.defaultPrice?.priceMicros || '';
            }
            if (editPriceCurrencyInput) {
                const currency = item?.defaultPrice?.currency || '';
                editPriceCurrencyInput.value = currency ? currency.toUpperCase() : '';
            }
            renderEditTranslations(item, normalizedLanguages);
            ensureDialogOpen();
        }

        async function handleEditSubmit(event) {
            event.preventDefault();
            if (!editForm || !editingItem) return;
            if (!editDefaultLanguageSelect || !editStatusSelect || !editPriceMicrosInput || !editPriceCurrencyInput) return;

            const sku = editingItem.sku;
            const defaultLanguage = editDefaultLanguageSelect.value;
            const statusValue = editStatusSelect.value || 'active';
            const priceMicros = editPriceMicrosInput.value.trim();
            const currency = editPriceCurrencyInput.value.trim().toUpperCase();

            if (!priceMicros) {
                if (editStatusMessage) {
                    editStatusMessage.textContent = '기본 가격 정보를 입력해주세요.';
                }
                return;
            }
            if (!currency) {
                if (editStatusMessage) {
                    editStatusMessage.textContent = '통화 코드를 입력해주세요.';
                }
                return;
            }

            const cards = editTranslationsContainer?.querySelectorAll('.translation-card') || [];
            const listings = {};
            let missingLanguage = null;
            cards.forEach((card) => {
                const language = card.dataset.language;
                if (!language) {
                    return;
                }
                const titleInput = card.querySelector(`input[name="title_${language}"]`);
                const descriptionInput = card.querySelector(`textarea[name="description_${language}"]`);
                const title = titleInput ? titleInput.value.trim() : '';
                const description = descriptionInput ? descriptionInput.value.trim() : '';
                if (!title || !description) {
                    missingLanguage = language;
                }
                listings[language] = { title, description };
            });

            if (missingLanguage) {
                if (editStatusMessage) {
                    editStatusMessage.textContent = `${missingLanguage} 번역은 이름과 설명이 모두 필요합니다.`;
                }
                return;
            }
            if (!listings[defaultLanguage]) {
                if (editStatusMessage) {
                    editStatusMessage.textContent = '기본 언어 번역을 입력해주세요.';
                }
                return;
            }

            const payload = {
                default_language: defaultLanguage,
                status: statusValue,
                default_price: {
                    priceMicros,
                    currency,
                },
                listings,
            };

            const regionalPrices = cloneRegionalPrices(editingItem.prices);
            if (regionalPrices) {
                payload.prices = regionalPrices;
            }

            if (editSubmitBtn) {
                editSubmitBtn.disabled = true;
            }
            if (editCancelBtn) {
                editCancelBtn.disabled = true;
            }
            if (editStatusMessage) {
                editStatusMessage.textContent = '상품을 수정하는 중입니다...';
            }

            let shouldClose = false;
            try {
                const res = await fetch(`/api/inapp/${encodeURIComponent(sku)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((item) => item.msg || item.detail).filter(Boolean).join(', ')
                        : err.detail;
                    throw new Error(detail || '상품 수정에 실패했습니다.');
                }
                await fetchList(currentToken);
                shouldClose = true;
            } catch (error) {
                if (editStatusMessage) {
                    editStatusMessage.textContent = error.message;
                }
            } finally {
                if (editSubmitBtn) {
                    editSubmitBtn.disabled = false;
                }
                if (editCancelBtn) {
                    editCancelBtn.disabled = false;
                }
                if (shouldClose) {
                    closeEditDialog();
                }
            }
        }

        async function handleDelete(item, triggerButton) {
            if (!item?.sku) return;
            const confirmed = window.confirm(`'${item.sku}' 상품을 삭제하시겠습니까?`);
            if (!confirmed) return;
            let previousText = '';
            if (triggerButton) {
                previousText = triggerButton.textContent;
                triggerButton.disabled = true;
                triggerButton.textContent = '삭제 중...';
            }
            try {
                const res = await fetch(`/api/inapp/${encodeURIComponent(item.sku)}`, { method: 'DELETE' });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((entry) => entry.msg || entry.detail).filter(Boolean).join(', ')
                        : err.detail;
                    throw new Error(detail || '상품 삭제에 실패했습니다.');
                }
                await fetchList(currentToken);
            } catch (error) {
                window.alert(error.message);
            } finally {
                if (triggerButton) {
                    triggerButton.disabled = false;
                    triggerButton.textContent = previousText || '삭제';
                }
            }
        }

        function renderImportPreview(data) {
            importPreviewEl.innerHTML = '';
            const operations = data?.operations || [];
            const summary = data?.summary || {};

            if (!operations.length) {
                const message = document.createElement('p');
                message.className = 'hint';
                message.textContent = '변경 사항이 없습니다.';
                importPreviewEl.appendChild(message);
                return;
            }

            const summaryText = document.createElement('p');
            summaryText.className = 'operation-header';
            summaryText.textContent = `생성 ${summary.create || 0}건 · 업데이트 ${summary.update || 0}건 · 삭제 ${summary.delete || 0}건`;
            importPreviewEl.appendChild(summaryText);

            const groups = { create: [], update: [], delete: [] };
            operations.forEach((op) => {
                if (groups[op.action]) {
                    groups[op.action].push(op);
                }
            });

            const actionLabels = {
                create: '생성 예정',
                update: '업데이트 예정',
                delete: '삭제 예정',
            };

            Object.entries(groups).forEach(([action, ops]) => {
                if (!ops.length) return;
                const groupSection = document.createElement('div');
                groupSection.className = 'preview-group';
                const heading = document.createElement('h3');
                heading.textContent = `${actionLabels[action]} (${ops.length})`;
                groupSection.appendChild(heading);
                const list = document.createElement('ul');
                list.className = 'operation-list';

                ops.forEach((op) => {
                    const item = document.createElement('li');
                    item.className = `operation-${action}`;
                    const header = document.createElement('div');
                    header.className = 'operation-header';
                    const strong = document.createElement('strong');
                    strong.textContent = op.sku;
                    header.appendChild(strong);

                    if (action === 'create' && op.data) {
                        const listing = op.data.listings?.[op.data.default_language];
                        const title = listing?.title ? ` - ${listing.title}` : '';
                        const priceText = formatPriceDisplay(op.data.default_price);
                        header.appendChild(document.createTextNode(`${title} (${op.data.status || '-'})`));
                        const priceInfo = document.createElement('div');
                        priceInfo.className = 'operation-details';
                        priceInfo.textContent = `가격: ${priceText}`;
                        item.appendChild(header);
                        item.appendChild(priceInfo);
                        const regionalPrices = buildRegionalPriceList(op.data.prices);
                        if (regionalPrices) {
                            item.appendChild(regionalPrices);
                        }
                    } else if (action === 'update' && op.changes) {
                        const changeEntries = Object.entries(op.changes);
                        header.appendChild(document.createTextNode(` - ${changeEntries.length}개 변경`));
                        item.appendChild(header);
                        const details = document.createElement('div');
                        details.className = 'operation-details';
                        const detailList = document.createElement('ul');

                        changeEntries.forEach(([field, value]) => {
                            const changeItem = document.createElement('li');
                            if (field === 'default_price') {
                                const fromText = formatPriceDisplay(value.from);
                                const toText = formatPriceDisplay(value.to);
                                changeItem.textContent = `가격: ${fromText} → ${toText}`;
                            } else if (field === 'prices') {
                                changeItem.textContent = '지역 가격 변경';
                                const priceList = document.createElement('ul');
                                const regions = new Set([
                                    ...Object.keys(value.from || {}),
                                    ...Object.keys(value.to || {}),
                                ]);
                                Array.from(regions)
                                    .sort((a, b) => a.localeCompare(b))
                                    .forEach((region) => {
                                        const fromPrice = formatPriceDisplay(value.from?.[region]);
                                        const toPrice = formatPriceDisplay(value.to?.[region]);
                                        if (fromPrice === toPrice) {
                                            return;
                                        }
                                        const regionItem = document.createElement('li');
                                        regionItem.textContent = `${region}: ${fromPrice} → ${toPrice}`;
                                        priceList.appendChild(regionItem);
                                    });
                                if (!priceList.childElementCount) {
                                    const sameItem = document.createElement('li');
                                    sameItem.textContent = '변경 없음';
                                    priceList.appendChild(sameItem);
                                }
                                changeItem.appendChild(priceList);
                            } else if (field === 'listings') {
                                changeItem.textContent = '번역 변경';
                                const listingList = document.createElement('ul');
                                Object.entries(value).forEach(([language, diff]) => {
                                    const langItem = document.createElement('li');
                                    const languageLabel = document.createElement('div');
                                    languageLabel.textContent = language;
                                    languageLabel.style.fontWeight = '600';
                                    langItem.appendChild(languageLabel);

                                    const languageDetails = document.createElement('ul');
                                    languageDetails.className = 'translation-change-details';
                                    const fromTitle = diff.from?.title ?? '';
                                    const toTitle = diff.to?.title ?? '';
                                    const titleDetail = document.createElement('li');
                                    if (fromTitle === toTitle) {
                                        titleDetail.textContent = '이름: 변경 없음';
                                    } else {
                                        const fromValue = fromTitle || '-';
                                        const toValue = toTitle || '-';
                                        titleDetail.textContent = `이름: ${fromValue} → ${toValue}`;
                                    }
                                    languageDetails.appendChild(titleDetail);

                                    const fromDescription = diff.from?.description ?? '';
                                    const toDescription = diff.to?.description ?? '';
                                    const descriptionDetail = document.createElement('li');
                                    if (fromDescription === toDescription) {
                                        descriptionDetail.textContent = '설명: 변경 없음';
                                    } else {
                                        const fromValue = fromDescription || '-';
                                        const toValue = toDescription || '-';
                                        descriptionDetail.textContent = `설명: ${fromValue} → ${toValue}`;
                                    }
                                    languageDetails.appendChild(descriptionDetail);

                                    langItem.appendChild(languageDetails);
                                    listingList.appendChild(langItem);
                                });
                                changeItem.appendChild(listingList);
                            } else {
                                const fromValue = value.from ?? '-';
                                const toValue = value.to ?? '-';
                                changeItem.textContent = `${field}: ${fromValue} → ${toValue}`;
                            }
                            detailList.appendChild(changeItem);
                        });
                        details.appendChild(detailList);
                        item.appendChild(details);
                    } else if (action === 'delete' && op.current) {
                        const listing = op.current.listings?.[op.current.default_language];
                        const title = listing?.title ? ` - ${listing.title}` : '';
                        const priceText = formatPriceDisplay(op.current.default_price);
                        header.appendChild(document.createTextNode(title));
                        item.appendChild(header);
                        const info = document.createElement('div');
                        info.className = 'operation-details';
                        info.textContent = `가격: ${priceText}`;
                        item.appendChild(info);
                        const regionalPrices = buildRegionalPriceList(op.current.prices);
                        if (regionalPrices) {
                            item.appendChild(regionalPrices);
                        }
                    } else {
                        item.appendChild(header);
                    }

                    list.appendChild(item);
                });

                groupSection.appendChild(list);
                importPreviewEl.appendChild(groupSection);
            });
        }

        async function handleExportCsv() {
            importStatusEl.textContent = '';
            exportBtn.disabled = true;
            try {
                const res = await fetch('/api/inapp/export');
                if (!res.ok) {
                    throw new Error('CSV 내보내기에 실패했습니다.');
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const anchor = document.createElement('a');
                anchor.href = url;
                const timestamp = new Date().toISOString().replace(/[:T]/g, '').slice(0, 14);
                anchor.download = `iap-products-${timestamp}.csv`;
                document.body.appendChild(anchor);
                anchor.click();
                anchor.remove();
                URL.revokeObjectURL(url);
                importStatusEl.textContent = 'CSV 파일을 다운로드했습니다.';
            } catch (error) {
                importStatusEl.textContent = error.message;
            } finally {
                exportBtn.disabled = false;
            }
        }

        async function handleImportPreview() {
            if (!importFileInput.files?.length) {
                importStatusEl.textContent = 'CSV 파일을 선택해주세요.';
                return;
            }
            importStatusEl.textContent = '변경 사항을 확인 중입니다';
            importPreviewBtn.disabled = true;
            importApplyBtn.disabled = true;
            if (importPreviewEl) {
                importPreviewEl.innerHTML = '';
            }
            startImportPreviewProgress();
            const formData = new FormData();
            formData.append('file', importFileInput.files[0]);
            let previewSucceeded = false;
            try {
                const res = await fetch('/api/inapp/import/preview', {
                    method: 'POST',
                    body: formData,
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((item) => item.msg || item.detail).filter(Boolean).join(', ')
                        : err.detail;
                    throw new Error(detail || '미리보기에 실패했습니다.');
                }
                const data = await res.json();
                pendingOperations = data.operations || [];
                previewSucceeded = true;
                renderImportPreview(data);
                if (pendingOperations.length) {
                    importStatusEl.textContent = '변경 사항을 확인한 뒤 적용 버튼을 눌러주세요.';
                    importApplyBtn.disabled = false;
                } else {
                    importStatusEl.textContent = '적용할 변경 사항이 없습니다.';
                }
            } catch (error) {
                importPreviewEl.innerHTML = '';
                pendingOperations = [];
                importStatusEl.textContent = error.message;
            } finally {
                importPreviewBtn.disabled = false;
                completeImportPreviewProgress({
                    message: previewSucceeded
                        ? '변경 사항 확인 완료'
                        : '변경 사항을 확인하는 중 오류가 발생했습니다.',
                    isError: !previewSucceeded,
                });
            }
        }

        async function handleImportApply() {
            if (!pendingOperations.length) {
                importStatusEl.textContent = '적용할 변경 사항이 없습니다.';
                return;
            }
            importStatusEl.textContent = '변경 사항을 적용하는 중입니다...';
            importApplyBtn.disabled = true;
            importPreviewBtn.disabled = true;
            try {
                const operationsPayload = pendingOperations.map((op) => {
                    const base = { action: op.action, sku: op.sku };
                    if (op.data) {
                        base.data = JSON.parse(JSON.stringify(op.data));
                    }
                    return base;
                });
                const res = await fetch('/api/inapp/import/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ operations: operationsPayload }),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail)
                        ? err.detail.map((item) => item.msg || item.detail).filter(Boolean).join(', ')
                        : err.detail;
                    throw new Error(detail || '변경 사항 적용에 실패했습니다.');
                }
                importStatusEl.textContent = '변경 사항이 적용되었습니다.';
                pendingOperations = [];
                renderImportPreview({ operations: [], summary: { create: 0, update: 0, delete: 0 } });
                importFileInput.value = '';
                fetchList();
            } catch (error) {
                importStatusEl.textContent = error.message;
                if (pendingOperations.length) {
                    importApplyBtn.disabled = false;
                }
            } finally {
                importPreviewBtn.disabled = false;
            }
        }

        function handlePageSizeChange() {
            if (!pageSizeSelect) return;
            const parsed = Number(pageSizeSelect.value);
            if (!Number.isFinite(parsed) || parsed <= 0) {
                pageSizeSelect.value = String(pageSize);
                return;
            }
            const normalized = Math.min(Math.max(Math.floor(parsed), 1), MAX_PAGE_SIZE);
            if (normalized !== parsed) {
                pageSizeSelect.value = String(normalized);
            }
            if (normalized === pageSize) {
                return;
            }
            pageSize = normalized;
            tokenStack.length = 0;
            currentToken = undefined;
            nextToken = undefined;
            if (prevBtn) {
                prevBtn.disabled = true;
            }
            if (nextBtn) {
                nextBtn.disabled = true;
            }
            fetchList();
        }

        if (exportBtn) {
            exportBtn.addEventListener('click', handleExportCsv);
        }
        if (importPreviewBtn) {
            importPreviewBtn.addEventListener('click', handleImportPreview);
        }
        if (importApplyBtn) {
            importApplyBtn.addEventListener('click', handleImportApply);
        }
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', handlePageSizeChange);
        }

        if (editCancelBtn) {
            editCancelBtn.addEventListener('click', () => {
                closeEditDialog();
            });
        }
        if (editDialog) {
            editDialog.addEventListener('cancel', (event) => {
                event.preventDefault();
                closeEditDialog();
            });
        }
        if (editForm) {
            editForm.addEventListener('submit', handleEditSubmit);
        }

        function renderTemplateDetails(template, message) {
            if (message) {
                templateDescription.textContent = message;
            } else if (template) {
                const defaultInfo = `${template.default_price} ${template.default_currency}`.trim();
                templateDescription.textContent = template.description || `기본 가격: ${defaultInfo}`;
            } else {
                templateDescription.textContent = '가격 템플릿을 선택하면 지역별 가격이 표시됩니다.';
            }

            if (template && Array.isArray(template.regions) && template.regions.length) {
                templateDetails.hidden = false;
                templateRegionList.innerHTML = '';
                template.regions.forEach((region) => {
                    const li = document.createElement('li');
                    let priceText = region.price ? `${region.price} ${region.currency}` : '';
                    if (!priceText && region.priceMicros) {
                        const amount = Number(region.priceMicros) / 1_000_000;
                        priceText = `${amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 6 })} ${region.currency || ''}`.trim();
                    }
                    li.textContent = `${region.region}: ${priceText}`.trim();
                    templateRegionList.appendChild(li);
                });
            } else {
                templateDetails.hidden = true;
                templateRegionList.innerHTML = '';
            }
        }

        async function fetchTemplates(options = {}) {
            const showProgress = Boolean(options.showProgress) && initialLoadingActive;
            let success = false;
            let errorMessage = '';
            submitBtn.disabled = true;
            if (showProgress) {
                setInitialProgressMessage('가격 템플릿을 불러오는 중...');
            }
            try {
                const res = await fetch('/api/pricing/templates');
                if (!res.ok) {
                    throw new Error('가격 템플릿을 불러오지 못했습니다.');
                }
                const data = await res.json();
                const templates = data.templates || [];
                templateMap.clear();
                templateSelect.innerHTML = '<option value="">가격 템플릿을 선택하세요</option>';
                if (!templates.length) {
                    templateSelect.innerHTML = '<option value="">등록된 템플릿이 없습니다</option>';
                    templateSelect.disabled = true;
                    submitBtn.disabled = true;
                    renderTemplateDetails(
                        null,
                        '등록된 상품에서 KRW 가격 템플릿을 찾을 수 없습니다. 기존 상품의 가격 구성을 확인해주세요.',
                    );
                    return;
                }
                templates.forEach((tpl) => {
                    templateMap.set(tpl.id, tpl);
                    const option = document.createElement('option');
                    option.value = tpl.id;
                    option.textContent = tpl.label;
                    templateSelect.appendChild(option);
                });
                templateSelect.disabled = false;
                submitBtn.disabled = false;
                renderTemplateDetails(null);
                success = true;
            } catch (error) {
                errorMessage = error.message;
                templateSelect.innerHTML = '<option value="">템플릿 로딩 실패</option>';
                templateSelect.disabled = true;
                submitBtn.disabled = true;
                renderTemplateDetails(null, error.message);
            } finally {
                if (showProgress) {
                    finishInitialStep({ success, message: errorMessage || '가격 템플릿을 불러오지 못했습니다.' });
                }
            }
            return success;
        }

        async function fetchList(token, options = {}) {
            const showProgress = Boolean(options.showProgress) && initialLoadingActive;
            let success = false;
            let errorMessage = '';
            const activeToken = typeof token === 'string' && token.length ? token : undefined;
            currentToken = activeToken;
            nextToken = undefined;
            if (showProgress) {
                setInitialProgressMessage('등록된 상품을 불러오는 중...');
            }
            try {
                const params = new URLSearchParams();
                if (activeToken) {
                    params.set('token', activeToken);
                }
                if (options.refresh) {
                    params.set('refresh', 'true');
                }
                if (pageSize && Number.isFinite(pageSize) && pageSize > 0) {
                    params.set('page_size', String(pageSize));
                }
                const query = params.toString();
                const res = await fetch(`/api/inapp/list${query ? `?${query}` : ''}`);
                if (!res.ok) {
                    throw new Error('목록을 불러오지 못했습니다.');
                }
                const data = await res.json();
                renderList(data.items || []);
                nextToken = data.nextPageToken || undefined;
                nextBtn.disabled = !nextToken;
                prevBtn.disabled = tokenStack.length === 0;
                success = true;
            } catch (error) {
                errorMessage = error.message;
                if (listEl) {
                    listEl.innerHTML = '';
                }
                if (tableWrapper) {
                    tableWrapper.hidden = true;
                }
                if (emptyEl) {
                    emptyEl.hidden = false;
                    emptyEl.textContent = error.message;
                }
                nextBtn.disabled = true;
                prevBtn.disabled = tokenStack.length === 0;
            } finally {
                if (showProgress) {
                    finishInitialStep({ success, message: errorMessage || '상품 목록을 불러오지 못했습니다.' });
                }
            }
            return success;
        }

        function renderList(items) {
            if (!listEl) {
                return;
            }
            listEl.innerHTML = '';
            if (!items.length) {
                if (tableWrapper) {
                    tableWrapper.hidden = true;
                }
                if (emptyEl) {
                    emptyEl.hidden = false;
                    emptyEl.textContent = '등록된 상품이 없습니다.';
                }
                return;
            }

            if (tableWrapper) {
                tableWrapper.hidden = false;
            }
            if (emptyEl) {
                emptyEl.hidden = true;
            }

            items.forEach((item) => {
                const row = document.createElement('tr');

                const skuCell = document.createElement('td');
                skuCell.textContent = item.sku || '-';
                row.appendChild(skuCell);

                const defaultListing = (item.listings && item.defaultLanguage && item.listings[item.defaultLanguage])
                    || (item.listings ? Object.values(item.listings)[0] : undefined);
                const titleCell = document.createElement('td');
                titleCell.textContent = (defaultListing && defaultListing.title) || item.sku || '-';
                row.appendChild(titleCell);

                const descriptionCell = document.createElement('td');
                descriptionCell.className = 'description-cell';
                descriptionCell.textContent = (defaultListing && defaultListing.description) || '-';
                row.appendChild(descriptionCell);

                const languageCell = document.createElement('td');
                languageCell.textContent = item.defaultLanguage || '-';
                row.appendChild(languageCell);

                const priceCell = document.createElement('td');
                priceCell.textContent = formatPriceDisplay(item.defaultPrice) || 'N/A';
                row.appendChild(priceCell);

                const statusCell = document.createElement('td');
                const statusKey = (item.status || '').toLowerCase();
                statusCell.textContent = STATUS_LABELS[statusKey] || item.status || '-';
                row.appendChild(statusCell);

                const actionsCell = document.createElement('td');
                const actionsWrapper = document.createElement('div');
                actionsWrapper.className = 'table-actions';

                const editButton = document.createElement('button');
                editButton.type = 'button';
                editButton.textContent = '수정';
                editButton.classList.add('button-secondary');
                editButton.addEventListener('click', () => openEditDialog(item));
                actionsWrapper.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.textContent = '삭제';
                deleteButton.classList.add('button-danger');
                deleteButton.addEventListener('click', () => handleDelete(item, deleteButton));
                actionsWrapper.appendChild(deleteButton);

                actionsCell.appendChild(actionsWrapper);
                row.appendChild(actionsCell);

                listEl.appendChild(row);
            });
        }

        nextBtn.addEventListener('click', () => {
            if (!nextToken) return;
            tokenStack.push(currentToken || null);
            currentToken = nextToken;
            fetchList(currentToken);
        });

        prevBtn.addEventListener('click', () => {
            if (!tokenStack.length) return;
            const prev = tokenStack.pop();
            currentToken = prev || undefined;
            fetchList(currentToken);
        });

        templateSelect.addEventListener('change', () => {
            const template = templateMap.get(templateSelect.value);
            renderTemplateDetails(template);
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(form);
            statusEl.textContent = '';
            const sku = (formData.get('sku') || '').trim();
            const defaultLanguage = formData.get('default_language');
            const selectedTemplateId = (formData.get('price_template_id') || '').trim();

            if (!sku) {
                statusEl.textContent = '상품 ID를 입력해주세요.';
                return;
            }

            const translations = [];
            for (const language of translationLanguages) {
                const title = (formData.get(`title_${language}`) || '').trim();
                const description = (formData.get(`description_${language}`) || '').trim();
                if (!title && !description) {
                    continue;
                }
                if (!title || !description) {
                    statusEl.textContent = `${language} 번역은 이름과 설명을 모두 입력해야 합니다.`;
                    return;
                }
                translations.push({ language, title, description });
            }

            if (!translations.some((item) => item.language === defaultLanguage)) {
                statusEl.textContent = '기본 언어와 일치하는 번역을 입력해주세요.';
                return;
            }

            const payload = {
                sku,
                default_language: defaultLanguage,
                translations,
            };

            if (!selectedTemplateId) {
                statusEl.textContent = '가격 템플릿을 선택해주세요.';
                return;
            }
            if (!templateMap.has(selectedTemplateId)) {
                statusEl.textContent = '선택한 가격 템플릿 정보를 찾을 수 없습니다.';
                return;
            }
            payload.price_template_id = selectedTemplateId;

            statusEl.textContent = '상품을 생성 중입니다...';
            try {
                const res = await fetch('/api/inapp/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    let message = err.detail;
                    if (Array.isArray(message)) {
                        message = message.map((item) => item.msg || item.detail).filter(Boolean).join(', ');
                    }
                    throw new Error(message || '생성에 실패했습니다.');
                }
                statusEl.textContent = '상품이 성공적으로 생성되었습니다.';
                form.reset();
                templateSelect.value = '';
                renderTemplateDetails(null);
                tokenStack.length = 0;
                currentToken = undefined;
                fetchList();
            } catch (error) {
                statusEl.textContent = error.message;
            }
        });

        async function initializeApp() {
            startInitialLoading(2);
            await fetchTemplates({ showProgress: true });
            await fetchList(undefined, { showProgress: true });
        }

        renderImportPreview({ operations: [], summary: { create: 0, update: 0, delete: 0 } });
        renderTemplateDetails(null);
        initializeApp();
    </script>
</body>
</html>
